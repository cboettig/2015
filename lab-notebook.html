<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: http://purl.org/dc/terms/ og: http://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Lab Notebook</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Lab Notebook" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/lab-notebook.html" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Lab Notebook" />
<meta property="og:author" content="http://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="http://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="http://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="http://ogp.me/ns/article#published_time" content="" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="http://www.carlboettiger.info/lab-notebook.html" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content=""/>
<meta name="citation_title" content="Lab Notebook"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/academicons.css" />
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="http://www.carlboettiger.info/blog.xml" />
</head>


  <body prefix="dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  class="active" >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="http://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Lab Notebook</h1>
        <h2>(<a href="http://www.carlboettiger.info/2012/09/28/Welcome-to-my-lab-notebook.html">Introduction</a>)</h2>
      </header>

      <div class="row postpreview">
  <div class="col-md-11 col-md-offset-1">
    <div class="row">
			<h4> <a href="/2015/atom.xml"
              onClick="recordOutboundLink(this,
              'Outbound Links', 'RSS'); return false;"
              style="color: inherit;"
              ><i class="icon-rss" ></i> Entries</a></h4>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/30/gpdp-via-mdptoolbox-cont.html">Gpdp Via Mdptoolbox Cont</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 30 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#knitr::opts_chunk$set(eval=FALSE)</span>
<span class="co">#devtools::install_github(&quot;cboettig/gpmanagement@b3b765cbceb51c9b0b8cb2724e395353ec365df9&quot;)</span>
<span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;gpmanagement&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre>
<h3 id="true-model">True model</h3>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">50</span>)
f &lt;-<span class="st"> </span>function (x, h){
  <span class="kw">sapply</span>(x, function(x) {
    x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
    x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
  })
}

sigma_g &lt;-<span class="st"> </span><span class="fl">0.1</span>
pdfn &lt;-<span class="st"> </span>function(x, mu, <span class="dt">sigma =</span> sigma_g){
  <span class="kw">dlnorm</span>(x, <span class="kw">log</span>(mu), <span class="dt">sdlog =</span> sigma)
}

z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_g)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">set.seed</span>(<span class="dv">0</span>)
  Tobs &lt;-<span class="st"> </span><span class="dv">40</span>


  x &lt;-<span class="st"> </span><span class="kw">numeric</span>(Tobs)
  x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">60</span>
  for(t in <span class="dv">1</span>:(Tobs<span class="dv">-1</span>))
    x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">h=</span><span class="dv">0</span>)
  obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          <span class="kw">pmax</span>(<span class="kw">rep</span>(<span class="dv">0</span>,Tobs<span class="dv">-1</span>), x[<span class="dv">1</span>:(Tobs<span class="dv">-1</span>)])), 
                    <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          x[<span class="dv">2</span>:Tobs]))
  xObs &lt;-<span class="st"> </span>obs$x
  yObs &lt;-<span class="st"> </span>obs$y
  xPred &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">1.1</span> *<span class="st"> </span><span class="kw">max</span>(xObs), <span class="dt">length =</span> <span class="dv">50</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(<span class="kw">seq_along</span>(x), x) +<span class="st"> </span><span class="kw">geom_line</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-4-1.png" />
</figure>
<hr />
<p>Now the GP estimation from NIMBLE. Let’s emphasize shorter length-scales with the prior to compare:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># having this work with output from `nimbleCode` might be more natural than `expression`</span>
priors &lt;-<span class="st"> </span><span class="kw">expression</span>({
  rho ~<span class="st"> </span><span class="kw">dgamma</span>(<span class="dv">1</span>, <span class="dv">1</span>)
  sigGP ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
  sigOE ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
})</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">gp_setup</span>(xObs, yObs, xPred)</code></pre>
<pre><code>[1] RW_block sampler: rho, sigGP, sigOE,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 200,  scale: 1,  propCov: identity</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">Cmcmc &lt;-<span class="st"> </span>fit$Cmcmc 
Cpred &lt;-<span class="st"> </span>fit$Cpred
Cmodel &lt;-<span class="st"> </span>fit$Cmodel</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
 16.604   0.008  16.600 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(Cmcmc$mvSamples)
  ## basic sanity check
  testthat::<span class="kw">expect_identical</span>(Cmodel$<span class="kw">getNodeNames</span>(<span class="dt">topOnly =</span> <span class="ot">TRUE</span>), <span class="kw">colnames</span>(samples))</code></pre>
<p>predict from GP model using posterior MCMC samples</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
 22.036   0.000  22.021 </code></pre>
<p>Posteriors</p>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))</code></pre>
<pre><code>Error: Sextptr is not a valid external pointer</code></pre>
<pre><code>Error in matrix(0.1, nrow = nrows, ncol = length(flatNames)): non-numeric matrix extent</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>tidyr::<span class="kw">gather</span>(samples)</code></pre>
<pre><code>Error in UseMethod(&quot;gather_&quot;): no applicable method for &#39;gather_&#39; applied to an object of class &quot;c(&#39;matrix&#39;, &#39;double&#39;, &#39;numeric&#39;)&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<pre><code>Error: ggplot2 doesn&#39;t know how to deal with data of class function</code></pre>
<p>extract predictions: E and C</p>
<pre class="sourceCode r"><code class="sourceCode r">  E &lt;-<span class="st"> </span>Cpred$<span class="kw">getE</span>()</code></pre>
<pre><code>Error in eval(expr, envir, enclos): attempt to apply non-function</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  C &lt;-<span class="st"> </span>Cpred$<span class="kw">getC</span>()</code></pre>
<pre><code>Error in eval(expr, envir, enclos): attempt to apply non-function</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xObs, <span class="dt">y =</span> yObs)
pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">y =</span> E, <span class="dt">ymin =</span> E -<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)), <span class="dt">ymax =</span> E +<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)))</code></pre>
<pre><code>Error in data.frame(x = xPred, y = E, ymin = E - sqrt(diag(C)), ymax = E + : object &#39;E&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">ggplot2::<span class="kw">ggplot</span>(pred) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x,<span class="dt">y =</span> y, <span class="dt">ymin =</span> ymin, <span class="dt">ymax =</span> ymax), <span class="dt">fill =</span> <span class="st">&quot;grey80&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">size=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> obs, <span class="kw">aes</span>(x,y)) +
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(<span class="kw">c</span>(xObs, xPred)), <span class="dt">ylim =</span> <span class="kw">range</span>(<span class="kw">c</span>(yObs,E))) +
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre>
<pre><code>Error in ggplot2::ggplot(pred): object &#39;pred&#39; not found</code></pre>
<hr />
<h2 id="decision-theory">Decision theory</h2>
<pre class="sourceCode r"><code class="sourceCode r">states &lt;-<span class="st"> </span>xPred <span class="co"># Vector of all possible states</span>
actions &lt;-<span class="st"> </span>states <span class="co"># Vector of actions: harvest</span></code></pre>
<p>Let’s consider a slight variation of the most trivial utility function: one which explicitly adds a cost to completely exhausting the stock (or reducing the stock by more than, say 95% in this case.) This should be somewhat similar to the impact of no discount rate.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
discount =<span class="st"> </span><span class="fl">0.99</span>

<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span>

R &lt;-<span class="st"> </span><span class="kw">sapply</span>(actions, function(h){
      <span class="kw">sapply</span>(states, function(x){
  if(h &lt;<span class="st"> </span>x)
    h
  else 
     -<span class="st"> </span><span class="dv">1</span> *<span class="st"> </span><span class="kw">max</span>(states)
  })
})</code></pre>
<p>Implementing policy</p>
<pre class="sourceCode r"><code class="sourceCode r">z &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dt">meanlog =</span> <span class="dv">0</span>, <span class="dt">sdlog =</span> sigma_g)

simulate_policy &lt;-<span class="st"> </span>function(states, actions, policy, f, z, s0, <span class="dt">steps =</span> <span class="dv">50</span>, <span class="dt">utility =</span> function(s,a) <span class="ot">NA</span>, <span class="dt">discount =</span> <span class="dv">1</span>){
  s &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  a &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  u &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  s[<span class="dv">1</span>] &lt;-<span class="st"> </span>s0
  for(t in <span class="dv">1</span>:(steps<span class="dv">-1</span>)){
    
    a[t] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]
    s[t<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">z</span>() *<span class="st"> </span><span class="kw">f</span>(s[t], a[t])
    u[t] &lt;-<span class="st"> </span><span class="kw">utility</span>(s[t], a[t]) *<span class="st"> </span>discount ^<span class="st"> </span>t
  }
  
  <span class="co"># Final action determined but not implemented</span>
  a[steps] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]

  <span class="kw">data.frame</span>(<span class="dt">time =</span> <span class="dv">1</span>:steps, <span class="dt">state =</span> s, <span class="dt">action =</span> a, <span class="dt">utility =</span> u)
}</code></pre>
<h3 id="gp-model">GP model</h3>
<pre class="sourceCode r"><code class="sourceCode r">gp_matrix &lt;-<span class="st"> </span>function(states, actions, E, C){
  
  transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(actions)))
  K &lt;-<span class="st"> </span><span class="kw">length</span>(states)
  sigmas &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C))
  
  for (k in <span class="dv">1</span>:<span class="kw">length</span>(states)) {
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(actions)) {
      nextpop &lt;-<span class="st"> </span>E[k] -<span class="st"> </span>actions[i]
      if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>) {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, K -<span class="st"> </span><span class="dv">1</span>))
      } else {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">dnorm</span>(states, nextpop, sigmas[i]) /<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dnorm</span>(states, nextpop, sigmas[i]))
      }
    }
  }
  transition
}

P_gp &lt;-<span class="st"> </span><span class="kw">gp_matrix</span>(states, actions, E, C)</code></pre>
<pre><code>Error in as.integer(x): cannot coerce type &#39;closure&#39; to vector of type &#39;integer&#39;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P_gp, <span class="dt">R =</span> R)</code></pre>
<pre><code>Error in mdp_check(P = P_gp, R = R): object &#39;P_gp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P_gp, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.00001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>Error in mdp_value_iteration(P_gp, R, discount = discount, epsilon = 1e-05, : object &#39;P_gp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[gp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<pre><code>Error in xy.coords(x, y, xlabel, ylabel, log): object &#39;gp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims </code></pre>
<pre><code>Error: object &#39;gp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>Error in mean(sims$utility): error in evaluating the argument &#39;x&#39; in selecting a method for function &#39;mean&#39;: Error: object &#39;sims&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<pre><code>Error in ggplot(sims): object &#39;sims&#39; not found</code></pre>
<p>With this amount of data, the gp solution is too cautious, and avoids any exploitation.</p>
<h4 id="simulate-under-the-true-model">Simulate under the true model</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states, actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims </code></pre>
<pre><code>Error: object &#39;gp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>Error in mean(sims$utility): error in evaluating the argument &#39;x&#39; in selecting a method for function &#39;mean&#39;: Error: object &#39;sims&#39; not found</code></pre>
<p>(Average utility is approximate here since it does not include penalty; since a function and not a matrix is requred by this function at this time.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<pre><code>Error in ggplot(sims): object &#39;sims&#39; not found</code></pre>
<hr />
<pre class="sourceCode r"><code class="sourceCode r">P &lt;-<span class="st"> </span><span class="kw">transition_matrix</span>(states, actions, f, pdfn)
<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mdp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[mdp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-25-1.png" />
</figure>
<p>Note that the altered award structure has almost no effect on the optimal policy given the true model, other than to avoid harvesting directly to zero even when the stock cannot persist, due to the explicit penalty for doing so.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, mdp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 9.38167</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-27-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/30/gpdp-via-mdptoolbox-cont.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/29/mdptoolbox-allen-model.html">Mdptoolbox Allen Model</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 29 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">K &lt;-<span class="st"> </span><span class="dv">150</span> <span class="co"># state space limit</span>
states &lt;-<span class="st"> </span><span class="dv">0</span>:K <span class="co"># Vector of all possible states</span>
actions &lt;-<span class="st"> </span>states <span class="co"># Vector of actions: harvest</span>


sigma_g =<span class="st"> </span><span class="fl">0.1</span>
p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">50</span>)

f &lt;-<span class="st"> </span>function (x, h){
  <span class="kw">sapply</span>(x, function(x) {
    x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
    x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
  })
}

pdfn &lt;-<span class="st"> </span>function(x, mu, <span class="dt">sigma =</span> sigma_g){
  <span class="kw">dlnorm</span>(x, <span class="kw">log</span>(mu), <span class="dt">sdlog =</span> sigma)
}

<span class="co"># Utility function</span>
discount =<span class="st"> </span><span class="fl">0.95</span>
get_utility &lt;-<span class="st"> </span>function(x,h) {
    <span class="kw">pmin</span>(x,h)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">R &lt;-<span class="st"> </span><span class="kw">outer</span>(states, actions, get_utility)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">transition_matrix &lt;-<span class="st"> </span>function(states, actions, f, pdfn){
  <span class="co"># Initialize</span>
  transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(actions)))
  
  K &lt;-<span class="st"> </span><span class="kw">length</span>(states)
  
  for (k in <span class="dv">1</span>:<span class="kw">length</span>(states)) {
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(actions)) {
  
  <span class="co"># Calculate the transition state at the next step, given the </span>
  <span class="co"># current state k and action i (harvest H[i])</span>
        nextpop &lt;-<span class="st"> </span><span class="kw">f</span>(states[k], actions[i])
        
        ## Population always extinct if this is negative. since multiplicitive shock z_t * f(n) &lt; 0 for all f(n) &lt; 0
        if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>)
          transition[k, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(states) -<span class="st"> </span><span class="dv">1</span>))
    <span class="co"># Implement demographic stochasticity </span>
        else {
  
        <span class="co"># Cts distributions need long-tailed denominator as normalizing factor:</span>
          fine_states &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(states), <span class="dv">10</span> *<span class="st"> </span><span class="kw">max</span>(states), <span class="dt">by =</span> states[<span class="dv">2</span>] -<span class="st"> </span>states[<span class="dv">1</span>])
        N &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">pdfn</span>(fine_states, nextpop))  
          transition[k, , i] &lt;-<span class="kw">pdfn</span>(states, nextpop) /<span class="st"> </span>N
          
            <span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;) (discrete or cts case)</span>
          <span class="co"># this can be a tiny but negative value due to floating-point errors. so we take max(v,0) to avoid</span>
        transition[k, K, i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(transition[k, -K, i]), <span class="dv">0</span>)
        }
    } 
  }
  transition
}

P &lt;-<span class="st"> </span><span class="kw">transition_matrix</span>(states, actions, f, pdfn)</code></pre>
<h2 id="using-toolbox">Using toolbox</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mdp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[mdp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-mdptoolbox-allen-model/unnamed-chunk-6-1.png" />
</figure>
<h2 id="compare-to-reed">Compare to Reed</h2>
<p>From Reed (1979) we know that the optimal solution is a constant-escapement rule when the growth function in convex. Note that this condition is violated by the growth function with alternative stable states (Allen/Ricker-Allee model), resulting in a very different optimal policy:</p>
<p><span class="math">\[f&#39;(s^*) = 1/\alpha\]</span></p>
<p>For growth-rate function <span class="math">\(f\)</span>, where <span class="math">\(\alpha\)</span> is the discount factor and <span class="math">\(s^*\)</span> the stock size for the constant escapement. Analytic solutions are clearly possible for certain growth functions, but here I’ve just implemented a generic numerical solution.</p>
<pre class="sourceCode r"><code class="sourceCode r">fun &lt;-<span class="st"> </span>function(x) -<span class="st"> </span><span class="kw">f</span>(x,<span class="dv">0</span>) +<span class="st"> </span>x /<span class="st"> </span>discount
out &lt;-<span class="st"> </span><span class="kw">optimize</span>(<span class="dt">f =</span> fun, <span class="dt">interval =</span> <span class="kw">c</span>(<span class="dv">0</span>,K))
S_star &lt;-<span class="st"> </span>out$minimum

exact_policy &lt;-<span class="st"> </span><span class="kw">sapply</span>(states, 
                       function(x) 
                        if(x &lt;<span class="st"> </span>S_star) <span class="dv">0</span>
                        else x -<span class="st"> </span>S_star)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[mdp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)

<span class="co"># The difference between Bellman and the analytical solution is small:</span>
<span class="kw">lines</span>(states, states -<span class="st"> </span>exact_policy)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-mdptoolbox-allen-model/unnamed-chunk-8-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/29/mdptoolbox-allen-model.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/29/fastgp-explore.html">Fastgp Explore</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 29 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(FastGP)
<span class="kw">library</span>(mvtnorm)
<span class="kw">library</span>(MASS)
<span class="kw">library</span>(rbenchmark)</code></pre>
<h2 id="demo-of-elliptical-slice-sampling">Demo of elliptical slice sampling</h2>
<p>Relevant Parameters:</p>
<pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">#amplitude of the sin function used for our signal</span>
T &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co">#period of the sin function used as our signal</span>
sigma &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co">#variance parameter in the covariance function</span>
phi &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co">#decay parameter for the exponential kernel</span>
N &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co">#number of time points </span></code></pre>
<p>A function that creates a signal, which can be toggled for multiple shapes. In the present iteration we use a sin function with variable period.</p>
<pre class="sourceCode r"><code class="sourceCode r">signal &lt;-<span class="st"> </span>function(t) {
  <span class="kw">return</span>(A*<span class="kw">sin</span>(t/T))
}</code></pre>
<p>Define our covariance matrix using the exponential kernel</p>
<pre class="sourceCode r"><code class="sourceCode r">S &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(sigma*<span class="kw">exp</span>(-<span class="kw">as.matrix</span>(<span class="kw">dist</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N)))^<span class="dv">2</span>/phi))</code></pre>
<p>Generate a copy of the signal on the time scale of 1…N</p>
<pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">100</span>), <span class="dt">Sigma =</span> S , <span class="dt">tol =</span> <span class="fl">1e-6</span>)
s &lt;-<span class="st"> </span><span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N)+t)+<span class="kw">rnorm</span>(N,<span class="dt">sd=</span><span class="kw">sqrt</span>(.<span class="dv">001</span>))</code></pre>
<p>log-lik functions</p>
<pre class="sourceCode r"><code class="sourceCode r">log_lik &lt;-<span class="st"> </span>function(w,s){
  <span class="kw">return</span> (<span class="kw">dmvnorm</span>(s, <span class="dt">mean =</span> <span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>:N)+w),<span class="dt">sigma=</span>.<span class="dv">001</span>*<span class="kw">diag</span>(<span class="dv">1</span>,N),<span class="dt">log=</span>T))
}

<span class="co">#rcpp based log-lik function</span>
log_lik_rcpp &lt;-<span class="st"> </span>function(w,s){
  <span class="kw">return</span> (<span class="kw">rcpp_log_dmvnorm</span>(<span class="dt">S =</span> .<span class="dv">001</span>*<span class="kw">diag</span>(<span class="dv">1</span>,N),<span class="dt">mu=</span><span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>:N)+w),s,<span class="dt">istoep=</span><span class="ot">TRUE</span>))
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N),<span class="dt">nrow=</span>N)
Sig &lt;-<span class="st"> </span>sigma*<span class="kw">exp</span>(-<span class="kw">rcpp_distance</span>(X,<span class="kw">dim</span>(X)[<span class="dv">1</span>],<span class="kw">dim</span>(X)[<span class="dv">2</span>])^<span class="dv">2</span>/phi)</code></pre>
<p>and here we go:</p>
<pre class="sourceCode r"><code class="sourceCode r">mcmc_samples &lt;-<span class="st"> </span><span class="kw">ess</span>(log_lik_rcpp,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">TRUE</span>)</code></pre>
<pre><code>[1] &quot;Running elliptical slice sampling...&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">plot</span>(<span class="kw">colMeans</span>(mcmc_samples), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>)
<span class="kw">points</span>(t, <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
<span class="kw">points</span>(<span class="kw">colMeans</span>(mcmc_samples) +<span class="st"> </span><span class="dv">2</span>*<span class="st"> </span><span class="kw">apply</span>(mcmc_samples, <span class="dv">2</span>, sd), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>)
<span class="kw">points</span>(<span class="kw">colMeans</span>(mcmc_samples) -<span class="st"> </span><span class="dv">2</span>*<span class="st"> </span><span class="kw">apply</span>(mcmc_samples, <span class="dv">2</span>, sd), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-fastgp-explore/unnamed-chunk-9-1.png" />
</figure>
<p>test <code>ess</code> with rcpp likelihood versus non rcpp likelihood</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">benchmark</span>(<span class="kw">ess</span>(log_lik_rcpp,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">FALSE</span>), <span class="kw">ess</span>(log_lik,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">TRUE</span>),<span class="dt">replications=</span><span class="dv">2</span>)</code></pre>
<pre><code>[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;</code></pre>
<pre><code>                                              test replications
1 ess(log_lik_rcpp, s, Sig, 1000, 250, 100, FALSE)            2
2       ess(log_lik, s, Sig, 1000, 250, 100, TRUE)            2
  elapsed relative user.self sys.self user.child sys.child
1  19.480    1.000    19.592    0.636          0         0
2  33.818    1.736    46.504   87.208          0         0</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/29/fastgp-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/14/mdptoolbox-ex-2.html">Mdptoolbox Ex 2</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 14 Jul 2015</p>

<article>
<div class="excerpt">
<p>Adapted from Marescot et al. appendix 5, to Reed optimal control problem, including direct comparison against (semi) analytic optimum.</p>
<h2 id="step-1-define-objectives">step 1: define objectives</h2>
<p>This is a conceptual step which does not require coding</p>
<h2 id="step-2-define-states">step 2: define states</h2>
<pre class="sourceCode r"><code class="sourceCode r">K &lt;-<span class="st"> </span><span class="dv">150</span> <span class="co"># state space limit</span>
states &lt;-<span class="st"> </span><span class="dv">0</span>:K <span class="co"># Vector of all possible states</span></code></pre>
<h2 id="step-3-define-control-actions">step 3: define control actions</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Vector of actions: harvest</span>
H &lt;-<span class="st"> </span>states</code></pre>
<h2 id="step-4-define-dynamic-model-with-demographic-parameters">step 4: define dynamic model (with demographic parameters)</h2>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">6</span>,<span class="fl">0.05</span>)
f &lt;-<span class="st"> </span>function(x, h){
  A &lt;-<span class="st"> </span>p[<span class="dv">1</span>] 
  B &lt;-<span class="st"> </span>p[<span class="dv">2</span>] 
  s &lt;-<span class="st"> </span><span class="kw">pmax</span>(x-h, <span class="dv">0</span>)
  A *<span class="st"> </span>s/(<span class="dv">1</span> +<span class="st"> </span>B *<span class="st"> </span>s)
}

sigma_g =<span class="st"> </span><span class="fl">0.1</span></code></pre>
<h2 id="step-5-define-utility">step 5: define utility</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
get_utility &lt;-<span class="st"> </span>function(x,h) {
    <span class="kw">pmin</span>(x,h)
}</code></pre>
<h2 id="step-6-solve-bellman-equation-with-value-iteration">step 6: solve bellman equation with value iteration</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initialize transition matrix</span>
transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(H)))

<span class="co"># Initialize utility matrix</span>
utility &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fill in the transition and utility matrix</span>
<span class="co"># Loop on all states</span>
for (k in <span class="dv">0</span>:K) {

    <span class="co"># Loop on all actions</span>
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {

<span class="co"># Calculate the transition state at the next step, given the </span>
<span class="co"># current state k and the harvest H[i]</span>
        nextpop &lt;-<span class="st"> </span><span class="kw">f</span>(k, H[i])
        if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>)
          transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(states) -<span class="st"> </span><span class="dv">1</span>))
    <span class="co"># Implement demographic stochasticity by drawing </span>
  <span class="co"># probability from a density function</span>
        else {

<span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
<span class="co"># For discrete probability distribution, this is easy if `states` includes all possible</span>
<span class="co"># discrete states below the capping state (e.g. all non-negative integers less than K).  </span>
<span class="co"># For a continuous distribution, this is more problematic as we have to first normalize the densities.</span>
<span class="co"># EDIT: this can be negative, due to floating-point errors. so we take max(v,0) to avoid</span>

<span class="co"># Get long-tailed denominator as normalizing factor (continuous distributions only):</span>
          fine_states &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(states), <span class="dv">10</span> *<span class="st"> </span><span class="kw">max</span>(states), <span class="dt">by =</span> states[<span class="dv">2</span>]-states[<span class="dv">1</span>])
        N &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dlnorm</span>(fine_states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g))

      transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">dlnorm</span>(states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g) /<span class="st"> </span>N
      
        <span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
        transition[k<span class="dv">+1</span>, K<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(transition[k<span class="dv">+1</span>, -(K<span class="dv">+1</span>), i]), <span class="dv">0</span>)

        }
        
        <span class="co"># Compute utility</span>
        utility[k<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">get_utility</span>(k, H[i])

    } <span class="co"># end of action loop</span>
} <span class="co"># end of state loop</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Discount factor</span>
discount &lt;-<span class="st"> </span><span class="fl">0.95</span>

<span class="co"># Action value vector at tmax</span>
Vtmax &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Action value vector at t and t+1</span>
Vt &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))
Vtplus &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Optimal policy vector</span>
D &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Time horizon</span>
Tmax &lt;-<span class="st"> </span><span class="dv">150</span></code></pre>
<h2 id="solution-calculated-explicitly">Solution calculated explicitly:</h2>
<p>The backward iteration consists in storing action values in the vector <code>Vt</code> which is the maximum of utility plus the future action values for all possible next states. Knowing the final action values, we can then backwardly reset the next action value <code>Vtplus</code> to the new value <code>Vt</code>. We start The backward iteration at time <code>T-1</code> since we already defined the action value at <code>Tmax</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">for (t in (Tmax -<span class="st"> </span><span class="dv">1</span>):<span class="dv">1</span>) {

<span class="co"># We define a matrix Q that stores the updated action values for </span>
<span class="co"># all states (rows)</span>
<span class="co"># actions (columns)</span>
    Q &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))
    
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {
    
<span class="co"># For each harvest rate we fill for all states values (row) </span>
<span class="co"># the ith column (Action) of matrix Q</span>
<span class="co"># The utility of the ith action recorded for all states is </span>
<span class="co"># added to the product of the transition matrix of the ith </span>
<span class="co"># action by the action value of all states </span>
        Q[,i] &lt;-<span class="st"> </span>utility[, i] +<span class="st"> </span>discount *<span class="st"> </span>(transition[,,i] %*%<span class="st"> </span>Vtplus)
    
    } <span class="co"># end of the harvest loop</span>

    <span class="co"># Find the optimal action value at time t is the maximum of Q</span>
    Vt &lt;-<span class="st"> </span><span class="kw">apply</span>(Q, <span class="dv">1</span>, max)

<span class="co"># After filling vector Vt of the action values at all states, we </span>
<span class="co"># update the vector Vt+1 to Vt and we go to the next step standing </span>
<span class="co"># for previous time t-1, since we iterate backward</span>
    Vtplus &lt;-<span class="st"> </span>Vt

} <span class="co"># end of the time loop</span>

<span class="co"># Find optimal action for each state</span>
for (k in <span class="dv">0</span>:K) {
<span class="co"># We look for each state which column of Q corresponds to the </span>
<span class="co"># maximum of the last updated value </span>
<span class="co"># of Vt (the one at time t + 1). If the index vector is longer than 1 </span>
<span class="co"># (if there is more than one optimal value we chose the minimum </span>
<span class="co"># harvest rate)</span>
    D[k +<span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span>H[(<span class="kw">min</span>(<span class="kw">which</span>(Q[k +<span class="st"> </span><span class="dv">1</span>, ] ==<span class="st"> </span>Vt[k +<span class="st"> </span><span class="dv">1</span>])))]
}</code></pre>
<h2 id="plot-solution">plot solution</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-9-1.png" />
</figure>
<h2 id="proof-of-optimality-compare-with-analytical-solution">proof of optimality: compare with analytical solution</h2>
<p>From Reed (1979) we know that the optimal solution is a constant-escapement rule:</p>
<p><span class="math">\[f&#39;(s^*) = 1/\alpha\]</span></p>
<p>For growth-rate function <span class="math">\(f\)</span>, where <span class="math">\(\alpha\)</span> is the discount factor and <span class="math">\(s^*\)</span> the stock size for the constant escapement. Analytic solutions are clearly possible for certain growth functions, but here I’ve just implemented a generic numerical solution.</p>
<pre class="sourceCode r"><code class="sourceCode r">fun &lt;-<span class="st"> </span>function(x) -<span class="st"> </span><span class="kw">f</span>(x,<span class="dv">0</span>) +<span class="st"> </span>x /<span class="st"> </span>discount
out &lt;-<span class="st"> </span><span class="kw">optimize</span>(<span class="dt">f =</span> fun, <span class="dt">interval =</span> <span class="kw">c</span>(<span class="dv">0</span>,K))
S_star &lt;-<span class="st"> </span>out$minimum

exact_policy &lt;-<span class="st"> </span><span class="kw">sapply</span>(states, 
                       function(x) 
                        if(x &lt;<span class="st"> </span>S_star) <span class="dv">0</span>
                        else x -<span class="st"> </span>S_star)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)

<span class="co"># The difference between Bellman equation solution and the analytical </span>
<span class="co"># solution is small:</span>
<span class="kw">lines</span>(states, states -<span class="st"> </span>exact_policy)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-11-1.png" />
</figure>
<h2 id="using-toolbox">Using toolbox</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">mdp_check</span>(<span class="dt">P =</span> transition, <span class="dt">R =</span> utility)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">out &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(transition, utility, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> Vtmax)</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)
<span class="kw">lines</span>(states, states -<span class="st"> </span>H[out$policy], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-13-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/14/mdptoolbox-ex-2.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/19/gp-nimble-v2.html">Gp Nimble V2</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 19 Jun 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#  devtools::install_github(&quot;cboettig/gpmanagement&quot;)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;gpmanagement&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">set.seed</span>(<span class="dv">1234</span>)
  Tobs &lt;-<span class="st"> </span><span class="dv">40</span>
  f &lt;-<span class="st"> </span>function (x, h, p){
    <span class="kw">sapply</span>(x, function(x) {
        x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
        x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
    })
  }
  p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">5</span>)
  sigma_g &lt;-<span class="st"> </span><span class="fl">0.05</span>
  z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_g)
  x &lt;-<span class="st"> </span><span class="kw">numeric</span>(Tobs)
  x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">5.5</span>
  for(t in <span class="dv">1</span>:(Tobs<span class="dv">-1</span>))
    x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">h=</span><span class="dv">0</span>, <span class="dt">p=</span>p)
  obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          <span class="kw">pmax</span>(<span class="kw">rep</span>(<span class="dv">0</span>,Tobs<span class="dv">-1</span>), x[<span class="dv">1</span>:(Tobs<span class="dv">-1</span>)])), 
                    <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          x[<span class="dv">2</span>:Tobs]))
  xObs &lt;-<span class="st"> </span>obs$x
  yObs &lt;-<span class="st"> </span>obs$y
  xPred &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dt">length=</span><span class="dv">50</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  fit &lt;-<span class="st"> </span><span class="kw">gp_setup</span>(xObs, yObs, xPred)</code></pre>
<pre><code>[1] RW_block sampler: rho, sigGP, sigOE,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 200,  scale: 1,  propCov: identity</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  Cmcmc &lt;-<span class="st"> </span>fit$Cmcmc 
  Cpred &lt;-<span class="st"> </span>fit$Cpred
  Cmodel &lt;-<span class="st"> </span>fit$Cmodel
  
  <span class="kw">system.time</span>(Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
 25.548   0.024  25.734 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(Cmcmc$mvSamples)
  ## basic sanity check
  testthat::<span class="kw">expect_identical</span>(Cmodel$<span class="kw">getNodeNames</span>(<span class="dt">topOnly =</span> <span class="ot">TRUE</span>), <span class="kw">colnames</span>(samples))</code></pre>
<p>predict from GP model using posterior MCMC samples</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
 26.604   0.004  26.680 </code></pre>
<p>extract predictions: E and C</p>
<pre class="sourceCode r"><code class="sourceCode r">  E &lt;-<span class="st"> </span>Cpred$<span class="kw">getE</span>()
  C &lt;-<span class="st"> </span>Cpred$<span class="kw">getC</span>()
  
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xObs, <span class="dt">y =</span> yObs)
pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">y =</span> E, <span class="dt">ymin =</span> E -<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)), <span class="dt">ymax =</span> E +<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)))
ggplot2::<span class="kw">ggplot</span>(pred) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x,<span class="dt">y =</span> y, <span class="dt">ymin =</span> ymin, <span class="dt">ymax =</span> ymax), <span class="dt">fill =</span> <span class="st">&quot;grey80&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">size=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> obs, <span class="kw">aes</span>(x,y)) +
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(<span class="kw">c</span>(xObs, xPred)), <span class="dt">ylim =</span> <span class="kw">range</span>(<span class="kw">c</span>(yObs,E))) +
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-19-gp-nimble-v2/unnamed-chunk-7-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/19/gp-nimble-v2.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/18/RAM-explore.html">Further exploration of RAM Legacy Stock Assessment data</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 18 Jun 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>({
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;RPostgreSQL&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;devtools&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)
})

## Perform this in data_raw to keep package dependencies minimal
mydb &lt;-<span class="st"> </span><span class="kw">src_postgres</span>(<span class="dt">dbname =</span> <span class="st">&quot;srdb&quot;</span>, 
                     <span class="dt">host=</span><span class="st">&quot;nautilus-vm.mathstat.dal.ca&quot;</span>, 
                     <span class="dt">user =</span> <span class="st">&quot;srdbuser&quot;</span>, 
                     <span class="dt">password =</span>  <span class="st">&quot;srd6us3r!&quot;</span>, 
                     <span class="dt">port =</span> <span class="dv">5432</span>)

timeseries &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries&quot;</span>)))
values &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_values_view&quot;</span>)))
units &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_units_view&quot;</span>)))
assessment &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessment&quot;</span>)))
area &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.area&quot;</span>)))
stock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.stock&quot;</span>)))
method &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessmethod&quot;</span>)))
assessor &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessor&quot;</span>)))
management  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.management&quot;</span>)))
taxonomy &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.taxonomy&quot;</span>)))
lmerefs &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmerefs&quot;</span>)))
lmestock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmetostocks&quot;</span>)))
biometrics  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.biometrics&quot;</span>)))
bioparams &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.bioparams&quot;</span>)))
tsmetrics &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.tsmetrics&quot;</span>)))</code></pre>
<h2 id="north-atlantic-cod-data">North Atlantic Cod data</h2>
<p>Select North Atlantic Cod, <em>Gadus morhua</em>:</p>
<pre class="sourceCode r"><code class="sourceCode r">cod_ids &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(scientificname==<span class="st">&quot;Gadus morhua&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span></code></pre>
<p>(Note we could have selected on the <code>tsn==164712</code> to be less ambiguous but also less semantic, or on <code>commonname==&quot;Atlantic cod&quot;</code> to be more reader friendly but even more ambiguous. Fortunately the common and scientific names are well aligned with the <code>tsn</code> ids in this case and we get the same set of 22 stock assessments.)</p>
<p>Before we can combine across these, we must verify that each assessment measures the quantities of interest using the same units, or otherwise correct those that do not:</p>
<pre class="sourceCode r"><code class="sourceCode r">units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, catch_landings_unit) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(catch_landings_unit) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="kw">length</span>(catch_landings_unit))</code></pre>
<pre><code>Source: local data frame [1 x 2]

  catch_landings_unit length(catch_landings_unit)
1                  MT                          21</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, total_unit) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(total_unit) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="kw">length</span>(total_unit))</code></pre>
<pre><code>Source: local data frame [3 x 2]

  total_unit length(total_unit)
1        E03                  1
2         MT                 18
3         NA                  2</code></pre>
<p>All catches are in metric tons, so no concern there.</p>
<p>Landing data we can plot immediately:</p>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">catch =</span> <span class="kw">sum</span>(catch_landings, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## all units are metric tons
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, catch)) +<span class="st"> </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Catch/Landings (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-4-1.png" />
</figure>
<p>Note that missing data is removed, such that any assessment without catch data is treated as zero catch. This could be the case (maybe not all assessments correspond to unique catch zones.) We also assume catch reported in one assessment is not also reported in a different assement (e.g. no double-counting). Lastly, we must bear in mind that this is catch/landings data, which may include bycatch, underreporting, etc.</p>
<hr />
<h2 id="handling-unit-conversions">Handling unit conversions</h2>
<p>The units for <code>total</code> are more problematic. The <code>NA</code> simply indicates stocks that do not have the an estimate for <code>total</code>, but we also see one assessment has totals in <code>E03</code> (thousands) instead of metric tons.</p>
<hr />
<p><em>Sidebar</em> how do we know for sure that <code>E03</code> is abundance counts in thousands of fish?</p>
<p>The database does not provide metadata for these unit definitions directly. the <code>values</code> data and its associated <code>units</code> metadata are actually derived tables from the raw <code>timeseries</code> table and the associated <code>tsmetrics</code> unit metadata, so we would have to dive in there to confirm this interpretation of <code>E03</code> in this case.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># tidy up the tsmetrics table:</span>
unit_defs &lt;-<span class="st"> </span>tsmetrics %&gt;%<span class="st"> </span><span class="kw">rename</span>(<span class="dt">tsid =</span> tsunique) %&gt;%<span class="st"> </span><span class="kw">select</span>(tsid, tslong, tsunitslong) 

<span class="co"># Find the assessid of the cod stock assessment that measures total in units of E03</span>
who &lt;-<span class="st"> </span>units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, total_unit) %&gt;%<span class="st"> </span><span class="kw">filter</span>(total_unit==<span class="st">&quot;E03&quot;</span>)

<span class="co"># Find that assessid in the timeseries table, where units are written in different notation</span>
ts_who &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>who$assessid) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, tsid) %&gt;%<span class="st">  </span><span class="kw">distinct</span>(tsid)

<span class="co"># Join the tables to see the definitions</span>
<span class="kw">left_join</span>(ts_who, unit_defs)</code></pre>
<pre><code>Source: local data frame [5 x 4]

                      assessid   tsid
1 NAFO-SC-COD3M-1959-2008-BAUM SSB-MT
2 NAFO-SC-COD3M-1959-2008-BAUM TN-E03
3 NAFO-SC-COD3M-1959-2008-BAUM  R-E03
4 NAFO-SC-COD3M-1959-2008-BAUM  F-1/T
5 NAFO-SC-COD3M-1959-2008-BAUM  TC-MT
Variables not shown: tslong (chr), tsunitslong (chr)</code></pre>
<p>and we can confirm <code>E03</code> is in this case <code>TN-E03</code> (total number, in thousands).</p>
<hr />
<p>Converting this to metric tons will require an average weight for cod. FishBase gives us a maximum weight (in grams):</p>
<pre class="sourceCode r"><code class="sourceCode r">rfishbase::<span class="kw">species</span>(<span class="st">&quot;Gadus morhua&quot;</span>, <span class="dt">fields=</span><span class="st">&quot;Weight&quot;</span>)</code></pre>
<pre><code>Error in loadNamespace(name): there is no package called &#39;rfishbase&#39;</code></pre>
<p>Wikipedia says the average is 5-12 kilograms, so let’s take 8.5 Kg for sake of argument. Clearly a more programmatic and more accurate solution is needed here.</p>
<p><em>Sidenote</em> the database has some very limited data on biometrics by assessment, including some assessments that record a maximum (but not an average) weight (sometimes pulled from FishBase anyway). Even pooling across all Atlantic Cod assessments we can’t find even a maximum weight.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Find the unit code for max weight</span>
biometrics %&gt;%<span class="st"> </span><span class="kw">filter</span>(biolong ==<span class="st"> &quot;Maximum weight&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(biounique) %&gt;%<span class="st"> </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() -&gt;<span class="st"> </span>max_weight
<span class="co"># show the unit code:</span>
max_weight</code></pre>
<pre><code>[1] &quot;MAX-WGT-g&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Look up all max weight values for illustration: (not filtering on cod_ids since there are no hits)</span>
bioparams %&gt;%<span class="st"> </span><span class="kw">filter</span>(bioid %in%<span class="st"> </span>max_weight)</code></pre>
<pre><code>Source: local data frame [17 x 5]

                                  assessid     bioid  biovalue
1      INIDEP-ARGANCHOSARG-1992-2007-Parma MAX-WGT-g        51
2      INIDEP-ARGANCHONARG-1989-2007-Parma MAX-WGT-g        48
3       INIDEP-ARGHAKESARG-1985-2008-Parma MAX-WGT-g   5300.00
4       INIDEP-ARGHAKENARG-1985-2007-Parma MAX-WGT-g   5900.00
5  INIDEP-PATGRENADIERSARG-1983-2006-Parma MAX-WGT-g      2940
6            ICCAT-ALBANATL-1929-2005-WORM MAX-WGT-g     60000
7         ICCAT-ATBTUNAEATL-1969-2007-WORM MAX-WGT-g    684000
8         ICCAT-ATBTUNAWATL-1969-2007-WORM MAX-WGT-g    684000
9   AFSC-SABLEFEBSAIGA-1956-2008-MELNYCHUK MAX-WGT-g      6200
10           IPHC-PHALNPAC-1988-2009-Parma MAX-WGT-g available
11     AFSC-REYEROCKBSAI-1974-2009-STANTON MAX-WGT-g      2047
12            NEFSC-ATHAL5YZ-1800-2007-COL MAX-WGT-g    337000
13     NEFSC-SCUPNWATLC-1960-2007-TERCEIRO MAX-WGT-g      3000
14     NEFSC-MONKGOMNGB-1964-2006-RICHARDS MAX-WGT-g    337000
15      NEFSC-SURFMATLC-1965-2008-JACOBSON MAX-WGT-g      600+
16   CSERG-ANCHOVYKILKACS-1991-2007-JENSEN MAX-WGT-g      18.4
17        ASMFC-PANDALGOM-1960-2009-IDOINE MAX-WGT-g        23
Variables not shown: bioyear (chr), bionotes (chr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">e03_to_MT &lt;-<span class="st"> </span><span class="fl">7.5</span> *<span class="st"> </span><span class="fl">1e-3</span>

tmpA &lt;-<span class="st"> </span>
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>who$assessid) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_mt =</span> total *<span class="st"> </span>e03_to_MT)

everyone_else &lt;-<span class="st"> </span>cod_ids[!(cod_ids %in%<span class="st"> </span>who$assessid)]
tmpB &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>everyone_else) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_mt =</span> total)

std_values &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(tmpA,tmpB)</code></pre>
<p>(Not sure if there is a more consise way to change the values in a given column for a subset of the rows). Well, perhaps it would be simpler to treat non-standard units as missing data, but at least this illustrates a mechanism for handling the conversion.</p>
<pre class="sourceCode r"><code class="sourceCode r">biomass &lt;-
<span class="st">  </span>std_values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total_mt, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

biomass_dropped &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>everyone_else) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

biomass_wrong &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

<span class="kw">ggplot</span>(biomass, <span class="kw">aes</span>(tsyear, biomass)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>biomass_wrong, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>biomass_dropped, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Biomass (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)
  
<span class="co"># they may look identical but they aren&#39;t:</span>
<span class="kw">identical</span>(biomass_dropped$biomass, biomass$biomass)</code></pre>
<pre><code>[1] FALSE</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-9-1.png" />
</figure>
<p>In this case, the contribution is negligible (red vs black). Even failing to convert units (blue) makes a hardly visible difference, though in general the difference could have been quite large.</p>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids, total &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total, <span class="dt">color=</span>assessid)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Biomass (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-10-1.png" />
</figure>
<hr />
<h2 id="stock-recruitment-time-series">Stock-recruitment &amp; time-series</h2>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids[[<span class="dv">1</span>]]) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span><span class="kw">geom_point</span>()
values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid==<span class="st">&quot;AFWG-CODNEAR-1943-2006-MINTO&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span><span class="kw">geom_point</span>()

values %&gt;%
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)


values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-2.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-3.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-4.png" /></p>
<p>Note that the spawning stock biomass, red, can often be significantly less than the total stock (black).</p>
<pre class="sourceCode r"><code class="sourceCode r">herring &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Herring&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>herring) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>herring) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-12-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-12-2.png" /></p>
<pre class="sourceCode r"><code class="sourceCode r">anchovy &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Anchovy&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>anchovy) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>anchovy) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-13-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-13-2.png" /></p>
<pre class="sourceCode r"><code class="sourceCode r">bluefin &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Atlantic bluefin tuna&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>bluefin) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)


values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>bluefin) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-14-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-14-2.png" /></p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/18/RAM-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/16/daniel-gp-example.html">Daniel Gp Example</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 16 Jun 2015</p>

<article>
<div class="excerpt">
<h3 id="setup">Setup</h3>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;nimble&quot;</span>)
<span class="kw">set.seed</span>(<span class="dv">0</span>)</code></pre>
<p>Randomly generate some sinusoidal data</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">100</span>
y &lt;-<span class="st"> </span><span class="kw">sin</span>(x/<span class="dv">5</span>) +<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="fl">0.1</span>)
ind &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">sample</span>(<span class="dv">1</span>:<span class="dv">100</span>, <span class="dv">40</span>))</code></pre>
<p>The next three lines are the only inputs required.</p>
<pre class="sourceCode r"><code class="sourceCode r">xObs &lt;-<span class="st"> </span>x[ind]                ## input
yObs &lt;-<span class="st"> </span>y[ind]                ## input
xPred &lt;-<span class="st"> </span><span class="kw">c</span>(x, <span class="dv">101</span>:<span class="dv">120</span>)        ## input</code></pre>
<p>Some initial processing</p>
<pre class="sourceCode r"><code class="sourceCode r">nObs &lt;-<span class="st"> </span><span class="kw">length</span>(xObs)
nPred &lt;-<span class="st"> </span><span class="kw">length</span>(xPred)
f &lt;-<span class="st"> </span>function(xi, xj) (xi-xj)^<span class="dv">2</span>
diffOO &lt;-<span class="st"> </span><span class="kw">outer</span>(xObs,  xObs,  f)
diffPP &lt;-<span class="st"> </span><span class="kw">outer</span>(xPred, xPred, f)
diffPO &lt;-<span class="st"> </span><span class="kw">outer</span>(xPred, xObs,  f)</code></pre>
<h3 id="nimble-function-for-gp-prediction">NIMBLE function for GP prediction</h3>
<p>Here’s the main function for doing the prediction from the GP model.</p>
<p>It takes the MCMC samples as a <em>runtime</em> argument, so this can be iterated with running the MCMC for different numbers of iterations, initial values, or even different datasets!</p>
<pre class="sourceCode r"><code class="sourceCode r">gpPred &lt;-<span class="st"> </span><span class="kw">nimbleFunction</span>(
    <span class="dt">setup =</span> function(model, params) {
        calcNodes &lt;-<span class="st"> </span>model$<span class="kw">getDependencies</span>(params, <span class="dt">determOnly =</span> <span class="ot">TRUE</span>)
        nPred &lt;-<span class="st"> </span><span class="kw">dim</span>(model$SigPP)[<span class="dv">1</span>]
        E &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(nPred, <span class="dv">1</span>))
        C &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(nPred, nPred))
    },
    <span class="dt">run =</span> function(<span class="dt">samples =</span> <span class="kw">double</span>(<span class="dv">2</span>)) {
        E &lt;&lt;-<span class="st"> </span>E *<span class="st"> </span><span class="dv">0</span>
        C &lt;&lt;-<span class="st"> </span>C *<span class="st"> </span><span class="dv">0</span>
        nSamples &lt;-<span class="st"> </span><span class="kw">dim</span>(samples)[<span class="dv">1</span>]
        for(i in <span class="dv">1</span>:nSamples) {
            <span class="kw">values</span>(model, params) &lt;&lt;-<span class="st"> </span>samples[i,]
            <span class="kw">calculate</span>(model, calcNodes)
            intermediate &lt;-<span class="st"> </span>model$SigPO %*%<span class="st"> </span><span class="kw">inverse</span>(model$SigOO)
            Etemp &lt;-<span class="st"> </span>intermediate %*%<span class="st"> </span><span class="kw">asCol</span>(model$yObs)
            Ctemp &lt;-<span class="st"> </span>model$SigPP -<span class="st"> </span>intermediate %*%<span class="st"> </span><span class="kw">t</span>(model$SigPO)
            E &lt;&lt;-<span class="st"> </span>E +<span class="st"> </span>Etemp
            C &lt;&lt;-<span class="st"> </span>C +<span class="st"> </span>Ctemp
        }
        E &lt;&lt;-<span class="st"> </span>E /<span class="st"> </span>nSamples
        C &lt;&lt;-<span class="st"> </span>C /<span class="st"> </span>nSamples
    },
    <span class="dt">methods =</span> <span class="kw">list</span>(
        <span class="dt">getE =</span> function() { <span class="kw">returnType</span>(<span class="kw">double</span>(<span class="dv">1</span>)); <span class="kw">return</span>(E[,<span class="dv">1</span>]) },
        <span class="dt">getC =</span> function() { <span class="kw">returnType</span>(<span class="kw">double</span>(<span class="dv">2</span>)); <span class="kw">return</span>(C[, ]) }
    )
)</code></pre>
<h3 id="gp-model">GP model</h3>
<p>GP model defined here. Basically the same as your original, but I renamed some paramters more to my liking =)</p>
<p>This is <em>not</em> as elegant as I had hoped. It still requires repeating (essentially) the same code three times. I discovered some limitations of NIMBLE while trying other approaches.</p>
<p>Bottom line:<br />- This achieves relatively nice simplicity.<br />- There’s an efficiency hit to the MCMC sampling, but it doesn’t seem too bad.<br />- This works.</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   rho ~<span class="st"> </span><span class="kw">dgamma</span>(<span class="dv">10</span>, <span class="dv">1</span>)
   sigGP ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
   sigOE ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
   SigOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ]/rho^<span class="dv">2</span>) +<span class="st"> </span>sigOE^<span class="dv">2</span>*IOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ]
   SigPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred]/rho^<span class="dv">2</span>) +<span class="st"> </span>sigOE^<span class="dv">2</span>*IPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred]
   SigPO[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nObs ] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffPO[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nObs ]/rho^<span class="dv">2</span>)
   yObs[<span class="dv">1</span>:nObs] ~<span class="st"> </span><span class="kw">dmnorm</span>(mu[<span class="dv">1</span>:nObs], <span class="dt">cov =</span> SigOO[<span class="dv">1</span>:nObs,<span class="dv">1</span>:nObs])
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">nObs=</span>nObs, <span class="dt">nPred=</span>nPred, <span class="dt">diffOO=</span>diffOO, <span class="dt">diffPP=</span>diffPP, <span class="dt">diffPO=</span>diffPO,
                  <span class="dt">IOO=</span><span class="kw">diag</span>(nObs), <span class="dt">IPP=</span><span class="kw">diag</span>(nPred), <span class="dt">mu=</span><span class="kw">rep</span>(<span class="dv">0</span>,nObs))

data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">yObs =</span> yObs)

inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rho =</span> <span class="dv">1</span>, <span class="dt">sigGP =</span> <span class="dv">1</span>, <span class="dt">sigOE =</span> <span class="dv">1</span>)

Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(code, constants, data, inits)</code></pre>
<h3 id="create-compile-and-run">Create, compile, and run</h3>
<pre class="sourceCode r"><code class="sourceCode r">## MCMC specification with no samplers
spec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">nodes =</span> <span class="ot">NULL</span>)

## this will be used for some checking, and setting up block sampler:
params &lt;-<span class="st"> </span>Rmodel$<span class="kw">getNodeNames</span>(<span class="dt">topOnly =</span> <span class="ot">TRUE</span>)

## NOTE: the next line shouldn&#39;t work for you, since the MCMC API has changed.
## you can rebuild from source off nimble branch &#39;devel&#39;.
## otherwise, using last public release of NIMBLE (0.3-1), use this line instead:
## spec$addSampler(&#39;RW_block&#39;, control = list(targetNodes = params))
spec$<span class="kw">addSampler</span>(params, <span class="st">&#39;RW_block&#39;</span>)</code></pre>
<pre><code>[1] RW_block sampler: rho, sigGP, sigOE,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 200,  scale: 1,  propCov: identity</code></pre>
<p>We can debate about univariate vs. block sampling at some point.</p>
<pre class="sourceCode r"><code class="sourceCode r">## MCMC function
Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(spec)

## GP prediction function
## also uses the &#39;params&#39; variable for specialization
Rpred &lt;-<span class="st"> </span><span class="kw">gpPred</span>(Rmodel, params)

## compile everything
Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
Cmcmc  &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Rmodel)
Cpred  &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rpred, <span class="dt">project =</span> Rmodel)

## MCMC sampling
## 100,000 iterations
<span class="kw">system.time</span>(Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
 49.068   0.016  49.057 </code></pre>
<p>About 25 seconds on my computer</p>
<p>That can be improved if necessary</p>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(Cmcmc$mvSamples)

## quick check
if(!<span class="kw">identical</span>(params, <span class="kw">colnames</span>(samples))) <span class="kw">stop</span>(<span class="st">&#39;problem&#39;</span>)

## predict from GP model using posterior MCMC samples
<span class="kw">system.time</span>(Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
 64.236   0.000  64.188 </code></pre>
<p>About 40 seconds on my computer</p>
<p>Again, could streamline the gpPred() function if necessary</p>
<pre class="sourceCode r"><code class="sourceCode r">## extract predictions: E and C
E &lt;-<span class="st"> </span>Cpred$<span class="kw">getE</span>()
C &lt;-<span class="st"> </span>Cpred$<span class="kw">getC</span>()</code></pre>
<h3 id="output">Output</h3>
<pre class="sourceCode r"><code class="sourceCode r">E</code></pre>
<pre><code>  [1]  1.048953470  1.063690923  1.056571565  1.025025296  0.967727602
  [6]  0.885088092  0.779046134  0.652750089  0.510403944  0.357145489
 [11]  0.198827230  0.041501513 -0.109026506 -0.247533773 -0.369716151
 [16] -0.472313950 -0.553105378 -0.610874554 -0.645461105 -0.657719603
 [21] -0.649076810 -0.621198765 -0.575868588 -0.514737033 -0.439105417
 [26] -0.349971602 -0.248371381 -0.135451833 -0.012707283  0.117353661
 [31]  0.251084159  0.383920114  0.510567530  0.625303732  0.722419735
 [36]  0.796925448  0.845259818  0.865448082  0.857113606  0.821872152
 [41]  0.763535592  0.687360014  0.599297100  0.505480001  0.411259520
 [46]  0.320288380  0.234175561  0.152695050  0.074286902 -0.003167262
 [51] -0.081466127 -0.161638385 -0.243673849 -0.325876291 -0.404833854
 [56] -0.476477835 -0.536583186 -0.580993801 -0.606153844 -0.609554981
 [61] -0.590206477 -0.548974521 -0.488316837 -0.411928777 -0.324540013
 [66] -0.231641132 -0.139114920 -0.052860394  0.021550784  0.079331411
 [71]  0.117042000  0.132978712  0.127078948  0.100689033  0.056355647
 [76] -0.002485485 -0.071873133 -0.147591543 -0.225248038 -0.300383786
 [81] -0.368679284 -0.425886710 -0.467685571 -0.489815787 -0.488669528
 [86] -0.462038368 -0.409587331 -0.332776473 -0.234523765 -0.119090537
 [91]  0.008395849  0.142692615  0.278921123  0.412628846  0.539726698
 [96]  0.656454950  0.759426449  0.845730518  0.912939607  0.959256645
[101]  0.984015990  0.987978885  0.972988593  0.941606557  0.896909969
[106]  0.842215301  0.780777080  0.715559458  0.649099436  0.583448236
[111]  0.520171088  0.460385520  0.404821033  0.353887176  0.307741235
[116]  0.266350221  0.229544512  0.197062243  0.168584714  0.143763668</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">diag</span>(C)</code></pre>
<pre><code>  [1] 1.2679882 1.2064883 1.1541432 1.1116728 1.0784248 1.0524884
  [7] 1.0317576 1.0147224 1.0007923 0.9900904 0.9827438 0.9787769
 [13] 0.9777564 0.9783522 0.9785871 0.9766328 0.9714366 0.9630053
 [19] 0.9522229 0.9402332 0.9284669 0.9183767 0.9109672 0.9068412
 [25] 0.9062843 0.9093517 0.9158928 0.9254797 0.9372421 0.9497874
 [31] 0.9614992 0.9705821 0.9757483 0.9766685 0.9740220 0.9691475
 [37] 0.9633160 0.9577090 0.9532083 0.9500621 0.9480639 0.9471172
 [43] 0.9473233 0.9485876 0.9506984 0.9530274 0.9546481 0.9549896
 [49] 0.9542985 0.9535398 0.9539394 0.9568409 0.9630692 0.9727686
 [55] 0.9850166 0.9979048 1.0093360 1.0177498 1.0224490 1.0235779
 [61] 1.0216894 1.0172186 1.0108482 1.0037543 0.9975825 0.9940451
 [67] 0.9942810 0.9988192 1.0071728 1.0181157 1.0297591 1.0394083
 [73] 1.0443944 1.0429170 1.0346484 1.0209019 1.0041130 0.9869394
 [79] 0.9713413 0.9580174 0.9466908 0.9370265 0.9291060 0.9233148
 [85] 0.9204774 0.9213396 0.9262437 0.9349512 0.9465634 0.9595347
 [91] 0.9721773 0.9829212 0.9902883 0.9935894 0.9933386 0.9913798
 [97] 0.9906718 0.9946403 1.0070336 1.0312845 1.0694759 1.1218007
[103] 1.1866870 1.2612294 1.3418003 1.4247225 1.5067538 1.5853383
[109] 1.6586720 1.7256456 1.7857277 1.8388290 1.8851737 1.9251909
[115] 1.9594282 1.9884878 2.0129814 2.0334994 2.0505931 2.0647637</code></pre>
<p>Black dots are the original ‘xObs’ and ‘yObs’</p>
<p>Red dots are the predictions made at each ‘xPred’</p>
<p>Red lines are plus/minus one standard error</p>
<figure>
<img src="/2015/assets/figures/posts/2015-06-16-daniel-gp-example/unnamed-chunk-13-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/16/daniel-gp-example.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/03/lazy-evaluation-thoughts.html">Lazy Evaluation Thoughts</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 03 Jun 2015</p>

<article>
<div class="excerpt">
<p>This is just a draft of my reply to Gavin’s <a href="http://www.fromthebottomoftheheap.net/2015/06/03/my-aversion-to-pipes/">thought-provoking post</a> pushing back on pipes and NSE in R.</p>
<hr />
<p>Gavin, really nice post and discussion here. I am still conflicted about some these issues myself.</p>
<p>For me, the issues of NSE are somewhat separate and above my concern with pipes. I agree completely with your observation that intermediate assignment is easier to read than nested assignment, and not that much harder to read than a pipe chain. However I also agree with other commenters that not having to think about intermediate assignment variables is nice (e.g. I usually do something like replacing <code>the_data</code> with <code>tmp</code> or some such in each occurrence after the first in your example to make this more explicit). But for the most part I do not find the pipe syntax to be problematic in the same way that NSE is – indeed I can use the pipe operator with the SE versions of the same functions, or with any other SE R function.</p>
<p>NSE to me is a whole different can of worms. It does make the syntax much more consise and more semantic, (even while it obfuscates what is a string, a numeric, or a variable). But this whole “don’t use it in programming” thing seems very impractical to me. When I first started R, I got the same advice – only it was for R itself – use it interactively, but for real programming write everything in C. Then maybe add some R wrappers on top. Um.. yeah, I actually did that for a few years… long ago. Most of the time I don’t even know if I’m programming or not. Sure, it’s easy to use the SE versions when working on some function you know will be part of an R package, but NSE has bitten me several times in various research scripts. Stupid things perhaps – where I have done things like changing a filter argument to a variable with the same name as a column (<code>filter(x == .5)</code> into a <code>filter(x == x)</code>) – but very difficult to debug since they do not throw errors.</p>
<p>Nevertheless, both the performance and consise abstractions of common manipulation tasks make it hard to walk away from <code>dplyr</code> and friends. However, I find the syntax required to use the SE versions of the dplyr functions immensely cumbersome and opaque (e.g. http://www.carlboettiger.info/2015/02/06/fun-standardizing-non-standard-evaluation.html). Some of these can be written more concisely with a different SE syntax, but having 4 different ways to introduce a variable value, not all of which cover all the same cases, is even worse to me than just sticking with the most complex. No doubt I lack appreciation of the complexity here, but it seems like it should be possible to have a syntax that is nearly as consise as the NSE but where I can replace values with variables (e.g. <code>filter(&quot;Y&quot; == &quot;X&quot;)</code> to <code>filter(y == x)</code>) without needing something like</p>
<pre class="sourceCode r"><code class="sourceCode r">dots &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">names</span>(query), function(level){
value &lt;-<span class="st"> </span>query[[level]]
<span class="kw">interp</span>(~y ==<span class="st"> </span>x, 
<span class="dt">.values =</span> <span class="kw">list</span>(<span class="dt">y =</span> <span class="kw">as.name</span>(level), <span class="dt">x =</span> value))
})</code></pre>
<p>Anyway, apologies for the rant – just trying to say I share your hesitation regarding NSE but pipes don’t bother me. (I do think lazy eval on pipes is a win btw – e.g. try testing out the same long pipe-string analysis on data coming from a remote database; say, just to check that the first 10 rows of output look right before evaluation the whole database)</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/03/lazy-evaluation-thoughts.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/05/15/diagrammer.html">Diagrammer</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 15 May 2015</p>

<article>
<div class="excerpt">
<p>Exploring ways for using <code>DiagrammeR</code> to generate graphs/plots that can be exported to svg and included in knitr documents.</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;rich-iannone/DiagrammeR&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;DiagrammeR&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;archive&quot;</span>, <span class="st">&quot;index&quot;</span>, <span class="st">&quot;share&quot;</span>, <span class="st">&quot;discover&quot;</span>, <span class="st">&quot;use&quot;</span>, <span class="st">&quot;attribute&quot;</span>)

nodes &lt;-<span class="st"> </span><span class="kw">create_nodes</span>(<span class="dt">nodes =</span> <span class="kw">c</span>(<span class="st">&quot;Repository</span><span class="ch">\n</span><span class="st"> Roles&quot;</span>, n, <span class="st">&quot;Researcher</span><span class="ch">\n</span><span class="st"> Roles&quot;</span>), 
                      <span class="dt">shape =</span> <span class="st">&quot;circle&quot;</span>, 
                      <span class="dt">color =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;PowderBlue&quot;</span>, <span class="dv">4</span>), <span class="kw">rep</span>(<span class="st">&quot;Linen&quot;</span>, <span class="dv">4</span>)),
                      <span class="dt">style =</span> <span class="st">&quot;filled&quot;</span>)
edges &lt;-<span class="st"> </span><span class="kw">create_edges</span>(<span class="dt">from =</span> n, 
                      <span class="dt">to =</span> <span class="kw">c</span>(n[-<span class="dv">1</span>], n[<span class="dv">1</span>]),
                      <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">penwidth =</span> <span class="dv">4</span>)

graph &lt;-<span class="st"> </span><span class="kw">create_graph</span>(<span class="dt">nodes =</span> nodes, <span class="dt">edges =</span> edges, 
                      <span class="dt">graph_attrs =</span> <span class="kw">c</span>(<span class="st">&quot;layout = circo&quot;</span>))
out &lt;-<span class="st"> </span><span class="kw">render_graph</span>(graph)</code></pre>
<p>Render as SVG</p>
<pre class="sourceCode r"><code class="sourceCode r">basename &lt;-<span class="st"> &quot;figure1&quot;</span>
out &lt;-<span class="st"> </span><span class="kw">render_graph</span>(graph, <span class="dt">output =</span> <span class="st">&quot;SVG&quot;</span>)
<span class="kw">writeLines</span>(out, <span class="kw">paste0</span>(basename, <span class="st">&quot;.svg&quot;</span>))</code></pre>
<p>Render as pdf, for inculsion in pdf/tex files.</p>
<pre class="sourceCode r"><code class="sourceCode r">## Not Run
<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&quot;inkscape --export-png &quot;</span>, basename, <span class="st">&quot;.png&quot;</span>, 
<span class="co">#              &quot;-w &quot;, width, &quot; -h &quot;, height, </span>
              <span class="st">&quot; --export-dpi 300 &quot;</span>, 
              basename, <span class="st">&quot;.svg&quot;</span>)) 

<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&quot;inkscape --export-pdf &quot;</span>, basename, <span class="st">&quot;.pdf &quot;</span>, basename, <span class="st">&quot;.svg&quot;</span>)) </code></pre>
<p>Embed in post? maybe? This could be more elegant:</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw">paste0</span>(basename, <span class="st">&quot;.svg&quot;</span>)
target &lt;-<span class="st"> </span><span class="kw">paste0</span>(knitr::opts_chunk$<span class="kw">get</span>(<span class="st">&quot;fig.path&quot;</span>), f)
<span class="kw">file.rename</span>(f, target)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste0</span>(<span class="st">&quot;![](&quot;</span>, target, <span class="st">&quot;)&quot;</span>)</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/05/15/diagrammer.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

  </div>
</div> <!--end row -->

<div class="row socialicons">
  <div class="col-md-11 col-md-offset-1">
		<p> <a href="/2015/index.html"><i class="icon-calendar"></i> All entries by date</a></p> 
      <p> <a href="/2015/categories.html"><i class="icon-list"></i> All entries by category</a> </p>
      <p> <a href="/2015/tags.html"><i class="icon-tags"></i> All entries by tag</a> </p>
  </div> <!--end col-md-9 -->
</div> <!--end row -->




      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="http://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="http://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Lab Notebook
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=http://www.carlboettiger.info/lab-notebook.html">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
