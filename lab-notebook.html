<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: http://purl.org/dc/terms/ og: http://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Lab Notebook</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Lab Notebook" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/lab-notebook.html" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Lab Notebook" />
<meta property="og:author" content="http://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="http://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="http://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="http://ogp.me/ns/article#published_time" content="" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="http://www.carlboettiger.info/lab-notebook.html" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content=""/>
<meta name="citation_title" content="Lab Notebook"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/academicons.css" />
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="http://www.carlboettiger.info/blog.xml" />
</head>


  <body prefix="dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  class="active" >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="http://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Lab Notebook</h1>
        <h2>(<a href="http://www.carlboettiger.info/2012/09/28/Welcome-to-my-lab-notebook.html">Introduction</a>)</h2>
      </header>

      <div class="row postpreview">
  <div class="col-md-11 col-md-offset-1">
    <div class="row">
			<h4> <a href="/2015/atom.xml"
              onClick="recordOutboundLink(this,
              'Outbound Links', 'RSS'); return false;"
              style="color: inherit;"
              ><i class="icon-rss" ></i> Entries</a></h4>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/14/mdptoolbox-ex-2.html">Mdptoolbox Ex 2</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 14 Jul 2015</p>

<article>
<div class="excerpt">
<p>Adapted from Marescot et al. appendix 5, to Reed optimal control problem, including direct comparison against (semi) analytic optimum.</p>
<h2 id="step-1-define-objectives">step 1: define objectives</h2>
<p>This is a conceptual step which does not require coding</p>
<h2 id="step-2-define-states">step 2: define states</h2>
<pre class="sourceCode r"><code class="sourceCode r">K &lt;-<span class="st"> </span><span class="dv">150</span> <span class="co"># state space limit</span>
states &lt;-<span class="st"> </span><span class="dv">0</span>:K <span class="co"># Vector of all possible states</span></code></pre>
<h2 id="step-3-define-control-actions">step 3: define control actions</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Vector of actions: harvest</span>
H &lt;-<span class="st"> </span>states</code></pre>
<h2 id="step-4-define-dynamic-model-with-demographic-parameters">step 4: define dynamic model (with demographic parameters)</h2>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">6</span>,<span class="fl">0.05</span>)
f &lt;-<span class="st"> </span>function(x, h){
  A &lt;-<span class="st"> </span>p[<span class="dv">1</span>] 
  B &lt;-<span class="st"> </span>p[<span class="dv">2</span>] 
  s &lt;-<span class="st"> </span><span class="kw">pmax</span>(x-h, <span class="dv">0</span>)
  A *<span class="st"> </span>s/(<span class="dv">1</span> +<span class="st"> </span>B *<span class="st"> </span>s)
}

sigma_g =<span class="st"> </span><span class="fl">0.1</span></code></pre>
<h2 id="step-5-define-utility">step 5: define utility</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
get_utility &lt;-<span class="st"> </span>function(x,h) {
    <span class="kw">pmin</span>(x,h)
}</code></pre>
<h2 id="step-6-solve-bellman-equation-with-value-iteration">step 6: solve bellman equation with value iteration</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initialize transition matrix</span>
transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(H)))

<span class="co"># Initialize utility matrix</span>
utility &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fill in the transition and utility matrix</span>
<span class="co"># Loop on all states</span>
for (k in <span class="dv">0</span>:K) {

    <span class="co"># Loop on all actions</span>
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {

<span class="co"># Calculate the transition state at the next step, given the </span>
<span class="co"># current state k and the harvest H[i]</span>
        nextpop &lt;-<span class="st"> </span><span class="kw">f</span>(k, H[i])
        if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>)
          transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(states) -<span class="st"> </span><span class="dv">1</span>))
    <span class="co"># Implement demographic stochasticity by drawing </span>
  <span class="co"># probability from a density function</span>
        else {

<span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
<span class="co"># For discrete probability distribution, this is easy if `states` includes all possible</span>
<span class="co"># discrete states below the capping state (e.g. all non-negative integers less than K).  </span>
<span class="co"># For a continuous distribution, this is more problematic as we have to first normalize the densities.</span>
<span class="co"># EDIT: this can be negative, due to floating-point errors. so we take max(v,0) to avoid</span>

<span class="co"># Get long-tailed denominator as normalizing factor (continuous distributions only):</span>
          fine_states &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(states), <span class="dv">10</span> *<span class="st"> </span><span class="kw">max</span>(states), <span class="dt">by =</span> states[<span class="dv">2</span>]-states[<span class="dv">1</span>])
        N &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dlnorm</span>(fine_states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g))

      transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">dlnorm</span>(states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g) /<span class="st"> </span>N
      
        <span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
        transition[k<span class="dv">+1</span>, K<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(transition[k<span class="dv">+1</span>, -(K<span class="dv">+1</span>), i]), <span class="dv">0</span>)

        }
        
        <span class="co"># Compute utility</span>
        utility[k<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">get_utility</span>(k, H[i])

    } <span class="co"># end of action loop</span>
} <span class="co"># end of state loop</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Discount factor</span>
discount &lt;-<span class="st"> </span><span class="fl">0.95</span>

<span class="co"># Action value vector at tmax</span>
Vtmax &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Action value vector at t and t+1</span>
Vt &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))
Vtplus &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Optimal policy vector</span>
D &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Time horizon</span>
Tmax &lt;-<span class="st"> </span><span class="dv">150</span></code></pre>
<h2 id="solution-calculated-explicitly">Solution calculated explicitly:</h2>
<p>The backward iteration consists in storing action values in the vector <code>Vt</code> which is the maximum of utility plus the future action values for all possible next states. Knowing the final action values, we can then backwardly reset the next action value <code>Vtplus</code> to the new value <code>Vt</code>. We start The backward iteration at time <code>T-1</code> since we already defined the action value at <code>Tmax</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">for (t in (Tmax -<span class="st"> </span><span class="dv">1</span>):<span class="dv">1</span>) {

<span class="co"># We define a matrix Q that stores the updated action values for </span>
<span class="co"># all states (rows)</span>
<span class="co"># actions (columns)</span>
    Q &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))
    
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {
    
<span class="co"># For each harvest rate we fill for all states values (row) </span>
<span class="co"># the ith column (Action) of matrix Q</span>
<span class="co"># The utility of the ith action recorded for all states is </span>
<span class="co"># added to the product of the transition matrix of the ith </span>
<span class="co"># action by the action value of all states </span>
        Q[,i] &lt;-<span class="st"> </span>utility[, i] +<span class="st"> </span>discount *<span class="st"> </span>(transition[,,i] %*%<span class="st"> </span>Vtplus)
    
    } <span class="co"># end of the harvest loop</span>

    <span class="co"># Find the optimal action value at time t is the maximum of Q</span>
    Vt &lt;-<span class="st"> </span><span class="kw">apply</span>(Q, <span class="dv">1</span>, max)

<span class="co"># After filling vector Vt of the action values at all states, we </span>
<span class="co"># update the vector Vt+1 to Vt and we go to the next step standing </span>
<span class="co"># for previous time t-1, since we iterate backward</span>
    Vtplus &lt;-<span class="st"> </span>Vt

} <span class="co"># end of the time loop</span>

<span class="co"># Find optimal action for each state</span>
for (k in <span class="dv">0</span>:K) {
<span class="co"># We look for each state which column of Q corresponds to the </span>
<span class="co"># maximum of the last updated value </span>
<span class="co"># of Vt (the one at time t + 1). If the index vector is longer than 1 </span>
<span class="co"># (if there is more than one optimal value we chose the minimum </span>
<span class="co"># harvest rate)</span>
    D[k +<span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span>H[(<span class="kw">min</span>(<span class="kw">which</span>(Q[k +<span class="st"> </span><span class="dv">1</span>, ] ==<span class="st"> </span>Vt[k +<span class="st"> </span><span class="dv">1</span>])))]
}</code></pre>
<h2 id="plot-solution">plot solution</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-9-1.png" />
</figure>
<h2 id="proof-of-optimality-compare-with-analytical-solution">proof of optimality: compare with analytical solution</h2>
<p>From Reed (1979) we know that the optimal solution is a constant-escapement rule:</p>
<p><span class="math">\[f&#39;(s^*) = 1/\alpha\]</span></p>
<p>For growth-rate function <span class="math">\(f\)</span>, where <span class="math">\(\alpha\)</span> is the discount factor and <span class="math">\(s^*\)</span> the stock size for the constant escapement. Analytic solutions are clearly possible for certain growth functions, but here I’ve just implemented a generic numerical solution.</p>
<pre class="sourceCode r"><code class="sourceCode r">fun &lt;-<span class="st"> </span>function(x) -<span class="st"> </span><span class="kw">f</span>(x,<span class="dv">0</span>) +<span class="st"> </span>x /<span class="st"> </span>discount
out &lt;-<span class="st"> </span><span class="kw">optimize</span>(<span class="dt">f =</span> fun, <span class="dt">interval =</span> <span class="kw">c</span>(<span class="dv">0</span>,K))
S_star &lt;-<span class="st"> </span>out$minimum

exact_policy &lt;-<span class="st"> </span><span class="kw">sapply</span>(states, 
                       function(x) 
                        if(x &lt;<span class="st"> </span>S_star) <span class="dv">0</span>
                        else x -<span class="st"> </span>S_star)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)

<span class="co"># The difference between Bellman equation solution and the analytical </span>
<span class="co"># solution is small:</span>
<span class="kw">lines</span>(states, states -<span class="st"> </span>exact_policy)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-11-1.png" />
</figure>
<h2 id="using-toolbox">Using toolbox</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">mdp_check</span>(<span class="dt">P =</span> transition, <span class="dt">R =</span> utility)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">out &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(transition, utility, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> Vtmax)</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)
<span class="kw">lines</span>(states, states -<span class="st"> </span>H[out$policy], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-13-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/14/mdptoolbox-ex-2.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/19/gp-nimble-v2.html">Gp Nimble V2</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 19 Jun 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r">  devtools::<span class="kw">install_github</span>(<span class="st">&quot;cboettig/gpmanagement&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;gpmanagement&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">set.seed</span>(<span class="dv">1234</span>)
  Tobs &lt;-<span class="st"> </span><span class="dv">40</span>
  f &lt;-<span class="st"> </span>function (x, h, p){
    <span class="kw">sapply</span>(x, function(x) {
        x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
        x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
    })
  }
  p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">5</span>)
  sigma_g &lt;-<span class="st"> </span><span class="fl">0.05</span>
  z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_g)
  x &lt;-<span class="st"> </span><span class="kw">numeric</span>(Tobs)
  x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">5.5</span>
  for(t in <span class="dv">1</span>:(Tobs<span class="dv">-1</span>))
    x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">h=</span><span class="dv">0</span>, <span class="dt">p=</span>p)
  obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          <span class="kw">pmax</span>(<span class="kw">rep</span>(<span class="dv">0</span>,Tobs<span class="dv">-1</span>), x[<span class="dv">1</span>:(Tobs<span class="dv">-1</span>)])), 
                    <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">0</span>, 
                          x[<span class="dv">2</span>:Tobs]))
  xObs &lt;-<span class="st"> </span>obs$x
  yObs &lt;-<span class="st"> </span>obs$y
  xPred &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dt">length=</span><span class="dv">50</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  fit &lt;-<span class="st"> </span><span class="kw">gp_setup</span>(xObs, yObs, xPred)</code></pre>
<pre><code>[1] RW_block sampler: rho, sigGP, sigOE,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 200,  scale: 1,  propCov: identity</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  Cmcmc &lt;-<span class="st"> </span>fit$Cmcmc 
  Cpred &lt;-<span class="st"> </span>fit$Cpred
  Cmodel &lt;-<span class="st"> </span>fit$Cmodel
  
  <span class="kw">system.time</span>(Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
 23.120   0.016  23.167 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">  samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(Cmcmc$mvSamples)
  ## basic sanity check
  testthat::<span class="kw">expect_identical</span>(Cmodel$<span class="kw">getNodeNames</span>(<span class="dt">topOnly =</span> <span class="ot">TRUE</span>), <span class="kw">colnames</span>(samples))</code></pre>
<p>predict from GP model using posterior MCMC samples</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
 28.630   0.004  28.642 </code></pre>
<p>extract predictions: E and C</p>
<pre class="sourceCode r"><code class="sourceCode r">  E &lt;-<span class="st"> </span>Cpred$<span class="kw">getE</span>()
  C &lt;-<span class="st"> </span>Cpred$<span class="kw">getC</span>()
  
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xObs, <span class="dt">y =</span> yObs)
pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">y =</span> E, <span class="dt">ymin =</span> E -<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)), <span class="dt">ymax =</span> E +<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)))
ggplot2::<span class="kw">ggplot</span>(pred) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x,<span class="dt">y =</span> y, <span class="dt">ymin =</span> ymin, <span class="dt">ymax =</span> ymax), <span class="dt">fill =</span> <span class="st">&quot;grey80&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">size=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> obs, <span class="kw">aes</span>(x,y)) +
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(<span class="kw">c</span>(xObs, xPred)), <span class="dt">ylim =</span> <span class="kw">range</span>(<span class="kw">c</span>(yObs,E))) +
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-19-gp-nimble-v2/unnamed-chunk-7-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/19/gp-nimble-v2.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/18/RAM-explore.html">Further exploration of RAM Legacy Stock Assessment data</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 18 Jun 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>({
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;RPostgreSQL&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;devtools&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)
})

## Perform this in data_raw to keep package dependencies minimal
mydb &lt;-<span class="st"> </span><span class="kw">src_postgres</span>(<span class="dt">dbname =</span> <span class="st">&quot;srdb&quot;</span>, 
                     <span class="dt">host=</span><span class="st">&quot;nautilus-vm.mathstat.dal.ca&quot;</span>, 
                     <span class="dt">user =</span> <span class="st">&quot;srdbuser&quot;</span>, 
                     <span class="dt">password =</span>  <span class="st">&quot;srd6us3r!&quot;</span>, 
                     <span class="dt">port =</span> <span class="dv">5432</span>)

timeseries &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries&quot;</span>)))
values &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_values_view&quot;</span>)))
units &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_units_view&quot;</span>)))
assessment &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessment&quot;</span>)))
area &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.area&quot;</span>)))
stock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.stock&quot;</span>)))
method &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessmethod&quot;</span>)))
assessor &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessor&quot;</span>)))
management  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.management&quot;</span>)))
taxonomy &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.taxonomy&quot;</span>)))
lmerefs &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmerefs&quot;</span>)))
lmestock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmetostocks&quot;</span>)))
biometrics  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.biometrics&quot;</span>)))
bioparams &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.bioparams&quot;</span>)))
tsmetrics &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.tsmetrics&quot;</span>)))</code></pre>
<h2 id="north-atlantic-cod-data">North Atlantic Cod data</h2>
<p>Select North Atlantic Cod, <em>Gadus morhua</em>:</p>
<pre class="sourceCode r"><code class="sourceCode r">cod_ids &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(scientificname==<span class="st">&quot;Gadus morhua&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span></code></pre>
<p>(Note we could have selected on the <code>tsn==164712</code> to be less ambiguous but also less semantic, or on <code>commonname==&quot;Atlantic cod&quot;</code> to be more reader friendly but even more ambiguous. Fortunately the common and scientific names are well aligned with the <code>tsn</code> ids in this case and we get the same set of 22 stock assessments.)</p>
<p>Before we can combine across these, we must verify that each assessment measures the quantities of interest using the same units, or otherwise correct those that do not:</p>
<pre class="sourceCode r"><code class="sourceCode r">units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, catch_landings_unit) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(catch_landings_unit) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="kw">length</span>(catch_landings_unit))</code></pre>
<pre><code>Source: local data frame [1 x 2]

  catch_landings_unit length(catch_landings_unit)
1                  MT                          21</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, total_unit) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(total_unit) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="kw">length</span>(total_unit))</code></pre>
<pre><code>Source: local data frame [3 x 2]

  total_unit length(total_unit)
1        E03                  1
2         MT                 18
3         NA                  2</code></pre>
<p>All catches are in metric tons, so no concern there.</p>
<p>Landing data we can plot immediately:</p>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">catch =</span> <span class="kw">sum</span>(catch_landings, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## all units are metric tons
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, catch)) +<span class="st"> </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Catch/Landings (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-4-1.png" />
</figure>
<p>Note that missing data is removed, such that any assessment without catch data is treated as zero catch. This could be the case (maybe not all assessments correspond to unique catch zones.) We also assume catch reported in one assessment is not also reported in a different assement (e.g. no double-counting). Lastly, we must bear in mind that this is catch/landings data, which may include bycatch, underreporting, etc.</p>
<hr />
<h2 id="handling-unit-conversions">Handling unit conversions</h2>
<p>The units for <code>total</code> are more problematic. The <code>NA</code> simply indicates stocks that do not have the an estimate for <code>total</code>, but we also see one assessment has totals in <code>E03</code> (thousands) instead of metric tons.</p>
<hr />
<p><em>Sidebar</em> how do we know for sure that <code>E03</code> is abundance counts in thousands of fish?</p>
<p>The database does not provide metadata for these unit definitions directly. the <code>values</code> data and its associated <code>units</code> metadata are actually derived tables from the raw <code>timeseries</code> table and the associated <code>tsmetrics</code> unit metadata, so we would have to dive in there to confirm this interpretation of <code>E03</code> in this case.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># tidy up the tsmetrics table:</span>
unit_defs &lt;-<span class="st"> </span>tsmetrics %&gt;%<span class="st"> </span><span class="kw">rename</span>(<span class="dt">tsid =</span> tsunique) %&gt;%<span class="st"> </span><span class="kw">select</span>(tsid, tslong, tsunitslong) 

<span class="co"># Find the assessid of the cod stock assessment that measures total in units of E03</span>
who &lt;-<span class="st"> </span>units %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, total_unit) %&gt;%<span class="st"> </span><span class="kw">filter</span>(total_unit==<span class="st">&quot;E03&quot;</span>)

<span class="co"># Find that assessid in the timeseries table, where units are written in different notation</span>
ts_who &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>who$assessid) %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, tsid) %&gt;%<span class="st">  </span><span class="kw">distinct</span>(tsid)

<span class="co"># Join the tables to see the definitions</span>
<span class="kw">left_join</span>(ts_who, unit_defs)</code></pre>
<pre><code>Source: local data frame [5 x 4]

                      assessid   tsid
1 NAFO-SC-COD3M-1959-2008-BAUM SSB-MT
2 NAFO-SC-COD3M-1959-2008-BAUM TN-E03
3 NAFO-SC-COD3M-1959-2008-BAUM  R-E03
4 NAFO-SC-COD3M-1959-2008-BAUM  F-1/T
5 NAFO-SC-COD3M-1959-2008-BAUM  TC-MT
Variables not shown: tslong (chr), tsunitslong (chr)</code></pre>
<p>and we can confirm <code>E03</code> is in this case <code>TN-E03</code> (total number, in thousands).</p>
<hr />
<p>Converting this to metric tons will require an average weight for cod. FishBase gives us a maximum weight (in grams):</p>
<pre class="sourceCode r"><code class="sourceCode r">rfishbase::<span class="kw">species</span>(<span class="st">&quot;Gadus morhua&quot;</span>, <span class="dt">fields=</span><span class="st">&quot;Weight&quot;</span>)</code></pre>
<pre><code>Error in loadNamespace(name): there is no package called &#39;rfishbase&#39;</code></pre>
<p>Wikipedia says the average is 5-12 kilograms, so let’s take 8.5 Kg for sake of argument. Clearly a more programmatic and more accurate solution is needed here.</p>
<p><em>Sidenote</em> the database has some very limited data on biometrics by assessment, including some assessments that record a maximum (but not an average) weight (sometimes pulled from FishBase anyway). Even pooling across all Atlantic Cod assessments we can’t find even a maximum weight.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Find the unit code for max weight</span>
biometrics %&gt;%<span class="st"> </span><span class="kw">filter</span>(biolong ==<span class="st"> &quot;Maximum weight&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(biounique) %&gt;%<span class="st"> </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() -&gt;<span class="st"> </span>max_weight
<span class="co"># show the unit code:</span>
max_weight</code></pre>
<pre><code>[1] &quot;MAX-WGT-g&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Look up all max weight values for illustration: (not filtering on cod_ids since there are no hits)</span>
bioparams %&gt;%<span class="st"> </span><span class="kw">filter</span>(bioid %in%<span class="st"> </span>max_weight)</code></pre>
<pre><code>Source: local data frame [17 x 5]

                                  assessid     bioid  biovalue
1      INIDEP-ARGANCHOSARG-1992-2007-Parma MAX-WGT-g        51
2      INIDEP-ARGANCHONARG-1989-2007-Parma MAX-WGT-g        48
3       INIDEP-ARGHAKESARG-1985-2008-Parma MAX-WGT-g   5300.00
4       INIDEP-ARGHAKENARG-1985-2007-Parma MAX-WGT-g   5900.00
5  INIDEP-PATGRENADIERSARG-1983-2006-Parma MAX-WGT-g      2940
6            ICCAT-ALBANATL-1929-2005-WORM MAX-WGT-g     60000
7         ICCAT-ATBTUNAEATL-1969-2007-WORM MAX-WGT-g    684000
8         ICCAT-ATBTUNAWATL-1969-2007-WORM MAX-WGT-g    684000
9   AFSC-SABLEFEBSAIGA-1956-2008-MELNYCHUK MAX-WGT-g      6200
10           IPHC-PHALNPAC-1988-2009-Parma MAX-WGT-g available
11     AFSC-REYEROCKBSAI-1974-2009-STANTON MAX-WGT-g      2047
12            NEFSC-ATHAL5YZ-1800-2007-COL MAX-WGT-g    337000
13     NEFSC-SCUPNWATLC-1960-2007-TERCEIRO MAX-WGT-g      3000
14     NEFSC-MONKGOMNGB-1964-2006-RICHARDS MAX-WGT-g    337000
15      NEFSC-SURFMATLC-1965-2008-JACOBSON MAX-WGT-g      600+
16   CSERG-ANCHOVYKILKACS-1991-2007-JENSEN MAX-WGT-g      18.4
17        ASMFC-PANDALGOM-1960-2009-IDOINE MAX-WGT-g        23
Variables not shown: bioyear (chr), bionotes (chr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">e03_to_MT &lt;-<span class="st"> </span><span class="fl">7.5</span> *<span class="st"> </span><span class="fl">1e-3</span>

tmpA &lt;-<span class="st"> </span>
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>who$assessid) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_mt =</span> total *<span class="st"> </span>e03_to_MT)

everyone_else &lt;-<span class="st"> </span>cod_ids[!(cod_ids %in%<span class="st"> </span>who$assessid)]
tmpB &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>everyone_else) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_mt =</span> total)

std_values &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(tmpA,tmpB)</code></pre>
<p>(Not sure if there is a more consise way to change the values in a given column for a subset of the rows). Well, perhaps it would be simpler to treat non-standard units as missing data, but at least this illustrates a mechanism for handling the conversion.</p>
<pre class="sourceCode r"><code class="sourceCode r">biomass &lt;-
<span class="st">  </span>std_values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total_mt, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

biomass_dropped &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>everyone_else) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

biomass_wrong &lt;-
<span class="st">  </span>values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsyear) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">biomass =</span> <span class="kw">sum</span>(total, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>## WARNING -- should check units!
<span class="st">  </span><span class="kw">filter</span>(biomass &gt;<span class="st"> </span><span class="dv">0</span>) 

<span class="kw">ggplot</span>(biomass, <span class="kw">aes</span>(tsyear, biomass)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>biomass_wrong, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>biomass_dropped, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Biomass (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)
  
<span class="co"># they may look identical but they aren&#39;t:</span>
<span class="kw">identical</span>(biomass_dropped$biomass, biomass$biomass)</code></pre>
<pre><code>[1] FALSE</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-9-1.png" />
</figure>
<p>In this case, the contribution is negligible (red vs black). Even failing to convert units (blue) makes a hardly visible difference, though in general the difference could have been quite large.</p>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids, total &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total, <span class="dt">color=</span>assessid)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Biomass (MT)&quot;</span>) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-10-1.png" />
</figure>
<hr />
<h2 id="stock-recruitment-time-series">Stock-recruitment &amp; time-series</h2>
<pre class="sourceCode r"><code class="sourceCode r">values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids[[<span class="dv">1</span>]]) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span><span class="kw">geom_point</span>()
values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid==<span class="st">&quot;AFWG-CODNEAR-1943-2006-MINTO&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span><span class="kw">geom_point</span>()

values %&gt;%
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)


values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>cod_ids) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-2.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-3.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-11-4.png" /></p>
<p>Note that the spawning stock biomass, red, can often be significantly less than the total stock (black).</p>
<pre class="sourceCode r"><code class="sourceCode r">herring &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Herring&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>herring) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>herring) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-12-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-12-2.png" /></p>
<pre class="sourceCode r"><code class="sourceCode r">anchovy &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Anchovy&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>anchovy) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>anchovy) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-13-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-13-2.png" /></p>
<pre class="sourceCode r"><code class="sourceCode r">bluefin &lt;-
<span class="st">  </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(commonname==<span class="st">&quot;Atlantic bluefin tuna&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">unlist</span>() %&gt;%<span class="st"> </span><span class="kw">unname</span>() <span class="co"># we need a char string, not a data.frame</span>

values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>bluefin) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(r), !<span class="kw">is.na</span>(ssb)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(ssb, r)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)


values %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid %in%<span class="st"> </span>bluefin) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(total)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, total)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(tsyear, ssb), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +
<span class="st">    </span><span class="kw">facet_wrap</span>(~assessid, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<p><img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-14-1.png" /> <img src="/2015/assets/figures/posts/2015-06-18-RAM-explore/unnamed-chunk-14-2.png" /></p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/18/RAM-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/06/16/daniel-gp-example.html">Daniel Gp Example</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 16 Jun 2015</p>

<article>
<div class="excerpt">
<h3 id="setup">Setup</h3>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&#39;nimble-dev/nimble/packages/nimble@devel&#39;</span>)</code></pre>
<pre><code>Error in download(dest, src, auth): client error: (403) Forbidden</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(nimble)
<span class="kw">set.seed</span>(<span class="dv">0</span>)</code></pre>
<p>Randomly generate some sinusoidal data</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">100</span>
y &lt;-<span class="st"> </span><span class="kw">sin</span>(x/<span class="dv">5</span>) +<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>, <span class="fl">0.1</span>)
ind &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">sample</span>(<span class="dv">1</span>:<span class="dv">100</span>, <span class="dv">40</span>))</code></pre>
<p>The next three lines are the only inputs required.</p>
<pre class="sourceCode r"><code class="sourceCode r">xObs &lt;-<span class="st"> </span>x[ind]                ## input
yObs &lt;-<span class="st"> </span>y[ind]                ## input
xPred &lt;-<span class="st"> </span><span class="kw">c</span>(x, <span class="dv">101</span>:<span class="dv">120</span>)        ## input</code></pre>
<p>Some initial processing</p>
<pre class="sourceCode r"><code class="sourceCode r">nObs &lt;-<span class="st"> </span><span class="kw">length</span>(xObs)
nPred &lt;-<span class="st"> </span><span class="kw">length</span>(xPred)
f &lt;-<span class="st"> </span>function(xi, xj) (xi-xj)^<span class="dv">2</span>
diffOO &lt;-<span class="st"> </span><span class="kw">outer</span>(xObs,  xObs,  f)
diffPP &lt;-<span class="st"> </span><span class="kw">outer</span>(xPred, xPred, f)
diffPO &lt;-<span class="st"> </span><span class="kw">outer</span>(xPred, xObs,  f)</code></pre>
<h3 id="nimble-function-for-gp-prediction">NIMBLE function for GP prediction</h3>
<p>Here’s the main function for doing the prediction from the GP model.</p>
<p>It takes the MCMC samples as a <em>runtime</em> argument, so this can be iterated with running the MCMC for different numbers of iterations, initial values, or even different datasets!</p>
<pre class="sourceCode r"><code class="sourceCode r">gpPred &lt;-<span class="st"> </span><span class="kw">nimbleFunction</span>(
    <span class="dt">setup =</span> function(model, params) {
        calcNodes &lt;-<span class="st"> </span>model$<span class="kw">getDependencies</span>(params, <span class="dt">determOnly =</span> <span class="ot">TRUE</span>)
        nPred &lt;-<span class="st"> </span><span class="kw">dim</span>(model$SigPP)[<span class="dv">1</span>]
        E &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(nPred, <span class="dv">1</span>))
        C &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(nPred, nPred))
    },
    <span class="dt">run =</span> function(<span class="dt">samples =</span> <span class="kw">double</span>(<span class="dv">2</span>)) {
        E &lt;&lt;-<span class="st"> </span>E *<span class="st"> </span><span class="dv">0</span>
        C &lt;&lt;-<span class="st"> </span>C *<span class="st"> </span><span class="dv">0</span>
        nSamples &lt;-<span class="st"> </span><span class="kw">dim</span>(samples)[<span class="dv">1</span>]
        for(i in <span class="dv">1</span>:nSamples) {
            <span class="kw">values</span>(model, params) &lt;&lt;-<span class="st"> </span>samples[i,]
            <span class="kw">calculate</span>(model, calcNodes)
            intermediate &lt;-<span class="st"> </span>model$SigPO %*%<span class="st"> </span><span class="kw">inverse</span>(model$SigOO)
            Etemp &lt;-<span class="st"> </span>intermediate %*%<span class="st"> </span><span class="kw">asCol</span>(model$yObs)
            Ctemp &lt;-<span class="st"> </span>model$SigPP -<span class="st"> </span>intermediate %*%<span class="st"> </span><span class="kw">t</span>(model$SigPO)
            E &lt;&lt;-<span class="st"> </span>E +<span class="st"> </span>Etemp
            C &lt;&lt;-<span class="st"> </span>C +<span class="st"> </span>Ctemp
        }
        E &lt;&lt;-<span class="st"> </span>E /<span class="st"> </span>nSamples
        C &lt;&lt;-<span class="st"> </span>C /<span class="st"> </span>nSamples
    },
    <span class="dt">methods =</span> <span class="kw">list</span>(
        <span class="dt">getE =</span> function() { <span class="kw">returnType</span>(<span class="kw">double</span>(<span class="dv">1</span>)); <span class="kw">return</span>(E[,<span class="dv">1</span>]) },
        <span class="dt">getC =</span> function() { <span class="kw">returnType</span>(<span class="kw">double</span>(<span class="dv">2</span>)); <span class="kw">return</span>(C[, ]) }
    )
)</code></pre>
<h3 id="gp-model">GP model</h3>
<p>GP model defined here. Basically the same as your original, but I renamed some paramters more to my liking =)</p>
<p>This is <em>not</em> as elegant as I had hoped. It still requires repeating (essentially) the same code three times. I discovered some limitations of NIMBLE while trying other approaches.</p>
<p>Bottom line:<br />- This achieves relatively nice simplicity.<br />- There’s an efficiency hit to the MCMC sampling, but it doesn’t seem too bad.<br />- This works.</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   rho ~<span class="st"> </span><span class="kw">dgamma</span>(<span class="dv">10</span>, <span class="dv">1</span>)
   sigGP ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
   sigOE ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
   SigOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ]/rho^<span class="dv">2</span>) +<span class="st"> </span>sigOE^<span class="dv">2</span>*IOO[<span class="dv">1</span>:nObs, <span class="dv">1</span>:nObs ]
   SigPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred]/rho^<span class="dv">2</span>) +<span class="st"> </span>sigOE^<span class="dv">2</span>*IPP[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nPred]
   SigPO[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nObs ] &lt;-<span class="st"> </span>sigGP^<span class="dv">2</span>*<span class="kw">exp</span>(-<span class="dv">1</span>/<span class="dv">2</span>*diffPO[<span class="dv">1</span>:nPred,<span class="dv">1</span>:nObs ]/rho^<span class="dv">2</span>)
   yObs[<span class="dv">1</span>:nObs] ~<span class="st"> </span><span class="kw">dmnorm</span>(mu[<span class="dv">1</span>:nObs], <span class="dt">cov =</span> SigOO[<span class="dv">1</span>:nObs,<span class="dv">1</span>:nObs])
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">nObs=</span>nObs, <span class="dt">nPred=</span>nPred, <span class="dt">diffOO=</span>diffOO, <span class="dt">diffPP=</span>diffPP, <span class="dt">diffPO=</span>diffPO,
                  <span class="dt">IOO=</span><span class="kw">diag</span>(nObs), <span class="dt">IPP=</span><span class="kw">diag</span>(nPred), <span class="dt">mu=</span><span class="kw">rep</span>(<span class="dv">0</span>,nObs))

data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">yObs =</span> yObs)

inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rho =</span> <span class="dv">1</span>, <span class="dt">sigGP =</span> <span class="dv">1</span>, <span class="dt">sigOE =</span> <span class="dv">1</span>)

Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(code, constants, data, inits)</code></pre>
<h3 id="create-compile-and-run">Create, compile, and run</h3>
<pre class="sourceCode r"><code class="sourceCode r">## MCMC specification with no samplers
spec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">nodes =</span> <span class="ot">NULL</span>)

## this will be used for some checking, and setting up block sampler:
params &lt;-<span class="st"> </span>Rmodel$<span class="kw">getNodeNames</span>(<span class="dt">topOnly =</span> <span class="ot">TRUE</span>)

## NOTE: the next line shouldn&#39;t work for you, since the MCMC API has changed.
## you can rebuild from source off nimble branch &#39;devel&#39;.
## otherwise, using last public release of NIMBLE (0.3-1), use this line instead:
## spec$addSampler(&#39;RW_block&#39;, control = list(targetNodes = params))
spec$<span class="kw">addSampler</span>(params, <span class="st">&#39;RW_block&#39;</span>)</code></pre>
<pre><code>[1] RW_block sampler: rho, sigGP, sigOE,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 200,  scale: 1,  propCov: identity</code></pre>
<p>We can debate about univariate vs. block sampling at some point.</p>
<pre class="sourceCode r"><code class="sourceCode r">## MCMC function
Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(spec)

## GP prediction function
## also uses the &#39;params&#39; variable for specialization
Rpred &lt;-<span class="st"> </span><span class="kw">gpPred</span>(Rmodel, params)

## compile everything
Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
Cmcmc  &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Rmodel)
Cpred  &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rpred, <span class="dt">project =</span> Rmodel)

## MCMC sampling
## 100,000 iterations
<span class="kw">system.time</span>(Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
 67.646   0.043  67.841 </code></pre>
<p>About 25 seconds on my computer</p>
<p>That can be improved if necessary</p>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(Cmcmc$mvSamples)

## quick check
if(!<span class="kw">identical</span>(params, <span class="kw">colnames</span>(samples))) <span class="kw">stop</span>(<span class="st">&#39;problem&#39;</span>)

## predict from GP model using posterior MCMC samples
<span class="kw">system.time</span>(Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
 86.798   0.005  86.948 </code></pre>
<p>About 40 seconds on my computer</p>
<p>Again, could streamline the gpPred() function if necessary</p>
<pre class="sourceCode r"><code class="sourceCode r">## extract predictions: E and C
E &lt;-<span class="st"> </span>Cpred$<span class="kw">getE</span>()
C &lt;-<span class="st"> </span>Cpred$<span class="kw">getC</span>()</code></pre>
<h3 id="output">Output</h3>
<pre class="sourceCode r"><code class="sourceCode r">E</code></pre>
<pre><code>  [1]  1.048953470  1.063690923  1.056571565  1.025025296  0.967727602
  [6]  0.885088092  0.779046134  0.652750089  0.510403944  0.357145489
 [11]  0.198827230  0.041501513 -0.109026506 -0.247533773 -0.369716151
 [16] -0.472313950 -0.553105378 -0.610874554 -0.645461105 -0.657719603
 [21] -0.649076810 -0.621198765 -0.575868588 -0.514737033 -0.439105417
 [26] -0.349971602 -0.248371381 -0.135451833 -0.012707283  0.117353661
 [31]  0.251084159  0.383920114  0.510567530  0.625303732  0.722419735
 [36]  0.796925448  0.845259818  0.865448082  0.857113606  0.821872152
 [41]  0.763535592  0.687360014  0.599297100  0.505480001  0.411259520
 [46]  0.320288380  0.234175561  0.152695050  0.074286902 -0.003167262
 [51] -0.081466127 -0.161638385 -0.243673849 -0.325876291 -0.404833854
 [56] -0.476477835 -0.536583186 -0.580993801 -0.606153844 -0.609554981
 [61] -0.590206477 -0.548974521 -0.488316837 -0.411928777 -0.324540013
 [66] -0.231641132 -0.139114920 -0.052860394  0.021550784  0.079331411
 [71]  0.117042000  0.132978712  0.127078948  0.100689033  0.056355647
 [76] -0.002485485 -0.071873133 -0.147591543 -0.225248038 -0.300383786
 [81] -0.368679284 -0.425886710 -0.467685571 -0.489815787 -0.488669528
 [86] -0.462038368 -0.409587331 -0.332776473 -0.234523765 -0.119090537
 [91]  0.008395849  0.142692615  0.278921123  0.412628846  0.539726698
 [96]  0.656454950  0.759426449  0.845730518  0.912939607  0.959256645
[101]  0.984015990  0.987978885  0.972988593  0.941606557  0.896909969
[106]  0.842215301  0.780777080  0.715559458  0.649099436  0.583448236
[111]  0.520171088  0.460385520  0.404821033  0.353887176  0.307741235
[116]  0.266350221  0.229544512  0.197062243  0.168584714  0.143763668</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">diag</span>(C)</code></pre>
<pre><code>  [1] 1.2679882 1.2064883 1.1541432 1.1116728 1.0784248 1.0524884
  [7] 1.0317576 1.0147224 1.0007923 0.9900904 0.9827438 0.9787769
 [13] 0.9777564 0.9783522 0.9785871 0.9766328 0.9714366 0.9630053
 [19] 0.9522229 0.9402332 0.9284669 0.9183767 0.9109672 0.9068412
 [25] 0.9062843 0.9093517 0.9158928 0.9254797 0.9372421 0.9497874
 [31] 0.9614992 0.9705821 0.9757483 0.9766685 0.9740220 0.9691475
 [37] 0.9633160 0.9577090 0.9532083 0.9500621 0.9480639 0.9471172
 [43] 0.9473233 0.9485876 0.9506984 0.9530274 0.9546481 0.9549896
 [49] 0.9542985 0.9535398 0.9539394 0.9568409 0.9630692 0.9727686
 [55] 0.9850166 0.9979048 1.0093360 1.0177498 1.0224490 1.0235779
 [61] 1.0216894 1.0172186 1.0108482 1.0037543 0.9975825 0.9940451
 [67] 0.9942810 0.9988192 1.0071728 1.0181157 1.0297591 1.0394083
 [73] 1.0443944 1.0429170 1.0346484 1.0209019 1.0041130 0.9869394
 [79] 0.9713413 0.9580174 0.9466908 0.9370265 0.9291060 0.9233148
 [85] 0.9204774 0.9213396 0.9262437 0.9349512 0.9465634 0.9595347
 [91] 0.9721773 0.9829212 0.9902883 0.9935894 0.9933386 0.9913798
 [97] 0.9906718 0.9946403 1.0070336 1.0312845 1.0694759 1.1218007
[103] 1.1866870 1.2612294 1.3418003 1.4247225 1.5067538 1.5853383
[109] 1.6586720 1.7256456 1.7857277 1.8388290 1.8851737 1.9251909
[115] 1.9594282 1.9884878 2.0129814 2.0334994 2.0505931 2.0647637</code></pre>
<p>Black dots are the original ‘xObs’ and ‘yObs’</p>
<p>Red dots are the predictions made at each ‘xPred’</p>
<p>Red lines are plus/minus one standard error</p>
<figure>
<img src="/2015/assets/figures/posts/2015-06-16-daniel-gp-example/unnamed-chunk-13-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/06/16/daniel-gp-example.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/05/15/diagrammer.html">Diagrammer</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 15 May 2015</p>

<article>
<div class="excerpt">
<p>Exploring ways for using <code>DiagrammeR</code> to generate graphs/plots that can be exported to svg and included in knitr documents.</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;rich-iannone/DiagrammeR&quot;</span>)</code></pre>
<pre><code>Error in download(dest, src, auth): client error: (403) Forbidden</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;DiagrammeR&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;archive&quot;</span>, <span class="st">&quot;index&quot;</span>, <span class="st">&quot;share&quot;</span>, <span class="st">&quot;discover&quot;</span>, <span class="st">&quot;use&quot;</span>, <span class="st">&quot;attribute&quot;</span>)

nodes &lt;-<span class="st"> </span><span class="kw">create_nodes</span>(<span class="dt">nodes =</span> <span class="kw">c</span>(<span class="st">&quot;Repository</span><span class="ch">\n</span><span class="st"> Roles&quot;</span>, n, <span class="st">&quot;Researcher</span><span class="ch">\n</span><span class="st"> Roles&quot;</span>), 
                      <span class="dt">shape =</span> <span class="st">&quot;circle&quot;</span>, 
                      <span class="dt">color =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;PowderBlue&quot;</span>, <span class="dv">4</span>), <span class="kw">rep</span>(<span class="st">&quot;Linen&quot;</span>, <span class="dv">4</span>)),
                      <span class="dt">style =</span> <span class="st">&quot;filled&quot;</span>)
edges &lt;-<span class="st"> </span><span class="kw">create_edges</span>(<span class="dt">from =</span> n, 
                      <span class="dt">to =</span> <span class="kw">c</span>(n[-<span class="dv">1</span>], n[<span class="dv">1</span>]),
                      <span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>, <span class="dt">penwidth =</span> <span class="dv">4</span>)

graph &lt;-<span class="st"> </span><span class="kw">create_graph</span>(<span class="dt">nodes =</span> nodes, <span class="dt">edges =</span> edges, 
                      <span class="dt">graph_attrs =</span> <span class="kw">c</span>(<span class="st">&quot;layout = circo&quot;</span>))
out &lt;-<span class="st"> </span><span class="kw">render_graph</span>(graph)</code></pre>
<p>Render as SVG</p>
<pre class="sourceCode r"><code class="sourceCode r">basename &lt;-<span class="st"> &quot;figure1&quot;</span>
out &lt;-<span class="st"> </span><span class="kw">render_graph</span>(graph, <span class="dt">output =</span> <span class="st">&quot;SVG&quot;</span>)
<span class="kw">writeLines</span>(out, <span class="kw">paste0</span>(basename, <span class="st">&quot;.svg&quot;</span>))</code></pre>
<p>Render as pdf, for inculsion in pdf/tex files.</p>
<pre class="sourceCode r"><code class="sourceCode r">## Not Run
<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&quot;inkscape --export-png &quot;</span>, basename, <span class="st">&quot;.png&quot;</span>, 
<span class="co">#              &quot;-w &quot;, width, &quot; -h &quot;, height, </span>
              <span class="st">&quot; --export-dpi 300 &quot;</span>, 
              basename, <span class="st">&quot;.svg&quot;</span>)) 

<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&quot;inkscape --export-pdf &quot;</span>, basename, <span class="st">&quot;.pdf &quot;</span>, basename, <span class="st">&quot;.svg&quot;</span>)) </code></pre>
<p>Embed in post? maybe? This could be more elegant:</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw">paste0</span>(basename, <span class="st">&quot;.svg&quot;</span>)
target &lt;-<span class="st"> </span><span class="kw">paste0</span>(knitr::opts_chunk$<span class="kw">get</span>(<span class="st">&quot;fig.path&quot;</span>), f)
<span class="kw">file.rename</span>(f, target)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste0</span>(<span class="st">&quot;![](&quot;</span>, target, <span class="st">&quot;)&quot;</span>)</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/05/15/diagrammer.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/05/08/ram-legacy-database-explore.html">Ram Legacy Database Explore</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 08 May 2015</p>

<article>
<div class="excerpt">
<h2 id="accessing-the-database">Accessing the database</h2>
<p>Connect to the database (connection info is <a href="http://ramlegacy.marinebiodiversity.ca/ram-legacy-stock-assessment-database/accessing-the-live-database">public</a>), works fine:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;RPostgreSQL&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mydb &lt;-<span class="st"> </span><span class="kw">src_postgres</span>(<span class="dt">dbname =</span> <span class="st">&quot;srdb&quot;</span>, 
                     <span class="dt">host=</span><span class="st">&quot;nautilus-vm.mathstat.dal.ca&quot;</span>, 
                     <span class="dt">user =</span> <span class="st">&quot;srdbuser&quot;</span>, 
                     <span class="dt">password =</span>  <span class="st">&quot;srd6us3r!&quot;</span>, 
                     <span class="dt">port =</span> <span class="dv">5432</span>)
mydb</code></pre>
<pre><code>src:  postgres 8.4.10 [srdbuser@nautilus-vm.mathstat.dal.ca:5432/srdb]
tbls: area, assessment, assessmethod, assessor, biometrics,
  bioparams, brptots, fishbasesaupcodes, geometry_columns, lmerefs,
  lmes, lmetostocks, management, mostrecent, recorder, referencedoc,
  reference_point_units_view, reference_point_values_view, risfields,
  risfieldvalues, spatial_ref_sys, stock, taxonomy, timeseries,
  timeseries_units_view, timeseries_values_view, tsmetrics,
  tsrelative_explicit_view</code></pre>
<p>However, the expected mechanism for accessing a complete table seems to fail:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tbl</span>(mydb, <span class="st">&quot;stock&quot;</span>)</code></pre>
<pre><code>Error in postgresqlExecStatement(conn, statement, ...): RS-DBI driver: (could not Retrieve the result : ERROR:  relation &quot;stock&quot; does not exist
LINE 1: SELECT * FROM &quot;stock&quot; WHERE 0=1
                      ^
)</code></pre>
<p>Filed as a bug report in <a href="https://github.com/rstats-db/RPostgres/issues/32">RPostgres/#32</a>.</p>
<p>Meanwhile, direct sql queries work (note we need the full table address, e.g. <code>dbname.tablename</code>.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.stock&quot;</span>))</code></pre>
<pre><code>Source: postgres 8.4.10 [srdbuser@nautilus-vm.mathstat.dal.ca:5432/srdb]
From: &lt;derived table&gt; [?? x 8]

      stockid    tsn scientificname   commonname
1        COD1 164712   Gadus morhua Atlantic cod
2    COD2J3KL 164712   Gadus morhua Atlantic cod
3  COD2J3KLIS 164712   Gadus morhua Atlantic cod
4       COD3M 164712   Gadus morhua Atlantic cod
5      COD3NO 164712   Gadus morhua Atlantic cod
6      COD3Ps 164712   Gadus morhua Atlantic cod
7   COD3Pn4RS 164712   Gadus morhua Atlantic cod
8       COD4T 164712   Gadus morhua Atlantic cod
9     COD4VsW 164712   Gadus morhua Atlantic cod
10    COD4TVn 164712   Gadus morhua Atlantic cod
..        ...    ...            ...          ...
Variables not shown: areaid (chr), stocklong (chr), inmyersdb (int),
  myersstockid (chr)</code></pre>
<p>Since these tables easily fit into memory, it is generally faster to just import them into R rather than leaving <code>dplyr</code> to just work with them remotely. The <code>dplyr::collect()</code> function does this. So we create local copies of each table of interest like so:</p>
<pre class="sourceCode r"><code class="sourceCode r">timeseries &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries&quot;</span>)))
values &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_values_view&quot;</span>)))

units &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.timeseries_units_view&quot;</span>)))
assessment &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessment&quot;</span>)))
area &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.area&quot;</span>)))
stock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.stock&quot;</span>)))
method &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessmethod&quot;</span>)))
assessor &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.assessor&quot;</span>)))
management  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.management&quot;</span>)))
taxonomy &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.taxonomy&quot;</span>)))

lmerefs &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmerefs&quot;</span>)))
lmestock &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.lmetostocks&quot;</span>)))


biometrics  &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.biometrics&quot;</span>)))
bioparams &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.bioparams&quot;</span>)))

tsmetrics &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">tbl</span>(mydb, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM srdb.tsmetrics&quot;</span>)))</code></pre>
<p>Many of the tables contain observations of variables that describe each given assessment (<code>assessid</code>), including the species <code>stock</code> assessed, <code>area</code> assessed, the method used, and so forth. Since these all follow the same schema of a row being a unique stock assessment and a column being an attribute of that assessment, it makes sense to combine this into a single metadata table. (Especially as these datasets fit so easily into memory anyway.)</p>
<pre class="sourceCode r"><code class="sourceCode r">meta &lt;-<span class="st"> </span>assessment %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">methodshort =</span> assessmethod) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(method) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(stock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(area) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(units) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(assessor) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(management) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(taxonomy) </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">all_areas &lt;-<span class="st"> </span>stock %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(stockid, areaid) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(area) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">right_join</span>(lmestock) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(lmerefs)

<span class="kw">sapply</span>(all_areas, function(x) <span class="kw">length</span>(<span class="kw">levels</span>(<span class="kw">factor</span>(x))))</code></pre>
<pre><code>           stockid             areaid            country 
               391                174                 10 
          areatype           areacode           areaname 
                24                167                167 
 alternateareaname         lme_number stocktolmerelation 
                 5                 34                  5 
          lme_name 
                34 </code></pre>
<ul>
<li><code>bioparams</code>: Fixed parameter values of a study.</li>
<li><code>biometrics</code>: definitions of said parameters.</li>
</ul>
<p>The column is called <code>biounique</code> in <code>biometrics</code> table but <code>bioid</code> in <code>bioparams</code> table, so we fix that:</p>
<pre class="sourceCode r"><code class="sourceCode r">parameters &lt;-<span class="st"> </span>biometrics %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">bioid =</span> biounique) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(bioparams) </code></pre>
<ul>
<li><code>tsmetrics</code> defines the factor levels and the units used in <code>timeseries</code> <code>tsid</code> column.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">tsmetrics &lt;-<span class="st"> </span>tsmetrics %&gt;%<span class="st"> </span><span class="kw">rename</span>(<span class="dt">tsid =</span> tsunique)</code></pre>
<p>For example, we can see what measurements are available</p>
<pre class="sourceCode r"><code class="sourceCode r">ids &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;NWFSC-COWCODSCAL-1900-2007-BRANCH&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">distinct</span>(tsid) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(tsid)
ids</code></pre>
<pre><code>Source: local data frame [7 x 1]

      tsid
1   SSB-MT
2    R-E03
3   F-1/yr
4    TB-MT
5    TC-MT
6    TL-MT
7 STB1+-MT</code></pre>
<p>Looking up these ids in the <code>tsmetrics</code> table tells us what these seven time series are:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">inner_join</span>(ids, tsmetrics) %&gt;%<span class="st"> </span><span class="kw">select</span>(tsshort, tslong, tsunitsshort, tsunitslong)</code></pre>
<pre><code>Source: local data frame [7 x 4]

  tsshort
1     SSB
2       R
3       F
4      TB
5      TC
6      TL
7   STB1+
Variables not shown: tslong (chr), tsunitsshort (chr), tsunitslong
  (chr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">cowcod &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;NWFSC-COWCODSCAL-1900-2007-BRANCH&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">left_join</span>(tsmetrics) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(tsyear, tsvalue, <span class="dt">col=</span>tsid)) +<span class="st"> </span><span class="kw">geom_line</span>() 
cowcod</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-05-08-ram-legacy-database-explore/unnamed-chunk-12-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">cowcod +<span class="st"> </span><span class="kw">scale_y_log10</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-05-08-ram-legacy-database-explore/unnamed-chunk-13-1.png" />
</figure>
<p>(Note TC (total catch) and TL (total landings) are equivalent in this context, implying neglible discards.)</p>
<p>Unfortunately, there is a lot of heterogeneity in the metrics measured by each assessment: <code>tsmetrics</code> defines 151 units, (though only 93 appear in timeseries)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">unique</span>(tsmetrics$tsid))</code></pre>
<pre><code>[1] 151</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">table</span>(timeseries$tsid))</code></pre>
<pre><code>[1] 93</code></pre>
<p>Most are variations differing only by units, as we see from the most commonly used metrics:</p>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs &lt;-<span class="st"> </span>
timeseries %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(tsid) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(assessid) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">occurs =</span> <span class="kw">n</span>()) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(tsmetrics) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(occurs)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(tsid, tslong, tsunitsshort, occurs)
unit_occurs</code></pre>
<pre><code>Source: local data frame [93 x 4]

                      tsid
1                    TB-MT
2                   SSB-MT
3                    R-E03
4                    TC-MT
5                    TL-MT
6                    F-1/T
7                   F-1/yr
8                 ER-ratio
9  Yield-SSB-dimensionless
10                 YEAR-yr
..                     ...
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<p>These are all variations of the same several variables, but measured in different units. For instance, we see many series use a catch to biomass ratio (ER) instead of a fishing mortality.</p>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;^SSB&quot;</span>, tsid))</code></pre>
<pre><code>Source: local data frame [12 x 4]

                tsid
1             SSB-MT
2        SSB-E03eggs
3      SSB-STDDEV-MT
4           SSB-1-MT
5           SSB-2-MT
6       SSB-relative
7            SSB-E03
8      SSB-E06larvae
9           SSB-3-MT
10          SSB-4-MT
11     SSB-E03pertow
12 SSB-FemaleGonadMT
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;^R&quot;</span>, tsid))</code></pre>
<pre><code>Source: local data frame [7 x 4]

        tsid
1      R-E03
2    R-1-E03
3    R-2-E03
4       R-MT
5 R-relative
6    R-3-E03
7    R-4-E03
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;^TC&quot;</span>, tsid))</code></pre>
<pre><code>Source: local data frame [7 x 4]

      tsid
1    TC-MT
2   TC-E03
3   TC-E00
4 TC-1-E03
5  TC-1-MT
6  TC-2-MT
7 TC-2-E03
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;^TL&quot;</span>, tsid))</code></pre>
<pre><code>Source: local data frame [5 x 4]

     tsid
1   TL-MT
2 TL-1-MT
3 TL-2-MT
4 TL-3-MT
5  TL-E00
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">unit_occurs %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;^CPUE&quot;</span>, tsid))</code></pre>
<pre><code>Source: local data frame [10 x 4]

                   tsid
1         CPUE-kgpertow
2       CPUEstand-1-C/E
3       CPUEstand-2-C/E
4         CPUEstand-C/E
5           CPUEraw-C/E
6       CPUEstand-3-C/E
7       CPUEstand-4-C/E
8  CPUEsmooth-E00pertow
9       CPUEstand-5-C/E
10      CPUEstand-6-C/E
Variables not shown: tslong (chr), tsunitsshort (chr), occurs (int)</code></pre>
<p>The <code>values</code> table appears to be derived from the <code>timeseries</code> table, presumably standardizing on consistent metrics(?)</p>
<pre class="sourceCode r"><code class="sourceCode r">values</code></pre>
<pre><code>Source: local data frame [16,308 x 9]

                        assessid tsyear pt_avail       ssb       r
1  ADFG-HERRPWS-1980-2006-COLLIE   1980        5  48270.35  414070
2  ADFG-HERRPWS-1980-2006-COLLIE   1981        5  51090.88  335200
3  ADFG-HERRPWS-1980-2006-COLLIE   1982        5  47402.54  112300
4  ADFG-HERRPWS-1980-2006-COLLIE   1983        5  56449.01  103740
5  ADFG-HERRPWS-1980-2006-COLLIE   1984        5  64461.28 1062360
6  ADFG-HERRPWS-1980-2006-COLLIE   1985        5  79124.61   99630
7  ADFG-HERRPWS-1980-2006-COLLIE   1986        5  65601.06   74880
8  ADFG-HERRPWS-1980-2006-COLLIE   1987        5  70646.42   84820
9  ADFG-HERRPWS-1980-2006-COLLIE   1988        5  93508.20 1006440
10 ADFG-HERRPWS-1980-2006-COLLIE   1989        5 105135.41  119970
..                           ...    ...      ...       ...     ...
Variables not shown: total (dbl), f (dbl), cpue (dbl), catch_landings
  (dbl)</code></pre>
<p>We can see this by transforming our example:</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;NWFSC-COWCODSCAL-1900-2007-BRANCH&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(tsid, tsvalue) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">ssb=</span><span class="st">`</span><span class="dt">SSB-MT</span><span class="st">`</span>, <span class="dt">r =</span> <span class="st">`</span><span class="dt">R-E03</span><span class="st">`</span>, <span class="dt">total =</span> <span class="st">`</span><span class="dt">TB-MT</span><span class="st">`</span>, <span class="dt">f =</span> <span class="st">`</span><span class="dt">F-1/yr</span><span class="st">`</span>, <span class="dt">catch_landings =</span> <span class="st">`</span><span class="dt">TL-MT</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(assessid, tsyear, ssb, r, total, f, catch_landings)</code></pre>
<p>which is indeed identical to corresponding assessment in the <code>values</code> table</p>
<pre class="sourceCode r"><code class="sourceCode r">y &lt;-<span class="st"> </span>values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;NWFSC-COWCODSCAL-1900-2007-BRANCH&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(-pt_avail, -cpue)
<span class="kw">identical</span>(x,y)</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>So what happens when the units differ?</p>
<pre class="sourceCode r"><code class="sourceCode r">timeseries %&gt;%<span class="st"> </span><span class="kw">filter</span>(tsid==<span class="st">&quot;SSB-E03eggs&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">distinct</span>(<span class="st">&quot;assessid&quot;</span>)</code></pre>
<pre><code>Source: local data frame [1 x 5]

                               assessid        tsid tsyear  tsvalue
1 TAFI-TASGIANTCRABTAS-1990-2007-JENSEN SSB-E03eggs   1998 188.9256
Variables not shown: &quot;assessid&quot; (chr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span>timeseries %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;TAFI-TASGIANTCRABTAS-1990-2007-JENSEN&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">spread</span>(tsid, tsvalue) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">ssb=</span><span class="st">`</span><span class="dt">SSB-E03eggs</span><span class="st">`</span>)

y &lt;-<span class="st"> </span>values %&gt;%<span class="st"> </span><span class="kw">filter</span>(assessid ==<span class="st"> &quot;TAFI-TASGIANTCRABTAS-1990-2007-JENSEN&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(ssb)
<span class="kw">identical</span>(x,y)</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>No transformation has been done, hence the units of the <code>values</code> columns vary depending on the assessment id. Nonetheless it is quite useful to have the metrics split into their corresponding 5 types rather than as 93 unique subtypes. As long as we are not comparing magnitudes across different assessments directly though, this should not be an issue.</p>
<hr />
<p>It would probably be useful to reconstruct the code to generate the <code>values</code> table from the timeseries table directly. One might hope that the mappings between <code>tsid</code> values and the five column headings in the <code>values</code> table would be defined in the database, e.g. in perhaps the <code>tscategory</code> column of <code>tsmetrics</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unique</span>(tsmetrics$tscategory)</code></pre>
<pre><code>[1] &quot;FISHING MORTALITY&quot;                                                            
[2] &quot;TOTAL BIOMASS&quot;                                                                
[3] &quot;TIME UNITS&quot;                                                                   
[4] &quot;SPAWNING STOCK BIOMASS or CPUE&quot;                                               
[5] &quot;RECRUITS (NOTE: RECRUITS ARE OFFSET IN TIME SERIES BY THE AGE OF RECRUITMENT)&quot;
[6] &quot;CATCH or LANDINGS&quot;                                                            
[7] &quot;OTHER TIME SERIES DATA&quot;                                                       </code></pre>
<p>but alas this does not quite appear to be the case (e.g. CPUE and SSB are a single category.) Some combination of this information and splitting on the <code>tsid</code> strings would probably suffice.</p>
<hr />
<pre class="sourceCode r"><code class="sourceCode r">ts &lt;-<span class="st"> </span>meta %&gt;%<span class="st"> </span><span class="kw">select</span>(assessid, commonname) %&gt;%<span class="st"> </span><span class="kw">right_join</span>(values)</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/05/08/ram-legacy-database-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/04/28/rfishbase-notes.html">Rfishbase Notes</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 28 Apr 2015</p>

<article>
<div class="excerpt">
<h3 id="kalman-filtering">kalman filtering</h3>
<h3 id="updates-to-drat-repo">updates to drat repo</h3>
<ul>
<li>rescript personal deploy.R script</li>
<li>pull request</li>
</ul>
<h3 id="rfishbase">rfishbase</h3>
<p><code>rfishbase</code> queries from users: getting “Resilience,” “Vulnerability” and “Price Category” data:</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">species_info</span>(<span class="st">&quot;Labroides bicolor&quot;</span>, <span class="dt">fields =</span> <span class="kw">c</span>(<span class="st">&quot;SpecCode&quot;</span>, <span class="st">&quot;Vulnerability&quot;</span>, <span class="st">&quot;PriceCateg&quot;</span>))</code></pre>
<p>It so happens that “Resilience” is not in that table, but in the “stocks” table instead:</p>
<pre class="sourceCode r"><code class="sourceCode r">y &lt;-<span class="st"> </span><span class="kw">stocks</span>(<span class="st">&quot;Labroides bicolor&quot;</span>, <span class="dt">fields=</span><span class="kw">c</span>(<span class="st">&quot;SpecCode&quot;</span>, <span class="st">&quot;Resilience&quot;</span>))</code></pre>
<p>You can now merge the results:</p>
<pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">merge</span>(x,y)</code></pre>
<p>In general, you can see a list of all the columns in a given table by just omitting the “fields” argument:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">species_info</span>(<span class="st">&quot;Labroides bicolor&quot;</span>)</code></pre>
<p>Since the nearly 100 columns don’t fit in the page, the function just summarizes the column names for the ones that don’t fit. You can read through that list and spot the words “Vulnerability” and “PriceCateg”, and then use them in the ‘fields’ argument to just get those results.</p>
<p>Note that all of these functions can take a long list of species names instead of a single species, and thus will return a table with a row for each species and the desired columns.</p>
<p>Also note that we use “SpecCode”, the species code, to identify a species on fishbase. You can use the function “speciesnames” to transform this numeric code into a species name; e.g.</p>
<pre class="sourceCode r"><code class="sourceCode r">data$SpecCode &lt;-<span class="st"> </span><span class="kw">speciesnames</span>(data$SpecCode)</code></pre>
<ul>
<li>Improved sql helper script recipe.</li>
</ul>
<h4 id="searching-sql-for-a-field">searching SQL for a field</h4>
<pre class="sourceCode sql"><code class="sourceCode sql">
<span class="kw">select</span> <span class="kw">distinct</span> table_name <span class="kw">from</span> information_schema.columns <span class="kw">where</span> column_name <span class="kw">in</span> (<span class="st">&#39;Resilience&#39;</span>) <span class="kw">and</span> table_schema=<span class="st">&#39;fbapp&#39;</span>;</code></pre>
<p>and then we can do the usual</p>
<pre class="sourceCode sql"><code class="sourceCode sql">describe stocks</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/04/28/rfishbase-notes.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/04/20/open-science-post-doc.html">Open Science Post Doc</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 20 Apr 2015</p>

<article>
<div class="excerpt">
<p>This post is a response to the query posted by Titus Brown on <a href="http://ivory.idyll.org/blog/2015-how-to-find-openscience-advisor.html">advice for doing an Open Science Post doc</a>.</p>
<p>Open Science is a broad tent, and I believe there are many ways to engage in open science without crossing boundaries of collaborators or PIs. Some of the most valuable open science practices are those least likely to cross boundaries: in particular, those practices associated with post-publication of academic papers. Many widely regarded journals, including <em>Nature</em> and <em>Science</em>, have relatively strong data publication requirements, increasingly strong code publication expectations, and are compatible with the use of pre-print archives. Yes, their are those who would hesitate even to comply with the most minimal interpretation of these expectations; but there are many more who, given the expectation to do this at all, would appreciate your knowledge and effort on doing these things well and consistent with best practices. Using data repositories instead of supplemental material; exhibiting good management of data and code; providing good metadata in consistent formats; citing software and data appropriately.</p>
<p>Many of the practices promoted by open scientists work almost as well in a setting that is closed until you ‘flip the switch’ to make them public; even if that is long after publication. Good data management, a private Github repository, or a private electronic lab notebook are all ways to leverage best practices tools and approaches in a setting that can either be shared securely or made open later. Attitudes to post-publication sharing are rarely black-and-white, and having everything curated and ready to go ahead of time can help nudge collaborators in the direction of best practices.</p>
<p>I’ve been a post-doc for just over 2 years while enjoying a relatively open-science approach to my research: I’ve kept an open lab notebook, posted my papers ahead of publication on pre-print archives, released code, data, and knitr versions of my papers, discuss my work on social media, sign reviews, shared grant applications, contributed open source software and been active in open science communities.</p>
<p>I was fortunate to have independent funding for most but not all of my post-doc, and to work in a field where researchers are often given substantial independence and in which open practices are common. Nonetheless these were not practices shared by either of my two excellent co-advisers, who gave only a neutral or vaguely positive response to these ideas.</p>
<p>Nevertheless, I learned more about <em>old-school</em> open science from them than I had ever imagined. When I sent Marc the first draft of our paper, I had buried almost all of the equations in a curt appendix with minimal and jargon-laden supporting text. No sir, those equations not only had to appear in the main text, but I must endeavor to explain the meaning and relevance of each one in a language clear and concise enough for any ecologist to follow. I won’t claim to have succeeded, but boy did continuous integration on my unit tests feel like a low bar for openness by comparison.</p>
<p>Meanwhile, I also felt I had the support and mentorship of an online community of open scientists even without going to work for one of them. I am thankful that my mentors have always been tolerant of my open science experimentation, but I would have enjoyed working with them even if it had been otherwise. There was much to learn from them, much to learn from the open science community, and after all, a post-doc position doesn’t last forever.</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/04/20/open-science-post-doc.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/04/15/misc-notes-on-cloud-providers.html">Misc Notes On Cloud Providers</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 15 Apr 2015</p>

<article>
<div class="excerpt">
<p><em>ongoing notes comparing computing resources</em></p>
<p>Comparing compute resources:</p>
<ul>
<li><p>AWS EC2, DigitalOcean, and Google Compute Engine look significantly cheaper than Rackspace, Azure, etc. (The Economist has estimated that AWS EC2 prices are roughly 3% <em>below</em> cost).</p></li>
<li><p>DigitalOcean tends to have the lowest price point for on-demand use of a given set of resources; usually comparable to the Amazon or EC2 persistent (e.g. monthly) use. All-inclusive pricing (storage, networking etc) and limited options make choices simple and total costs easy to anticipate, though lack the flexibility to fine-tune a configuration to pay for exactly what you need.</p></li>
<li><p>Google offers the best rate for higher-cpu instances, (e.g. 16 cores); primarily by provisioning them with less memory (0.9 GB/core) than DO or EC2.</p></li>
<li><p>Google configures disk space separately from instance type. Cost of $0.04 per GB for spinning disk storage, is quite a bit cheaper than the ~ $0.10/GB for AWS EBS, and in fact nearly S3 price ~ $0.03. This makes it a potentially compelling platform for high storage, low compute instances.</p></li>
</ul>
<p>Presumably this is non-local storage like EBS, since they also offer a (very expensive) local SSD option (limited to 375 GB increments, each inc at $81.75 / mo). Though if the non-local nature creates a significant latency, it isn’t clear why one would buy non-local SSD option for $0.17/GB.</p>
<h2 id="using-google-compute-engine">Using Google Compute Engine</h2>
<p>Web interface is cleaner but much less flexible than Amazon’s, most tasks must be done with the commandline SDK tool instead, <code>gcloud</code> (such as modifying firewall settings other than port 80 and port 443). For instance, <a href="https://developer.ubuntu.com/en/snappy/start/#snappy-google">this tutorial</a> on running an Ubuntu Snappy Core image instead of the usual defaults.</p>
<p>Docker-machine makes this a bit easier, as usual. The user needs to create a project name and project id on the Google Cloud Engine web interface. Only the project-name is required as an argument to docker-machine (e.g. no authentication token), auth must be done interactively through a web terminal. It doesn’t seem that there is a way to turn on <code>http</code> port or otherwise configure the firewall. By default, all inbound ports are shut. By mapping to port <code>80</code> and checking ‘allow http’ in the web interface one can still access an app like RStudio-server (my mapping docker ports appropriately), but there doesn’t seem to be any way to automate this. (In contrast, with Amazon EC2, docker-machine automatically attaches a ‘security-group’ called <code>docker-machine</code>, so a user can customize the ports permitted on that security group to have, e.g. 8787 open by default.)</p>
<h2 id="performance-comparisons">Performance comparisons</h2>
<p>CPU performance varies within a single provider.</p>
<ul>
<li>DO CPUs appear 2.3 - 2.4 Ghz with ~ 15MB cache,</li>
<li>Google CPUs around 2.6 Ghz with ~ 20MB cache,</li>
<li>Amazon ~ 2.8 Ghz with ~ 25 MB cache</li>
</ul>
<p>network i/o speeds seem reasonable on all.</p>
<hr />
<h2 id="using-resources-with-docker-machine">Using resources with docker-machine</h2>
<p>docker-machine with docker save: after committing the container, this saves the container locally rather than on the host. With even reasonable download speeds ~ 0.5MB/s this is quite slow. DigitalOcean download speeds are ~ 680 Mb/s, and upload about half that. Better yet, pushing the container back to the Hub only pushes the changed layers anyway, so is nearly instantaneous. The Hub also provides a private repo for free.</p>
<p>This provides a pretty compelling workflow of</p>
<ul>
<li><code>docker-machine create ...</code></li>
<li><code>docker run &lt;...&gt; user/private</code> and do stuff</li>
<li><code>docker commit container user/private</code>, <code>docker push user/private</code>, <code>docker-machine rm -f ...</code></li>
</ul>
<p>in order to deploy one’s work on temporary machine with appropriate power, and then save the work and close the machine. Using docker instead of the standard image ‘snapshots’ is probably faster and nicely independent of the machine and provider; and in this case the snapshot storage is free of cost as well.</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/04/15/misc-notes-on-cloud-providers.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

  </div>
</div> <!--end row -->

<div class="row socialicons">
  <div class="col-md-11 col-md-offset-1">
		<p> <a href="/2015/index.html"><i class="icon-calendar"></i> All entries by date</a></p> 
      <p> <a href="/2015/categories.html"><i class="icon-list"></i> All entries by category</a> </p>
      <p> <a href="/2015/tags.html"><i class="icon-tags"></i> All entries by tag</a> </p>
  </div> <!--end col-md-9 -->
</div> <!--end row -->




      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="http://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="http://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Lab Notebook
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=http://www.carlboettiger.info/lab-notebook.html">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
