<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: http://purl.org/dc/terms/ og: http://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Lab Notebook</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Lab Notebook" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/lab-notebook.html" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Lab Notebook" />
<meta property="og:author" content="http://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="http://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="http://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="http://ogp.me/ns/article#published_time" content="" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="http://www.carlboettiger.info/lab-notebook.html" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content=""/>
<meta name="citation_title" content="Lab Notebook"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="http://www.carlboettiger.info/assets/css/academicons.css" />
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="http://www.carlboettiger.info/blog.xml" />
</head>


  <body prefix="dc: http://purl.org/dc/terms/ foaf: http://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  class="active" >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="http://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Lab Notebook</h1>
        <h2>(<a href="http://www.carlboettiger.info/2012/09/28/Welcome-to-my-lab-notebook.html">Introduction</a>)</h2>
      </header>

      <div class="row postpreview">
  <div class="col-md-11 col-md-offset-1">
    <div class="row">
			<h4> <a href="/2015/atom.xml"
              onClick="recordOutboundLink(this,
              'Outbound Links', 'RSS'); return false;"
              style="color: inherit;"
              ><i class="icon-rss" ></i> Entries</a></h4>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/04/06/gpdd-explore.html">Gpdd Explore</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 06 Apr 2015</p>

<article>
<div class="excerpt">
<h3 id="setup">setup</h3>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;ropensci/rgpdd&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;knitcitations&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;rgpdd&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;FKF&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># For some tidy printing</span>
main &lt;-<span class="st"> </span><span class="kw">as.tbl</span>(gpdd_main) 
data &lt;-<span class="st"> </span><span class="kw">as.tbl</span>(gpdd_data)</code></pre>
<p>Working through Knape and de Valpine (2011) provides a nice way to play around with the GPDD data and Kalman filtering. More interested in exploring the data and methods than in just replicating the results, which are important but also rather intuitive and thus I expect rather robust – as we add (observational) uncertainty, or indeed, any additional parameters that must be ended, we should expect to have less power to pin down a particular parameter associated with density dependence, as the paper illustrates rather nicely.</p>
<hr />
<h2 id="data-preparation">Data preparation</h2>
<blockquote>
<p>627 time series with population indices obtained from the GPDD (NERC Centre for Population Biology 1999). Data sets were filtered out from the database by removing harvest and non-index based data, data sampled at non-annual intervals and time series taking less than 15 unique values.</p>
</blockquote>
<p>Excluding time-series shorter than a minimum length is intuitive. Excluding harvest data makes some sense, as these aren’t scientific samples; in particular, they do not necessarily reflect a uniform sampling effort over time. Not quite clear why one would exclude non-annual intervals. Not really clear what “non-index based data” even means. Note that this 2012 paper still cites the original 1999 version instead of the 2010 version, which adds 123 datasets (for a total of 5,156).</p>
<p>Anyway, we can roughly infer what these filters mean in terms of the columns and values defined in the “MAIN” table of the GPDD, as described in the <a href="http://www3.imperial.ac.uk/cpb/databases/gpdd">GPDD User Manual</a>. <code>dplyr</code> makes it quick to implement these filters in R:</p>
<pre class="sourceCode r"><code class="sourceCode r">gpdd_main %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(SamplingProtocol ==<span class="st"> &quot;Count&quot;</span>,
         SourceDimension %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Count&quot;</span>, <span class="st">&quot;Index&quot;</span>), 
         SamplingFrequency ==<span class="st"> &quot;1&quot;</span>,
         DatasetLength &gt;=<span class="st"> </span><span class="dv">15</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(MainID) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(MainID) -&gt;
filtered</code></pre>
<p>Note that we might imagine different selection criteria, looking a bit more closely at the relevant fields.</p>
<hr />
<p>Unfortunately these don’t quite align with the paper, even allowing for the 123 additional datasets. Most obviously, we have 1749 matches instead of 627. Not only have we somehow grabbed more datasets than expected, but the Knape et al list includes quite a few datasets that do not meet these criteria:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&quot;http://ropensci.github.io/rgpdd/data/knape.R&quot;</span>)
gpdd_main %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(MainID %in%<span class="st"> </span>knape_ids) %&gt;%
<span class="st">  </span><span class="kw">select</span>(MainID, SamplingProtocol, SourceDimension, SamplingFrequency, DatasetLength)  %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(MainID) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">as.tbl</span>() -&gt;<span class="st"> </span>knape_data

<span class="kw">tail</span>(<span class="kw">sort</span>(<span class="kw">table</span>(knape_data$SourceDimension)))</code></pre>
<pre><code>
Count (estimated)        Mean Count             Index 
                5                 8                15 
          Density Transformed Count             Count 
               20               110               459 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tail</span>(<span class="kw">sort</span>(<span class="kw">table</span>(knape_data$SamplingProtocol)))</code></pre>
<pre><code>
    Count (millions)              Harvest              Unknown 
                   1                    1                    1 
  Index of abundance Index of territories                Count 
                   2                    6                  616 </code></pre>
<p>Those summaries show data with attributes we excluded, including Harvest as a sampling protocol. We see over 100 such data sets:</p>
<pre class="sourceCode r"><code class="sourceCode r">gpdd_main %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(MainID %in%<span class="st"> </span>knape_ids) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(SamplingProtocol ==<span class="st"> &quot;Count&quot;</span>,
         SourceDimension %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Count&quot;</span>, <span class="st">&quot;Index&quot;</span>), 
         SamplingFrequency ==<span class="st"> &quot;1&quot;</span>,
         DatasetLength &gt;=<span class="st"> </span><span class="dv">15</span>) %&gt;%<span class="st"> </span><span class="kw">dim</span>()</code></pre>
<pre><code>[1] 468  25</code></pre>
<p>The reason for this discrepancy isn’t clear, but we can proceed with our filtered data instead.</p>
<hr />
<p>Selecting the time-series identified by our filter, we also add a column for <span class="math">\(\log(N)\)</span> population:</p>
<pre class="sourceCode r"><code class="sourceCode r">gpdd_data %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(MainID %in%<span class="st"> </span>filtered$MainID) %&gt;%
<span class="st">  </span><span class="kw">select</span>(MainID, Population, SampleYear) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(MainID) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">logN =</span> <span class="kw">log</span>(Population)) -&gt;
df</code></pre>
<p>Interestingly there are no missing data reported:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">sapply</span>(df$Population, is.na))</code></pre>
<pre><code>[1] 0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df %&gt;%<span class="st"> </span><span class="kw">filter</span>(Population &lt;<span class="st"> </span><span class="dv">0</span>) <span class="co"># -9999 is elsewhere used for missing data</span></code></pre>
<pre><code>Source: local data frame [0 x 4]
Groups: MainID

Variables not shown: MainID (int), Population (dbl), SampleYear
  (int), logN (dbl)</code></pre>
<p>but some population values are equal to 0, creating some <code>-Inf</code> terms in our log data, which will create trouble in fitting the models. The authors don’t say how they handled this case. We will manually set them to the smallest value observed:</p>
<pre class="sourceCode r"><code class="sourceCode r">i &lt;-<span class="st"> </span><span class="kw">which</span>(df$logN ==<span class="st"> </span>-<span class="ot">Inf</span>)
df$logN[i] &lt;-<span class="st"> </span><span class="kw">min</span>(df$logN[-i])-<span class="dv">1</span></code></pre>
<h2 id="gompertz-model">Gompertz model</h2>
<blockquote>
<p>We use the stochastic Gompertz population model to analyse the strength of density dependence in the data.The model is defined through</p>
</blockquote>
<p><span class="math">\[N_{t+1} = N_t \exp(a - b \log N_t + \epsilon_t)\]</span></p>
<blockquote>
<p>where <span class="math">\(N_t\)</span> is population density or size in year <span class="math">\(t\)</span>, <span class="math">\(a\)</span> is an intercept, <span class="math">\(b\)</span> is a measure of the strength of density dependence and <span class="math">\(\eta\)</span> is normally distributed process error with mean zero and standard deviation <span class="math">\(\tau\)</span>. By log transforming the population abundance and putting <span class="math">\(x_t = \log N_t\)</span> this simplifies to</p>
</blockquote>
<p><span class="math">\[x_{t+1} = a _ c x_t + \epsilon_t\]</span></p>
<blockquote>
<p>where <span class="math">\(c = 1 - b\)</span> is the lag 1 autocorrelation of the log transformed population abundance when the process is stationary.</p>
</blockquote>
<p>and uncertainty in measurements, <span class="math">\(y_t\)</span> are simply normal random variates around <span class="math">\(x_t\)</span>:</p>
<p><span class="math">\[y_t = x_t + \eta_t \]</span></p>
<p>where <span class="math">\(\eta_t \sim N(0,\sigma^2)\)</span></p>
<h2 id="kalman-filtering">Kalman Filtering</h2>
<p>Since the model is linear we can compute the likelihood directly by means of a Kalman filter. There are various ways of going about this, and the paper provides some general details:</p>
<blockquote>
<p>The Kalman filter was initiated by assuming a wide prior distribution on the initial state centred around the first observation, <span class="math">\(x_1 \sim N( y_1, 10)\)</span>. For each model and data set the numerical maximisation (using the BFGS algorithm implemented in the optim function) was repeated for 50 random starting values to ensure that we found the global optimum</p>
</blockquote>
<p>Some useful detail here, but still a bit vague for our purposes, or are things we might have done differently.</p>
<ul>
<li><p>Doesn’t state which Kalman filter (their are a few algorithms and several packages, but the differences seem quite small: <a href="http://www.jstatsoft.org/v39/i02">this JSS paper</a> has a good overview.)</p></li>
<li><p>Not clear that we wouldn’t want to scale the prior variance by the data sample, e.g. <code>var(y)</code>, but since we’re on a log scale <code>10</code> is indeed pretty wide.</p></li>
<li><p><code>BFGS</code> doesn’t seem as robust as some alternatives; (e.g. gives a rather different result than Nelder-Meade or <code>StructTS()</code> model on the classic Nile data set example from the FKF package).</p></li>
<li><p>Also challenging are the “50 random starting values”, which does not tell us from what distribution they were drawn. Too wide a distribution will start to include values for which the likelihood cannot be evaluated, while too narrow serves little purpose. –Moreover it is unclear if this is really preferable to simply using fewer starting points and a more robust algorithm. For simplicity, we’ll ignore this and just choose justifiable starting conditions.– we’ll add this as well.</p></li>
</ul>
<blockquote>
<p>Four variants of the model defined by (1) and (2) were fitted to each data set; a full model with both uncertainty about population abundance and density dependence denoted by SSG (state space Gompertz), a model with uncertainty about population abundance, but no density dependence (c fixed to one) denoted SSRW (state space random walk), a model with density dependence, but no uncertainty about population abundance (r2 fixed to zero) denoted G (Gompertz) and a model with neither uncertainty about population abundance nor density dependence (c fixed to one and r2 fixed to zero) denoted RW (random walk)</p>
</blockquote>
<p>This is both clear and straight forward, we define each of the models as described. Note that we define the models here in the notation of FKF:</p>
<p><span class="math">\[\alpha_{t+1} = d_t + T_t \alpha_t H_t \eta_t\]</span></p>
<p><span class="math">\[y_t = c_t + Z_t \alpha_t + G_t \eta_t\]</span></p>
<p>Where</p>
<p><span class="math">\[\begin{align*}
c &amp;\to&amp; T_t \\
a &amp;\to&amp; d_t \\
\sigma^2 &amp;\to&amp; G_t&#39;G_t \\
\tau^2 &amp;\to&amp; H_t&#39;H_t 
\end{align*}\]</span></p>
<p>So here we define these models in R code just as described above. Using the <code>FKF</code> package we define each model by an optimization routine that returns the parameters that maximize the likelihood for the given model.</p>
<pre class="sourceCode r"><code class="sourceCode r">fit_ssg &lt;-<span class="st"> </span>function(y, 
                    <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">Tt =</span> <span class="dv">1</span>, 
                             <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>), <span class="dt">GGt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>)),
                    ...){
    o &lt;-<span class="st"> </span><span class="kw">optim</span>(init,
                 <span class="dt">fn =</span>  function(par, ...)
                   -<span class="kw">fkf</span>(<span class="dt">dt =</span> <span class="kw">matrix</span>(par[<span class="dv">1</span>]),
                        <span class="dt">Tt =</span> <span class="kw">matrix</span>(par[<span class="dv">2</span>]),
                        <span class="dt">HHt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">3</span>])), 
                        <span class="dt">GGt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">4</span>])), 
                        ...)$logLik,   
                 <span class="dt">a0 =</span> y[<span class="dv">1</span>], 
                 <span class="dt">P0 =</span> <span class="kw">matrix</span>(<span class="dv">10</span>), 
                 <span class="dt">ct =</span> <span class="kw">matrix</span>(<span class="dv">0</span>),
                 <span class="dt">Zt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>), 
                 <span class="dt">yt =</span> <span class="kw">rbind</span>(y), 
                 <span class="dt">check.input =</span> <span class="ot">FALSE</span>, 
                 ...)
  o$par[[<span class="st">&quot;HHt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;HHt&quot;</span>]])
  o$par[[<span class="st">&quot;GGt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;GGt&quot;</span>]])
  <span class="kw">c</span>(o, <span class="kw">list</span>(<span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">n =</span> <span class="kw">length</span>(y)))
}

fit_ssrw &lt;-<span class="st"> </span>function(y, 
                     <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt=</span><span class="kw">mean</span>(y), <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>), 
                              <span class="dt">GGt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>)), 
                     ...){
    o &lt;-<span class="st"> </span><span class="kw">optim</span>(init,
                 <span class="dt">fn =</span>  function(par, ...)
                   -<span class="kw">fkf</span>(<span class="dt">dt =</span> <span class="kw">matrix</span>(par[<span class="dv">1</span>]), <span class="dt">HHt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">2</span>])), 
                        <span class="dt">GGt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">3</span>])), ...)$logLik,   
                 <span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">P0 =</span> <span class="kw">matrix</span>(<span class="dv">10</span>), <span class="dt">ct =</span> <span class="kw">matrix</span>(<span class="dv">0</span>), <span class="dt">Tt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>),
                 <span class="dt">Zt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>), <span class="dt">yt =</span> <span class="kw">rbind</span>(y), <span class="dt">check.input =</span> <span class="ot">FALSE</span>, ...)
  o$par[[<span class="st">&quot;HHt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;HHt&quot;</span>]])
  o$par[[<span class="st">&quot;GGt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;GGt&quot;</span>]])
  <span class="kw">c</span>(o, <span class="kw">list</span>(<span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">n =</span> <span class="kw">length</span>(y)))
}

fit_g &lt;-<span class="st"> </span>function(y, <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">Tt=</span><span class="dv">1</span>, <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y))), ...){
  o &lt;-<span class="st"> </span><span class="kw">optim</span>(init,
                 <span class="dt">fn =</span>  function(par, ...)
                   -<span class="kw">fkf</span>(<span class="dt">dt =</span> <span class="kw">matrix</span>(par[<span class="dv">1</span>]), <span class="dt">Tt =</span> <span class="kw">matrix</span>(par[<span class="dv">2</span>]), 
                        <span class="dt">HHt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">3</span>])), ...)$logLik,   
                 <span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">P0 =</span> <span class="kw">matrix</span>(<span class="dv">10</span>), <span class="dt">ct =</span> <span class="kw">matrix</span>(<span class="dv">0</span>), <span class="dt">GGt =</span> <span class="kw">matrix</span>(<span class="dv">0</span>),
                 <span class="dt">Zt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>), <span class="dt">yt =</span> <span class="kw">rbind</span>(y), <span class="dt">check.input =</span> <span class="ot">FALSE</span>, ...)
  o$par[[<span class="st">&quot;HHt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;HHt&quot;</span>]])  
  <span class="kw">c</span>(o, <span class="kw">list</span>(<span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">n =</span> <span class="kw">length</span>(y)))
}

fit_rw &lt;-<span class="st"> </span>function(y, <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt=</span><span class="kw">mean</span>(y), <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y))), ...){
 o &lt;-<span class="st">  </span><span class="kw">optim</span>(init, 
                 <span class="dt">fn =</span>  function(par, ...)
                   -<span class="kw">fkf</span>(<span class="dt">dt =</span> <span class="kw">matrix</span>(par[<span class="dv">1</span>]), 
                        <span class="dt">HHt =</span> <span class="kw">matrix</span>(<span class="kw">exp</span>(par[<span class="dv">2</span>])), ...)$logLik,   
                 <span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">P0 =</span> <span class="kw">matrix</span>(<span class="dv">10</span>), <span class="dt">ct =</span> <span class="kw">matrix</span>(<span class="dv">0</span>),
                 <span class="dt">Tt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>), <span class="dt">GGt =</span> <span class="kw">matrix</span>(<span class="dv">0</span>), <span class="dt">Zt =</span> <span class="kw">matrix</span>(<span class="dv">1</span>),
                 <span class="dt">yt =</span> <span class="kw">rbind</span>(y), <span class="dt">check.input =</span> <span class="ot">FALSE</span>, ...)
  o$par[[<span class="st">&quot;HHt&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">exp</span>(o$par[[<span class="st">&quot;HHt&quot;</span>]])
  <span class="kw">c</span>(o, <span class="kw">list</span>(<span class="dt">a0 =</span> y[<span class="dv">1</span>], <span class="dt">n =</span> <span class="kw">length</span>(y)))
}</code></pre>
<p>Note that <code>fkf</code> will return finite (even “optimal”) log likelihoods for negative values of <code>HHt</code> and <code>GGt</code>, so we have log-transformed these parameters. Using <code>L-BFGS-B</code> with a <code>0</code> lower bound still causes <code>optim</code> to error with non-finite log-likelihoods. It isn’t clear how the authors dealt with this constraint, though <code>log</code>-transform trick has advantages and drawbacks.</p>
<p>Once we have defined the optimization routines to fit each model, we can define a summary function that runs each model on a given data set and collects the results into a <code>data.frame</code>. This could be made a bit more general and elegant as discussed later. We will also define this function such that it will fit each model <span class="math">\(N = 50\)</span> times and take the best fit, as the authors suggest for having a better chance of finding the global optimum. (We’ll look at the variation in MLE estimates in these models as footnote as well).</p>
<pre class="sourceCode r"><code class="sourceCode r">robust_fit &lt;-<span class="st"> </span>function(<span class="dt">model =</span> <span class="kw">c</span>(<span class="st">&quot;ssg&quot;</span>, <span class="st">&quot;ssrw&quot;</span>, <span class="st">&quot;g&quot;</span>, <span class="st">&quot;rw&quot;</span>), y, <span class="dt">N =</span> <span class="dv">50</span>, <span class="dt">all =</span> <span class="ot">FALSE</span>, ...){
  
  ## Set the model and the mean initial condition
  m &lt;-<span class="st"> </span>switch(model,
              <span class="dt">ssg =</span> <span class="kw">list</span>(<span class="dt">fit =</span> fit_ssg, 
                         <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">Tt =</span> <span class="dv">1</span>, 
                                 <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>), <span class="dt">GGt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>))),
              <span class="dt">ssrw =</span> <span class="kw">list</span>(<span class="dt">fit =</span> fit_ssrw, 
                          <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>), 
                                   <span class="dt">GGt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>))),
              <span class="dt">g =</span> <span class="kw">list</span>(<span class="dt">fit =</span> fit_g, 
                       <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">Tt =</span> <span class="dv">1</span>, <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>))),
              <span class="dt">rw =</span> <span class="kw">list</span>(<span class="dt">fit =</span> fit_rw, 
                        <span class="dt">init =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="kw">mean</span>(y), <span class="dt">HHt =</span> <span class="kw">log</span>(<span class="kw">var</span>(y)/<span class="dv">2</span>))))  
  
  
  ## Create the inital conditions
  inits &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="dv">1</span>:N, <span class="kw">sapply</span>(m$init, 
                      function(m) <span class="kw">rnorm</span>(N, m, <span class="kw">sqrt</span>(<span class="kw">abs</span>(m)))))  
  
  ## Attempt the requested fit or return NAs
  f &lt;-<span class="st"> </span>function(init){
    o &lt;-<span class="st"> </span><span class="kw">tryCatch</span>(
      m$<span class="kw">fit</span>(y, <span class="dt">init =</span> init[-<span class="dv">1</span>]), 
      <span class="dt">error =</span> function(e) <span class="kw">list</span>(<span class="dt">par =</span> <span class="kw">c</span>(<span class="dt">dt =</span> <span class="ot">NA</span>, <span class="dt">Tt=</span><span class="ot">NA</span>, <span class="dt">HHt =</span> <span class="ot">NA</span>, <span class="dt">GGt=</span> <span class="ot">NA</span>),
                               <span class="dt">value=</span><span class="ot">NA</span>, <span class="dt">convergence=</span><span class="dv">1</span>, <span class="dt">n=</span><span class="kw">length</span>(y), <span class="dt">a0=</span>y[<span class="dv">1</span>]))
    <span class="kw">data.frame</span>(<span class="kw">t</span>(<span class="kw">c</span>(o$par, <span class="dt">mloglik =</span> o$value, <span class="dt">converge =</span>
                   <span class="kw">as.numeric</span>(o$convergence), <span class="dt">n=</span>o$n, <span class="dt">a0=</span>o$a0)))
  }
  
  ## Apply the function to each initial condition, 
  inits %&gt;%<span class="st"> </span><span class="kw">group_by</span>(id) %&gt;%<span class="st"> </span><span class="kw">do</span>(<span class="kw">f</span>(.)) %&gt;%<span class="st"> </span><span class="kw">ungroup</span>() -&gt;<span class="st"> </span>output
  
  if(!all) ## drop unconverged, and select only the best scoring run
    output %&gt;%<span class="st"> </span><span class="kw">filter</span>(converge ==<span class="st"> </span><span class="dv">0</span>) %&gt;%<span class="st"> </span><span class="kw">slice</span>(<span class="kw">which.min</span>(mloglik)) -&gt;<span class="st"> </span>output
  
  output
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">kalman &lt;-<span class="st"> </span>function(df, ...){
  y &lt;-<span class="st"> </span>df$logN
  ssg &lt;-<span class="st"> </span><span class="kw">robust_fit</span>(<span class="st">&quot;ssg&quot;</span>, y, ...) 
  ssrw &lt;-<span class="st"> </span><span class="kw">robust_fit</span>(<span class="st">&quot;ssrw&quot;</span>, y, ...) 
  g &lt;-<span class="st"> </span><span class="kw">robust_fit</span>(<span class="st">&quot;g&quot;</span>, y, ...) 
  rw &lt;-<span class="st"> </span><span class="kw">robust_fit</span>(<span class="st">&quot;rw&quot;</span>, y, ...)
  <span class="kw">options</span>(<span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)
  <span class="kw">rbind</span>(<span class="dt">ssg  =</span> ssg,
        <span class="dt">ssrw =</span> <span class="kw">cbind</span>(ssrw, <span class="dt">Tt =</span> <span class="dv">1</span>),
        <span class="dt">g    =</span> <span class="kw">cbind</span>(g, <span class="dt">GGt =</span> <span class="dv">0</span>), 
        <span class="dt">rw   =</span> <span class="kw">cbind</span>(rw, <span class="dt">Tt =</span> <span class="dv">1</span>, <span class="dt">GGt =</span> <span class="dv">0</span>))
                              
}</code></pre>
<p>Having defined a function that takes and returns a <code>data.frame</code>, <code>dplyr::do</code> gives us a consise syntax to apply this by group (recall <code>df</code> is already <code>group_by(MainID)</code>.) As the authors note, the robust fitting procedure is computationally intensive, though easily parallelized.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">init_cluster</span>()</code></pre>
<pre><code>Error: Single core computer. Parallelisation not available</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
  
df %&gt;%<span class="st"> </span><span class="kw">do</span>(<span class="kw">kalman</span>(.)) -&gt;<span class="st"> </span>fits

)</code></pre>
<pre><code>Error in rbind(deparse.level, ...): numbers of columns of arguments do not match</code></pre>
<pre><code>Timing stopped at: 1000.26 28.408 1215.648 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stop_cluster</span>()</code></pre>
<h2 id="side-note-on-coding-strategy">Side note on coding strategy</h2>
<p><code>dplyr</code> makes the data filtering steps fast, consise, and clear. Dealing with model outputs here is actually far less straight forward than cleaning the raw data. For instance, I have collected the output of each model fit into it’s own row. The models have different numbers of parameters, so I must add the fixed parameters to avoid rows of different length; but clearly this does not generalize to the case where the different models can have arbitrarily different parameters.</p>
<p><a href="https://github.com/dgrtwo">David Robinson</a> has done an excellent job in starting to tackle this thorny problem in a package called <code>broom</code> with much the same elegance and care that Hadley has done with <code>dplyr</code>. David argues very persuasively that it makes more sense to summarize parameter estimates from each model fit in two columns - a column for parameter names and a column for values. He has now added support for <code>optim()</code> output to the <code>broom::tidy()</code> function, which does just that.</p>
<p>This doesn’t translate immediately to my use case here, since I need to keep track of the likelihood and convergence which are not captured by <code>broom::tidy()</code>. As these are scalar valued outputs of the model fit, instead of a vector like parameters, they are extracted and summarized in <code>broom::glance()</code> as a single row. An easy generalization would just be to <code>cbind</code> the outputs of <code>glance()</code> and <code>tidy()</code>; though David argues for a different approach in which we defer any manipulation of model output. Instead, he suggests an <code>expand.grid</code> over the names of the groups (models and datasets):</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># not run</span>

<span class="kw">expand.grid</span>(<span class="dt">model =</span> <span class="kw">names</span>(models),
            <span class="dt">dataset =</span> <span class="kw">names</span>(datasets)) %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(model, dataset) %&gt;%
<span class="st">    </span><span class="kw">do</span>(<span class="dt">o =</span> <span class="kw">optim_func</span>(.$model, .$dataset)) -&gt;<span class="st"> </span>david</code></pre>
<p>Where <code>optim_func</code> uses the name of the model and name of the dataset to apply <code>optim()</code>, rather than passing the data explicitly. We can then use <code>glance</code> and <code>tidy</code> on the resulting output, though we would need to <code>inner_join</code> the results instead of <code>cbind</code>.</p>
<p>This is indeed an elegant, more generic approach, though passing names instead of data and tidying &amp; joining more complex aggregate data frames seems a bit less transparent to me.</p>
<hr />
<p>–Note that BFGS is more problematic on some of the datasets– by catching errors we are able to run this with BFGS algorithm as well:</p>
<pre class="sourceCode r"><code class="sourceCode r">df %&gt;%<span class="st"> </span><span class="kw">do</span>(<span class="kw">kalman</span>(., <span class="dt">method =</span> <span class="st">&quot;BFGS&quot;</span>)) -&gt;<span class="st"> </span>fits_bfgs</code></pre>
<pre><code>Error in rbind(deparse.level, ...): numbers of columns of arguments do not match</code></pre>
<p>We now have a nice table of parameter estimates and likelihoods by model for each data set:</p>
<pre class="sourceCode r"><code class="sourceCode r">fits</code></pre>
<pre><code>Error in eval(expr, envir, enclos): object &#39;fits&#39; not found</code></pre>
<p>A bit worrying that one of our simpler models sometimes have better (smaller) minus log likelihood scores than the full SSG model; but that model (3, SSRW) also has a flag indicating convergence issues.</p>
<p>and here is our version then of Figure 1b:</p>
<pre class="sourceCode r"><code class="sourceCode r">fits %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(MainID, model) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(converge ==<span class="st"> &quot;0&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(Tt) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(model, Tt) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(SSG, G) -&gt;<span class="st"> </span>
<span class="st">  </span>c_values</code></pre>
<pre><code>Error in eval(expr, envir, enclos): object &#39;fits&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(c_values, <span class="kw">aes</span>(SSG, G)) +<span class="st"> </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept=</span><span class="dv">0</span>, <span class="dt">slope=</span><span class="dv">1</span>) +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">&quot;c estimates&quot;</span>)</code></pre>
<pre><code>Error in ggplot(c_values, aes(SSG, G)): object &#39;c_values&#39; not found</code></pre>
<p>Note the warning from dropping those points where the parameter value could not be estimated under one of the models. Not surprisingly, it’s almost always the full (SSG) model where convergence issues have arisen:</p>
<pre class="sourceCode r"><code class="sourceCode r">fits %&gt;%<span class="st"> </span><span class="kw">filter</span>(converge !=<span class="st"> &quot;0&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">group_by</span>(model) %&gt;%<span class="st"> </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>())</code></pre>
<pre><code>Error in eval(expr, envir, enclos): object &#39;fits&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">fits %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(MainID, model) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(converge ==<span class="st"> &quot;0&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(Tt) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(model %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SSG&quot;</span>, <span class="st">&quot;G&quot;</span>)) -&gt;<span class="st"> </span>tmp</code></pre>
<pre><code>Error in eval(expr, envir, enclos): object &#39;fits&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(tmp) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(Tt), <span class="dt">binwidth=</span><span class="fl">0.1</span>)</code></pre>
<pre><code>Error in ggplot(tmp): object &#39;tmp&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">fits %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(MainID, model) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(GGt) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(model, GGt) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(SSG, SSRW) -&gt;<span class="st"> </span>
<span class="st">  </span>sigma2_values</code></pre>
<pre><code>Error in eval(expr, envir, enclos): object &#39;fits&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sigma2_values, <span class="kw">aes</span>(SSG, SSRW)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept=</span><span class="dv">0</span>, <span class="dt">slope=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">&quot;sigma2 (observation error) estimates&quot;</span>)</code></pre>
<pre><code>Error in ggplot(sigma2_values, aes(SSG, SSRW)): object &#39;sigma2_values&#39; not found</code></pre>
<hr />
<h2 id="aside-further-exploring-numerical-issues">Aside: further exploring numerical issues</h2>
<p>Numerical optimization can be tricky, particularly in this unsupervised manner. The robust (multiple) fitting strategy goes some ways to addressing this; though ideally one would at least show that the resulting estimates change little if N is increased further.</p>
<pre class="sourceCode r"><code class="sourceCode r">df %&gt;%<span class="st"> </span><span class="kw">filter</span>(MainID==<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">robust_fit</span>(<span class="st">&quot;ssg&quot;</span>,  <span class="dt">y=</span>.$logN, <span class="dt">all=</span><span class="ot">TRUE</span>)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(dt, Tt, HHt, GGt, mloglik) %&gt;%
<span class="st">  </span>tidyr::<span class="kw">gather</span>(parameter, value, -MainID) -&gt;<span class="st"> </span>all

<span class="kw">ggplot</span>(all) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span><span class="kw">facet_wrap</span>(~parameter, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-04-06-gpdd-explore/unnamed-chunk-20-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(MainID==<span class="dv">1998</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">robust_fit</span>(<span class="st">&quot;ssg&quot;</span>,  <span class="dt">y=</span>.$logN, <span class="dt">all=</span><span class="ot">TRUE</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dt, Tt, HHt, GGt, mloglik) %&gt;%<span class="st"> </span>
<span class="st">  </span>tidyr::<span class="kw">gather</span>(parameter, value, -MainID) -&gt;<span class="st"> </span>all

<span class="kw">ggplot</span>(all) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span><span class="kw">facet_wrap</span>(~parameter, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-04-06-gpdd-explore/unnamed-chunk-21-1.png" />
</figure>
<p>Also compare also to the classic example used in most Kalman filter packages, the Nile river flows time series:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">robust_fit</span>(<span class="st">&quot;ssg&quot;</span>,  <span class="dt">y=</span>Nile, <span class="dt">all=</span><span class="ot">TRUE</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dt, Tt, HHt, GGt, mloglik) %&gt;%
<span class="st">  </span>tidyr::<span class="kw">gather</span>(parameter, value) -&gt;<span class="st"> </span>all
<span class="kw">ggplot</span>(all) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span><span class="kw">facet_wrap</span>(~parameter, <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-04-06-gpdd-explore/unnamed-chunk-22-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/04/06/gpdd-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/26/ropensci-unconf-teaching-session.html">Ropensci Unconf Teaching Session</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 26 Mar 2015</p>

<article>
<div class="excerpt">
<h2 id="panel-on-effective-teaching-with-r">Panel on Effective teaching with R</h2>
<p>Panel:</p>
<ol type="1">
<li>Tracy Teal - Data Carpentry</li>
<li>Hadley Wickhan - undergrads at Rice, R master classes for RStudio</li>
<li>Mine, Prof Stats, Duke, also MOOC</li>
<li>Roger Peng Prof Biostats, John Hopkins</li>
<li>Jenny Bryan, Prof Stats, UBC.<br /></li>
<li>Ben Marwick, Prof Archaelogy</li>
</ol>
<p>How do you engage new users? (Or what doesn’t work?)</p>
<p>Hadley: Start with visualization. +1 Jenny Jenny: Making an HTML page with .Rmd (+1 Mine), scaling/aggregation Roger: these days, they come to me excited about R Mine: I have to convince social scientists to use computers at all. Visualization, faceting etc helps, Rmd helps.<br />Ben: Reproducible scripts, not click trails (Excel).</p>
<p>What’s the worst way to start?</p>
<ul>
<li>teaching data structures / programming first.</li>
</ul>
<p>teach loops, control structures?</p>
<ul>
<li>later / no. Mine teaches loops with index cards.</li>
<li>Hadley aims to to get people to re-invent lapply as a common pattern…</li>
</ul>
<p>Keeping people engaged? (Break-out session to develop reading lists, user groups)</p>
<ul>
<li>Mine data hack weekend. (PhD students mentoring, undergrads doing).<br /></li>
<li>Roger: capstone project. Track alumni (via linked-in, other ideas?)</li>
<li>Tracy: Pointing people to courses like Roger’s MOOC</li>
</ul>
<p>Engaging later-stage students?</p>
<ul>
<li>Working with own data and problems.</li>
</ul>
<p>R’s horrible gotchas (recycling, NA stuff, factor stuff, dropping columns/names)</p>
<ul>
<li>Hadley: 1) set the expectations that R has frustrations. 2) room / chance to fail safely, how to debug (google error).<br /></li>
<li>Roger: 10 examples of annoying things in R</li>
<li>Jenny: user str and fear factors.</li>
<li>Ben: getting help</li>
<li>Roger: students with programming experience need different kind of help.</li>
</ul>
<p>R &amp; Github?</p>
<ul>
<li>Hadley, Mine – nope. Hadley - I didn’t commit to teaching it. Don’t try it at the end.</li>
<li>Roger – it’s better (though students think git == github). Avoid why git is awesome, just teach it in a narrow sense!<br /></li>
<li>Jenny – intensive use of Github whole time, starting with it up front.<br /></li>
<li>Ben: not with undergrads, yes with grads. takes time.</li>
</ul>
<p>Markdown, Github – if you’re gonna do it, commit and do everything in it from the beginning.</p>
<p>Hadley: If something feels painful, do it more often. (git, R CMD check).</p>
<p>Writing functions: need to learn eventually, but it’s really hard to teach. Hadley’s book exercises for the reader. Over time course gets simpler.</p>
<p>When do you teach data cleaning?</p>
<p>Jenny: a data-cleaning script itself cannot be clean. It’s an advanced topic I teach it midway.<br />Jenny, Roger: includes teaching regex.</p>
<p>Find outside dataset mid-way, sudo-messy data.</p>
<p>Hadley: Hardest part is that students don’t know what the goal is, while I see it instantly. Takes a super long time to learn how to do this and to articulate this.</p>
<p>Data shouldn’t be too real, should be Disney-real (more real than reality). individual/personal they put in the time, so do a kaggle competition to clean data, top 3 winners get automatic A’s, opt out of final</p>
<p>Starting with spreadsheets and data entry!</p>
<p>Infrastructure for package building:</p>
<ul>
<li>takes time, possibly &gt; 30 min 1:1.</li>
<li>Mine: students run on cloud, I can replicate. but cannot run on own computer.</li>
<li>Roger: Better to live through the cli bs, once it’s done it’s done. VM’s not how the real world works. Hosting service for 1000s of people too expensive.</li>
<li>Jenny: pain is only when we need build environment</li>
<li><p>Ben: Use <em>local</em> Docker, replicates his own research. A slight taste of shell, but avoids CLI BS</p></li>
<li><p>install challenges is the opposite of a motivator / win. Luckily doesn’t bite early.</p></li>
</ul>
<p>Evaluate:</p>
<ul>
<li>peer review</li>
</ul>
<hr />
<p>Breakouts / products:</p>
<ol type="1">
<li>Listing follow-up resources</li>
<li>Iris data sets</li>
<li>dependencies &amp; scaling</li>
</ol>
<hr />
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/26/ropensci-unconf-teaching-session.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/24/docker-machine-notes.html">Docker Machine Notes</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 24 Mar 2015</p>

<article>
<div class="excerpt">
<p>Docker recently released <code>docker-machine</code> to make managing multiple remote machines locally easier. Docker distributes binaries of <code>docker-machine</code> for most major architectures ready-to-go, potentially making it easier to get started on Windows and Mac as well.</p>
<p>Set credentials in environmental variables so we don’t have to pass them on the command line each time:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">DIGITALOCEAN_ACCESS_TOKEN</span> = XXX</code></pre>
<p>and create the docker-machine:</p>
<pre><code>docker-machine create --driver digitalocean --digitalocean-size &quot;1gb&quot; server-name</code></pre>
<p>where <code>server-name</code> is any name you want to give your server and <code>DO_PAT</code> is your access token (say, saved as an environmental variable). Here we launch a 1GB instance, the default is 512MB on digitalocean. Many other providers work just as well (including virtualbox). You need to set your terminal to use the active <code>docker-machine</code> for all <code>docker</code> commands, instead of the local <code>docker</code> installation:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">eval</span> <span class="st">&quot;</span><span class="ot">$(</span><span class="kw">docker-machine</span> env server-name<span class="ot">)</span><span class="st">&quot;</span></code></pre>
<p>sets three environmental variables that point your <code>docker</code> commands to the new remote machine, <code>server-name</code>. Wow. We can now launch any service of interest:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> run -d -p 8787:8787 -e PASSWORD=something rocker/hadleyverse</code></pre>
<p>and it will run on the server. Get the IP address of the active machine with <code>docker-machine ip</code>, e.g. open the server in the browser (from a Ubuntu-based client)</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">xdg-open</span> http://<span class="kw">`docker-machine</span> ip<span class="kw">`</span>:8787</code></pre>
<p>You can see a list of active machines with <code>docker-machine ls</code> and switch between machines with <code>docker-machine env</code> as shown above. Remove a machine as you would a container, e.g. <code>docker-machine rm -f server-name</code>, which also shuts down the remote server so you will not be charged.</p>
<p>This is a bit more overhead than launching a container on an existing local or remote server instance, but not much; and easily scripted. Of course the latency is higher too: the start-up time for the DO instance takes two minutes, and pulling a sizable image onto DO machine takes another two minutes or so.</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/24/docker-machine-notes.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/09/simpler-nimble-dai-model.html">Simpler Nimble Dai Model</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 09 Mar 2015</p>

<article>
<div class="excerpt">
<h2 id="a-simpler-nimble-model">A simpler Nimble model</h2>
<h2 id="lsn-version">LSN version</h2>
<p>A further simplified version:</p>
<ul>
<li>fix <code>sigma_x</code> to unity and <code>theta</code> to zero, reflecting the detrending and scaling.</li>
<li>constrain <code>sigma_y</code> with a tight prior</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
<span class="co"># sigma_x ~ dunif(1e-10, 1e2)</span>
  
  ## highly constrained
  sigma_y ~<span class="st"> </span><span class="kw">dgamma</span>(<span class="dv">10</span>, <span class="dv">1000</span>)

  ## Uninformative
       m ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)
    y[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>) 

  for(i in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu_x[i] &lt;-<span class="st"> </span>x[i] -<span class="st"> </span>y[i] *<span class="st"> </span>x[i]
    x[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_x[i], <span class="dt">sd =</span> <span class="dv">1</span>) 
    y[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(y[i] +<span class="st"> </span>m *<span class="st"> </span>t[i] /<span class="st"> </span>t[N], <span class="dt">sd =</span> sigma_y) 
    
  }
})</code></pre>
<p>Generate the test data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1000</span>)
N &lt;-<span class="st"> </span><span class="dv">50</span>
DF &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">2000</span>, <span class="dt">length=</span>N) <span class="co"># schedule for env degredation (increased dilution)</span>
x &lt;-<span class="st"> </span><span class="kw">numeric</span>(N)   
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">1.76e5</span> <span class="co"># initial density</span>
   
for(day in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
 x[day<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">dai</span>(x[day], <span class="dt">DF =</span> DF[day])
}

raw &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">t =</span> <span class="dv">1</span>:N, <span class="dt">x =</span> x)</code></pre>
<p>Detrend:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw$t &lt;-<span class="st"> </span><span class="dv">1</span>:N
detrend &lt;-<span class="st"> </span><span class="kw">loess</span>(x ~<span class="st"> </span>t, raw)
sigma &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">var</span>(detrend$residuals))
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> detrend$residuals/sigma)
<span class="kw">qplot</span>(raw$t, data$x, <span class="dt">geom=</span><span class="st">&#39;line&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-09-simpler-nimble-dai-model/detrend-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_y =</span> .<span class="dv">01</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))
thin &lt;-<span class="st"> </span><span class="fl">1e2</span>
n_iter &lt;-<span class="st"> </span><span class="fl">1e6</span>

Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)
Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>, <span class="dt">thin=</span>thin)
  
Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Cmodel)
Cmcmc$<span class="kw">run</span>(n_iter)</code></pre>
<pre><code>NULL</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
samples &lt;-<span class="st"> </span>samples[,<span class="dv">1</span>:(<span class="kw">length</span>(inits) -<span class="st"> </span><span class="dv">1</span>)]
df &lt;-<span class="st"> </span><span class="kw">gather</span>(samples)</code></pre>
<h4 id="summary-statistics">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

      key        mean        std
1       m -0.02118436 0.02327253
2 sigma_y  0.01001409 0.00316794</code></pre>
<h4 id="traces">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">sample_n</span>(df, <span class="fl">2e2</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-09-simpler-nimble-dai-model/unnamed-chunk-6-1.png" />
</figure>
<h4 id="posteriors">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-09-simpler-nimble-dai-model/unnamed-chunk-7-1.png" />
</figure>
<h4 id="block-sampler">Block sampler</h4>
<pre class="sourceCode r"><code class="sourceCode r">constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_y =</span> .<span class="dv">01</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))
Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)
Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>,<span class="dt">thin=</span>thin)
mcmcspec$<span class="kw">addSampler</span>(<span class="st">&quot;RW_block&quot;</span>, <span class="kw">list</span>(<span class="dt">targetNodes=</span><span class="kw">c</span>(<span class="st">&#39;m&#39;</span>,<span class="st">&#39;sigma_y&#39;</span>), <span class="dt">adaptInterval=</span><span class="dv">100</span>))</code></pre>
<pre><code>[53] RW_block sampler;   targetNodes: m, sigma_y,  adaptive: TRUE,  adaptScaleOnly: FALSE,  adaptInterval: 100,  scale: 1,  propCov: identity</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Cmodel)
Cmcmc$<span class="kw">run</span>(n_iter)</code></pre>
<pre><code>NULL</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
samples &lt;-<span class="st"> </span>samples[,<span class="dv">1</span>:(<span class="kw">length</span>(inits)-<span class="dv">1</span>)]
df &lt;-<span class="st"> </span><span class="kw">gather</span>(samples)

df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>lsn, constants, data, inits)</code></pre>
<pre><code>Error in eval(expr, envir, enclos): could not find function &quot;my_mcmc&quot;</code></pre>
<h4 id="summary-statistics-1">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

      key         mean         std
1       m -0.025367634 0.027055911
2 sigma_y  0.009965489 0.003102902</code></pre>
<h4 id="traces-1">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">sample_n</span>(df, <span class="fl">1e3</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-09-simpler-nimble-dai-model/unnamed-chunk-10-1.png" />
</figure>
<h4 id="posteriors-1">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-09-simpler-nimble-dai-model/unnamed-chunk-11-1.png" />
</figure>
<hr />
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre>
<pre><code>R version 3.1.3 (2015-03-09)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Debian GNU/Linux 8 (jessie)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] methods   stats     graphics  grDevices utils     datasets 
[7] base     

other attached packages:
[1] dplyr_0.4.1             ggplot2_1.0.1          
[3] tidyr_0.2.0             regimeshifts_0.0.0.9000
[5] nimble_0.3-1            yaml_2.1.13            
[7] knitr_1.9              

loaded via a namespace (and not attached):
 [1] assertthat_0.1   codetools_0.2-11 colorspace_1.2-6
 [4] DBI_0.3.1        digest_0.6.8     evaluate_0.5.5  
 [7] formatR_1.0      grid_3.1.3       gtable_0.1.2    
[10] igraph_0.7.1     labeling_0.3     lazyeval_0.1.10 
[13] magrittr_1.5     MASS_7.3-40      munsell_0.4.2   
[16] parallel_3.1.3   plyr_1.8.1       proto_0.3-10    
[19] Rcpp_0.11.5      reshape2_1.4.1   scales_0.2.4    
[22] stringr_0.6.2    tools_3.1.3     </code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/09/simpler-nimble-dai-model.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/04/GP-nimble-explore.html">Gp Nimble Explore</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 04 Mar 2015</p>

<article>
<div class="excerpt">
<h2 id="gp-model">GP Model</h2>
<p>A successful specification looks like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({

   l ~<span class="st"> </span><span class="kw">dgamma</span>(<span class="dv">10</span>, <span class="dv">1</span>) 
   sigma.n ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
   Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N] &lt;-<span class="st"> </span><span class="kw">exp</span>(-<span class="fl">0.5</span> *<span class="st"> </span>diff[<span class="dv">1</span>:N, <span class="dv">1</span>:N] /<span class="st"> </span>l ^<span class="st"> </span><span class="dv">2</span>) +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I[<span class="dv">1</span>:N, <span class="dv">1</span>:N]
   y[<span class="dv">1</span>:N] ~<span class="st"> </span><span class="kw">dmnorm</span>(Mu[<span class="dv">1</span>:N], <span class="dt">cov =</span> Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N])  

})</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="dv">4</span>, -<span class="dv">3</span>, -<span class="dv">1</span>,  <span class="dv">0</span>,  <span class="dv">2</span>),
                   <span class="dt">y =</span> <span class="kw">c</span>(-<span class="dv">2</span>,  <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>, -<span class="dv">1</span>))

N &lt;-<span class="st"> </span><span class="kw">length</span>(obs$x)
diff &lt;-<span class="st"> </span><span class="kw">outer</span>(obs$x, obs$x, function(xi, xj) (xi-xj)^<span class="dv">2</span>)
constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">x =</span> obs$x, <span class="dt">Mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="dt">diff =</span> diff, <span class="dt">I =</span> <span class="kw">diag</span>(<span class="dv">1</span>,N))
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">l =</span> <span class="dv">1</span>, <span class="dt">sigma.n =</span> <span class="dv">10</span>)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> obs$y)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)</code></pre>
<p>We can simulate parameters from the prior:</p>
<pre class="sourceCode r"><code class="sourceCode r">Rmodel$l</code></pre>
<pre><code>[1] 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">simulate</span>(Rmodel, <span class="st">&quot;l&quot;</span>)
Rmodel$l</code></pre>
<pre><code>[1] 10.53233</code></pre>
<p>Other nodes and likelihoods are updated to reflect the new value only after we run <code>calculate()</code>, so this is the logProb of <code>l</code> originally:</p>
<pre class="sourceCode r"><code class="sourceCode r">Rmodel$logProb_l</code></pre>
<pre><code>[1] NA</code></pre>
<p>After we run <code>calculate()</code>, the <code>logProb</code> is updated to reflect our simulated value of <code>l</code>, as are the dependent terms (like the Sigma matrix)</p>
<pre class="sourceCode r"><code class="sourceCode r">Sigma &lt;-<span class="st"> </span>Rmodel$Sigma
<span class="kw">calculate</span>(Rmodel)</code></pre>
<pre><code>[1] -29.83908</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">identical</span>(Sigma, Rmodel$Sigma)</code></pre>
<pre><code>[1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">Rmodel$logProb_l</code></pre>
<pre><code>[1] -2.144112</code></pre>
<p>Interestingly, we don’t seem to be able to simulate actual data from the model in this way:</p>
<pre class="sourceCode r"><code class="sourceCode r">Rmodel$y</code></pre>
<pre><code>[1] -2  0  1  2 -1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">simulate</span>(Rmodel, <span class="st">&quot;y&quot;</span>)
Rmodel$y</code></pre>
<pre><code>[1] -2  0  1  2 -1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">identical</span>(Rmodel$y, Rmodel$origData[[<span class="st">&quot;y&quot;</span>]])</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>Note that <code>y</code> remaines fixed to the original data values. We have to do this manually:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mvrnorm</span>(<span class="dt">mu =</span> constants$Mu, <span class="dt">Sigma =</span> Rmodel$Sigma) </code></pre>
<pre><code>[1]  -0.4314916   3.7030315  10.8916817   4.6035105 -20.7145158</code></pre>
<p>Define our mcmc procedure in Nimble</p>
<pre class="sourceCode r"><code class="sourceCode r">Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>)
Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Rmodel)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
Cmcmc$<span class="kw">run</span>(<span class="fl">1e5</span>)
)</code></pre>
<pre><code>   user  system elapsed 
  1.140   0.028   1.172 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
df &lt;-<span class="st"> </span><span class="kw">gather</span>(samples)</code></pre>
<h4 id="posteriors">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-04-GP-nimble-explore/unnamed-chunk-13-1.png" />
</figure>
<p>Note that <code>simulate</code> continues to draw from the prior, not the posterior:</p>
<pre class="sourceCode r"><code class="sourceCode r">sigmas &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="fl">1e4</span>, {
  <span class="kw">simulate</span>(Rmodel, <span class="st">&quot;sigma.n&quot;</span>)
  Rmodel$sigma.n
  })
<span class="kw">hist</span>(sigmas)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-04-GP-nimble-explore/unnamed-chunk-14-1.png" />
</figure>
<p>(Also note this isn’t a particularly efficient way to simulate). Conveniently drawing data, <span class="math">\(y\)</span>, from the posterior is even less obvious.</p>
<h2 id="comparison">Comparison</h2>
<pre class="sourceCode r"><code class="sourceCode r"> lpriors &lt;-<span class="st"> </span>function(pars){
      <span class="kw">dgamma</span>(pars[[<span class="dv">1</span>]], <span class="dv">10</span>, <span class="dv">1</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>) +
<span class="st">      </span><span class="kw">dunif</span>(pars[[<span class="dv">2</span>]], <span class="dv">0</span>, <span class="fl">1e5</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>) 
  }
  
  posterior &lt;-<span class="st"> </span>function(pars, x, y){ 
    l &lt;-<span class="st"> </span>pars[<span class="dv">1</span>]
    sigma.n &lt;-<span class="st"> </span>pars[<span class="dv">2</span>]

    SE &lt;-<span class="st"> </span>function(Xi,Xj, l) <span class="kw">exp</span>(-<span class="fl">0.5</span> *<span class="st"> </span>(Xi -<span class="st"> </span>Xj) ^<span class="st"> </span><span class="dv">2</span> /<span class="st"> </span>l ^<span class="st"> </span><span class="dv">2</span>)
    cov &lt;-<span class="st"> </span>function(X, Y) <span class="kw">outer</span>(X, Y, SE, l)
    I &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>, <span class="kw">length</span>(x))
    K &lt;-<span class="st"> </span><span class="kw">cov</span>(x, x) 
  
    loglik &lt;-<span class="st"> </span>-<span class="st"> </span><span class="fl">0.5</span> *<span class="st"> </span><span class="kw">t</span>(y) %*%<span class="st"> </span><span class="kw">solve</span>(K +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I) %*%<span class="st"> </span>y -
<span class="st">      </span><span class="kw">log</span>(<span class="kw">det</span>(K +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I)) -
<span class="st">      </span><span class="kw">length</span>(y) *<span class="st"> </span><span class="kw">log</span>(<span class="dv">2</span> *<span class="st"> </span>pi) /<span class="st"> </span><span class="dv">2</span>
    
    loglik +<span class="st"> </span><span class="kw">lpriors</span>(pars)
  }</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
out &lt;-<span class="st"> </span><span class="kw">metrop</span>(posterior, <span class="dt">initial =</span> <span class="kw">c</span>(<span class="dt">l =</span> <span class="dv">1</span>,<span class="dt">sigma.n =</span> <span class="dv">10</span>), <span class="dt">nbatch =</span> <span class="fl">1e5</span>, <span class="dt">x =</span> obs$x, <span class="dt">y =</span> obs$y)  
)</code></pre>
<pre><code>   user  system elapsed 
 16.314   0.004  16.387 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">burnin &lt;-<span class="st"> </span><span class="fl">1e3</span>
thin &lt;-<span class="st"> </span><span class="fl">1e2</span>
df &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">index=</span><span class="dv">1</span>:out$nbatch, <span class="kw">as.data.frame</span>(<span class="kw">exp</span>(out$batch)))
s &lt;-<span class="st"> </span><span class="kw">seq</span>(burnin<span class="dv">+1</span>, out$nbatch, <span class="dt">by=</span>thin)
df &lt;-<span class="st"> </span>df[s,]
df &lt;-<span class="st"> </span>df[-<span class="dv">1</span>] <span class="co"># drop index</span>
<span class="kw">names</span>(df) &lt;-<span class="st"> </span><span class="kw">names</span>(out$initial)
df &lt;-<span class="st"> </span><span class="kw">gather</span>(df)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>) +
<span class="st">  </span><span class="kw">scale_x_log10</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-04-GP-nimble-explore/unnamed-chunk-18-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/04/GP-nimble-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/03/GP-nimble-setup.html">Gp Nimble Setup</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 03 Mar 2015</p>

<article>
<div class="excerpt">
<h2 id="dmnorm-example">dmnorm example</h2>
<p>from Daniel, who notes we need to be explicit about vector/matrix sizes on both LHS and RHS,</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
    mu ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="dv">100</span>, <span class="dv">100</span>)
    sigma ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="dv">100</span>)
    rho ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">20</span>, <span class="dv">100</span>)
    muVec[<span class="dv">1</span>:N] &lt;-<span class="st"> </span>mu *<span class="st"> </span>onesVector[<span class="dv">1</span>:N]
    Cov[<span class="dv">1</span>:N, <span class="dv">1</span>:N] &lt;-<span class="st"> </span>sigma^<span class="dv">2</span> *<span class="st"> </span><span class="kw">exp</span>(-dist[<span class="dv">1</span>:N, <span class="dv">1</span>:N]/rho)
    g[<span class="dv">1</span>:N] ~<span class="st"> </span><span class="kw">dmnorm</span>(muVec[<span class="dv">1</span>:N], <span class="dt">cov =</span> Cov[<span class="dv">1</span>:N, <span class="dv">1</span>:N])
    for (i in <span class="dv">1</span>:N) {
        y[i] ~<span class="st"> </span><span class="kw">dpois</span>(<span class="kw">exp</span>(g[i]))
    }
})
constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="dv">148</span>, 
                  <span class="dt">onesVector =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">148</span>), 
                  <span class="dt">dist =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="dt">nrow=</span><span class="dv">148</span>, <span class="dt">ncol=</span><span class="dv">148</span>))
y =<span class="st"> </span><span class="kw">rpois</span>(<span class="dv">148</span>, <span class="dv">1</span>) <span class="co"># vector of 148 observations (counts)</span>
data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">y=</span>y)

inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">mu =</span> <span class="dv">0</span>, 
              <span class="dt">sigma =</span> <span class="dv">5</span>, 
              <span class="dt">rho =</span> <span class="dv">60</span>, 
              <span class="dt">g =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">148</span>))
m &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)</code></pre>
<h2 id="gp-model-original-specification">GP Model, original specification</h2>
<p>This model definition doesn’t work, since we do not define sizes explicitly</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   l ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>,<span class="fl">1e4</span>)
   sigma.n ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e4</span>) 
   Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N] &lt;-<span class="st"> </span><span class="kw">exp</span>(-<span class="fl">0.5</span> *<span class="st"> </span>diff /<span class="st"> </span>l ^<span class="st"> </span><span class="dv">2</span>) +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I
   y[<span class="dv">1</span>:N] ~<span class="st"> </span><span class="kw">dmnorm</span>(Mu, <span class="dt">cov =</span> Sigma)  
})
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="dv">4</span>, -<span class="dv">3</span>, -<span class="dv">1</span>,  <span class="dv">0</span>,  <span class="dv">2</span>),
                   <span class="dt">y =</span> <span class="kw">c</span>(-<span class="dv">2</span>,  <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>, -<span class="dv">1</span>))

N &lt;-<span class="st"> </span><span class="kw">length</span>(obs$x)
diff &lt;-<span class="st"> </span><span class="kw">outer</span>(obs$x, obs$x, function(xi, xj) (xi-xj)^<span class="dv">2</span>)
constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">x =</span> obs$x, <span class="dt">Mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="dt">diff =</span> diff, <span class="dt">I =</span> <span class="kw">diag</span>(<span class="dv">1</span>,N))
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">l =</span> <span class="dv">1</span>, <span class="dt">sigma.n =</span> <span class="dv">10</span>)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> obs$y)
m &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)</code></pre>
<pre><code>Error in x$parentNodeExprs[[iV]][[iDim + 2]]: object of type &#39;symbol&#39; is not subsettable</code></pre>
<h2 id="gp-model-v2">GP Model, v2</h2>
<p>This model definition still doesn’t work, even though it appears to be more explicit</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({

   l ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>,<span class="dv">100</span>)
   sigma.n ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>,<span class="dv">100</span>)
   SE &lt;-<span class="st"> </span>function(xi,xj, l) <span class="kw">exp</span>(-<span class="fl">0.5</span> *<span class="st"> </span>(xi -<span class="st"> </span>xj) ^<span class="st"> </span><span class="dv">2</span> /<span class="st"> </span>l ^<span class="st"> </span><span class="dv">2</span>)
   Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N] &lt;-<span class="st"> </span><span class="kw">outer</span>(x[<span class="dv">1</span>:N], x[<span class="dv">1</span>:N], SE, l) +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I[<span class="dv">1</span>:N, <span class="dv">1</span>:N]
   y[<span class="dv">1</span>:N] ~<span class="st"> </span><span class="kw">dmnorm</span>(Mu[<span class="dv">1</span>:N], <span class="dt">cov =</span> Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N])  

})
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="dv">4</span>, -<span class="dv">3</span>, -<span class="dv">1</span>,  <span class="dv">0</span>,  <span class="dv">2</span>),
                   <span class="dt">y =</span> <span class="kw">c</span>(-<span class="dv">2</span>,  <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>, -<span class="dv">1</span>))
N &lt;-<span class="st"> </span><span class="kw">length</span>(obs$x)
constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">x =</span> obs$x, <span class="dt">Mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="dt">I =</span> <span class="kw">diag</span>(<span class="dv">1</span>,N))
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">l =</span> <span class="dv">1</span>, <span class="dt">sigma.n =</span> <span class="dv">10</span>)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> obs$y)
<span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)</code></pre>
<pre><code>Error in replaceConstantsRecurse(x, constEnv, constNames): Error, hit end</code></pre>
<h2 id="gp-model">GP Model</h2>
<p>A successful specification looks like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">code &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({

   l ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>,<span class="fl">1e5</span>) <span class="co"># dgamma(5, 5)</span>
   sigma.n ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>) <span class="co"># dgamma(5, 5) </span>
   Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N] &lt;-<span class="st"> </span><span class="kw">exp</span>(-<span class="fl">0.5</span> *<span class="st"> </span>diff[<span class="dv">1</span>:N, <span class="dv">1</span>:N] /<span class="st"> </span>l ^<span class="st"> </span><span class="dv">2</span>) +<span class="st"> </span>sigma.n ^<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>I[<span class="dv">1</span>:N, <span class="dv">1</span>:N]
   y[<span class="dv">1</span>:N] ~<span class="st"> </span><span class="kw">dmnorm</span>(Mu[<span class="dv">1</span>:N], <span class="dt">cov =</span> Sigma[<span class="dv">1</span>:N, <span class="dv">1</span>:N])  

})</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(-<span class="dv">4</span>, -<span class="dv">3</span>, -<span class="dv">1</span>,  <span class="dv">0</span>,  <span class="dv">2</span>),
                   <span class="dt">y =</span> <span class="kw">c</span>(-<span class="dv">2</span>,  <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>, -<span class="dv">1</span>))

N &lt;-<span class="st"> </span><span class="kw">length</span>(obs$x)
diff &lt;-<span class="st"> </span><span class="kw">outer</span>(obs$x, obs$x, function(xi, xj) (xi-xj)^<span class="dv">2</span>)
constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">x =</span> obs$x, <span class="dt">Mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="dt">diff =</span> diff, <span class="dt">I =</span> <span class="kw">diag</span>(<span class="dv">1</span>,N))
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">l =</span> <span class="dv">1</span>, <span class="dt">sigma.n =</span> <span class="dv">10</span>)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> obs$y)
m &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)</code></pre>
<p>Define our mcmc procedure in Nimble</p>
<pre class="sourceCode r"><code class="sourceCode r">my_mcmc &lt;-<span class="st"> </span>function(code, constants, data, inits, <span class="dt">n_iter=</span><span class="fl">1e5</span>, <span class="dt">thin =</span> <span class="fl">1e2</span>){  
  Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)
  Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
  mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>,<span class="dt">thin=</span>thin)
  Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
  Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Cmodel)
  Cmcmc$<span class="kw">run</span>(n_iter)
  samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
  <span class="co">#samples &lt;- samples[,1:(length(inits)-1)]</span>
  <span class="kw">gather</span>(samples)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits, <span class="dt">n =</span> <span class="fl">1e6</span>)</code></pre>
<h4 id="summary-statistics">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

      key         mean          std
1       l 49870.926633 28732.960042
2 sigma.n     2.179598     1.250408</code></pre>
<h4 id="traces">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">sample_n</span>(df,<span class="dv">500</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-03-GP-nimble-setup/unnamed-chunk-10-1.png" />
</figure>
<h4 id="posteriors">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-03-GP-nimble-setup/unnamed-chunk-11-1.png" />
</figure>
<h2 id="time-series-example">Time-series example</h2>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function (x, p){ x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x /<span class="st"> </span>p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>]) /<span class="st"> </span>p[<span class="dv">2</span>]) }
p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">5</span>)
z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.05</span>)
T &lt;-<span class="st"> </span><span class="dv">40</span>

<span class="kw">set.seed</span>(<span class="dv">1234</span>)
x &lt;-<span class="st"> </span><span class="kw">numeric</span>(T)
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">5.5</span>

for(t in <span class="dv">1</span>:(T<span class="dv">-1</span>))
  x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">p=</span>p)

<span class="kw">qplot</span>(<span class="kw">seq_along</span>(x), x)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span>x)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-03-GP-nimble-setup/unnamed-chunk-12-1.png" />
</figure>
<h4 id="model-setup">model setup</h4>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span>x[<span class="dv">1</span>:(T<span class="dv">-1</span>)], <span class="dt">y =</span> x[<span class="dv">2</span>:T])
N &lt;-<span class="st"> </span><span class="kw">length</span>(obs$x)
diff &lt;-<span class="st"> </span><span class="kw">outer</span>(obs$x, obs$x, function(xi, xj) (xi-xj)^<span class="dv">2</span>)
constants =<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">x =</span> obs$x, <span class="dt">Mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="dt">diff =</span> diff, <span class="dt">I =</span> <span class="kw">diag</span>(<span class="dv">1</span>,N))
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">l =</span> <span class="dv">1</span>, <span class="dt">sigma.n =</span> <span class="dv">10</span>)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> obs$y)</code></pre>
<h4 id="estimate-gp-bm-mcmc-with-nimble">Estimate GP bm MCMC with Nimble</h4>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits, <span class="dt">n =</span> <span class="fl">1e6</span>)</code></pre>
<h4 id="summary-statistics-1">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

      key      mean        std
1       l 3.8059775 0.60843921
2 sigma.n 0.3641306 0.04565619</code></pre>
<h4 id="traces-1">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">sample_n</span>(df,<span class="dv">500</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-03-GP-nimble-setup/unnamed-chunk-16-1.png" />
</figure>
<h4 id="posteriors-1">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-03-03-GP-nimble-setup/unnamed-chunk-17-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/03/GP-nimble-setup.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/03/02/notes.html">Notes</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 02 Mar 2015</p>

<article>
<div class="excerpt">
<h2 id="misc-tricks">Misc tricks</h2>
<ul>
<li>docker X11 sharing</li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> run  -ti --rm -e DISPLAY=<span class="ot">$DISPLAY</span> -v /tmp/.X11-unix:/tmp/.X11-unix:ro r-base</code></pre>
<ul>
<li><code>devtools::install_version</code></li>
<li><p><code>devtools::use_readme_rmd</code> (with git commit hooks)</p></li>
<li><p>How to specify a custom action for the knit button: add <code>knit: (function(inputFile, encoding) ...)</code> to the top-level YAML header; e.g. to control output directory:</p></li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">rmarkdown::<span class="kw">render</span>(inputFile, 
                  <span class="dt">encoding =</span> encoding, 
                  <span class="dt">output_file =</span> <span class="kw">paste0</span>(<span class="kw">dirname</span>(inputFile),
                                       <span class="kw">basename</span>(inputFile), 
                                       <span class="st">&quot;.pdf&quot;</span>))</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/03/02/notes.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/02/25/nimble-on-dai-model.html">Nimble On Dai Model</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 25 Feb 2015</p>

<article>
<div class="excerpt">
<h2 id="testing-nimble-method-on-dai-model">Testing nimble method on Dai model</h2>
<p>(shorter data series)</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;cboettig/regimeshifts&quot;</span>)</code></pre>
<p>Define our mcmc procedure in Nimble</p>
<pre class="sourceCode r"><code class="sourceCode r">my_mcmc &lt;-<span class="st"> </span>function(code, constants, data, inits, <span class="dt">n_iter=</span><span class="fl">1e5</span>, <span class="dt">thin =</span> <span class="fl">1e2</span>){
  Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)
  Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
  mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>,<span class="dt">thin=</span>thin)
  Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
  Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Cmodel)
  Cmcmc$<span class="kw">run</span>(n_iter)
  samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
  samples &lt;-<span class="st"> </span>samples[,<span class="dv">1</span>:(<span class="kw">length</span>(inits)-<span class="dv">1</span>)]
  <span class="kw">gather</span>(samples)
}</code></pre>
<p>Generate the test data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1000</span>)
max_days &lt;-<span class="st"> </span><span class="dv">50</span>
DF &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">2000</span>, <span class="dt">length=</span>max_days) <span class="co"># schedule for env degredation (increased dilution)</span>
x &lt;-<span class="st"> </span><span class="kw">numeric</span>(max_days)   
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">1.76e5</span> <span class="co"># initial density</span>
   
for(day in <span class="dv">1</span>:(max_days<span class="dv">-1</span>)){
 x[day<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">dai</span>(x[day], <span class="dt">DF =</span> DF[day])
}

raw &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">t =</span> <span class="dv">1</span>:max_days, <span class="dt">x =</span> x)</code></pre>
<p>Detrend:</p>
<pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="kw">length</span>(raw$x)
raw$t &lt;-<span class="st"> </span><span class="dv">1</span>:N
detrend &lt;-<span class="st"> </span><span class="kw">loess</span>(x ~<span class="st"> </span>t, raw)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> detrend$residuals/<span class="kw">sqrt</span>(<span class="kw">var</span>(detrend$residuals)))
<span class="kw">qplot</span>(raw$t, data$x, <span class="dt">geom=</span><span class="st">&#39;line&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/detrend-1.png" />
</figure>
<h2 id="ou-model">OU Model</h2>
<pre class="sourceCode r"><code class="sourceCode r">ou &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">100.0</span>)
       r ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">20.0</span>)
   sigma ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="dv">100</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="dv">100</span>)

  for(t in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu[t] &lt;-<span class="st"> </span>x[t] +<span class="st"> </span>r *<span class="st"> </span>(theta -<span class="st"> </span>x[t]) 
    x[t<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu[t], <span class="dt">sd =</span> sigma) 
  }
})

ou_constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N)
ou_inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">r =</span> <span class="fl">1e-3</span>, <span class="dt">sigma =</span> <span class="dv">1</span>)</code></pre>
<p>Run the mcmc</p>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>ou, ou_constants, data, ou_inits)</code></pre>
<h4 id="summary-statistics">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

    key      mean       std
1     r 0.7866844 0.1600235
2 sigma 1.0375633 0.1113334</code></pre>
<h4 id="traces">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-8-1.png" />
</figure>
<h4 id="posteriors">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-9-1.png" />
</figure>
<h2 id="lsn-version">LSN version</h2>
<p>A modified version of the LSN model to explicitly model the changing parameter as a hidden variable changing at constant rate</p>
<pre class="sourceCode r"><code class="sourceCode r">lsn &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
 sigma_x ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
       m ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)
    y[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>) 

  for(i in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu_x[i] &lt;-<span class="st"> </span>x[i] +<span class="st"> </span>y[i] *<span class="st"> </span>(theta -<span class="st"> </span>x[i]) 
    x[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_x[i], <span class="dt">sd =</span> sigma_x) 
    y[i<span class="dv">+1</span>] &lt;-<span class="st"> </span>y[i] +<span class="st"> </span>m *<span class="st"> </span>t[i] /<span class="st"> </span>t[N] 
    
  }
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>lsn, constants, data, inits)</code></pre>
<h4 id="summary-statistics-1">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [3 x 3]

      key        mean        std
1       m -0.02060616 0.02779506
2 sigma_x  1.03148569 0.11158787
3   theta -0.03136262 0.18565435</code></pre>
<h4 id="traces-1">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-13-1.png" />
</figure>
<h4 id="posteriors-1">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-14-1.png" />
</figure>
<h2 id="lsn-stochastic-hidden-variable">LSN, stochastic hidden variable</h2>
<h4 id="define-and-model-and-run-mcmc">Define and model and run MCMC</h4>
<pre class="sourceCode r"><code class="sourceCode r">lsn &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
   sigma_x ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
   sigma_y ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
       m ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)
    y[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)

  for(i in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu_x[i] &lt;-<span class="st"> </span>x[i] +<span class="st"> </span>y[i] *<span class="st"> </span>(theta -<span class="st"> </span>x[i])
    x[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_x[i], <span class="dt">sd =</span> sigma_x)
    mu_y[i] &lt;-<span class="st"> </span>y[i] +<span class="st"> </span>m *<span class="st"> </span>t[i] /<span class="st"> </span>t[N]
    y[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_y[i], <span class="dt">sd =</span> sigma_y) 
  }
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_x =</span> <span class="dv">1</span>, <span class="dt">sigma_y =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>lsn, constants, data, inits)</code></pre>
<h4 id="summary-statistics-2">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [4 x 3]

      key         mean        std
1       m -0.008170135 0.06970863
2 sigma_x  1.023650010 0.11068862
3 sigma_y  0.171747380 0.14767809
4   theta -0.025881301 0.18058435</code></pre>
<h4 id="traces-2">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-18-1.png" />
</figure>
<h4 id="posteriors-2">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-25-nimble-on-dai-model/unnamed-chunk-19-1.png" />
</figure>
<hr />
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre>
<pre><code>R version 3.1.3 (2015-03-09)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Debian GNU/Linux 8 (jessie)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] methods   stats     graphics  grDevices utils     datasets 
[7] base     

other attached packages:
[1] dplyr_0.4.1             ggplot2_1.0.1          
[3] tidyr_0.2.0             regimeshifts_0.0.0.9000
[5] nimble_0.3-1            yaml_2.1.13            
[7] knitr_1.9              

loaded via a namespace (and not attached):
 [1] assertthat_0.1   bitops_1.0-6     codetools_0.2-11
 [4] colorspace_1.2-6 DBI_0.3.1        devtools_1.7.0  
 [7] digest_0.6.8     evaluate_0.5.5   formatR_1.0     
[10] grid_3.1.3       gtable_0.1.2     httr_0.6.1      
[13] igraph_0.7.1     labeling_0.3     lazyeval_0.1.10 
[16] magrittr_1.5     MASS_7.3-40      munsell_0.4.2   
[19] parallel_3.1.3   plyr_1.8.1       proto_0.3-10    
[22] Rcpp_0.11.5      RCurl_1.95-4.5   reshape2_1.4.1  
[25] scales_0.2.4     stringr_0.6.2    tools_3.1.3     </code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/02/25/nimble-on-dai-model.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/02/24/nimble-on-dai-model.html">Nimble On Dai Model</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 24 Feb 2015</p>

<article>
<div class="excerpt">
<h2 id="testing-nimble-method-on-dai-model">Testing nimble method on Dai model</h2>
<p>(long data series)</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;cboettig/regimeshifts&quot;</span>)</code></pre>
<p>Define our mcmc procedure in Nimble</p>
<pre class="sourceCode r"><code class="sourceCode r">my_mcmc &lt;-<span class="st"> </span>function(code, constants, data, inits, <span class="dt">n_iter=</span><span class="fl">1e5</span>, <span class="dt">thin =</span> <span class="fl">1e2</span>){
  Rmodel &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> code, <span class="dt">constants =</span> constants, <span class="dt">data =</span> data, <span class="dt">inits =</span> inits)
  Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmodel)
  mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(Rmodel, <span class="dt">print=</span><span class="ot">FALSE</span>,<span class="dt">thin=</span>thin)
  Rmcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
  Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(Rmcmc, <span class="dt">project =</span> Cmodel)
  Cmcmc$<span class="kw">run</span>(n_iter)
  samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
  samples &lt;-<span class="st"> </span>samples[,<span class="dv">1</span>:(<span class="kw">length</span>(inits)-<span class="dv">1</span>)]
  <span class="kw">gather</span>(samples)
}</code></pre>
<p>Generate the test data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1000</span>)
max_days &lt;-<span class="st"> </span><span class="dv">500</span>
DF &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">2000</span>, <span class="dt">length=</span>max_days) <span class="co"># schedule for env degredation (increased dilution)</span>
x &lt;-<span class="st"> </span><span class="kw">numeric</span>(max_days)   
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="fl">1.76e5</span> <span class="co"># initial density</span>
   
for(day in <span class="dv">1</span>:(max_days<span class="dv">-1</span>)){
 x[day<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">dai</span>(x[day], <span class="dt">DF =</span> DF[day])
}

raw &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">t =</span> <span class="dv">1</span>:max_days, <span class="dt">x =</span> x)</code></pre>
<p>Detrend:</p>
<pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="kw">length</span>(raw$x)
raw$t &lt;-<span class="st"> </span><span class="dv">1</span>:N
detrend &lt;-<span class="st"> </span><span class="kw">loess</span>(x ~<span class="st"> </span>t, raw)
data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> detrend$residuals/<span class="kw">sqrt</span>(<span class="kw">var</span>(detrend$residuals)))
<span class="kw">qplot</span>(raw$t, data$x, <span class="dt">geom=</span><span class="st">&#39;line&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/detrend-1.png" />
</figure>
<h2 id="ou-model">OU Model</h2>
<pre class="sourceCode r"><code class="sourceCode r">ou &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">100.0</span>)
       r ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">20.0</span>)
   sigma ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="dv">100</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="dv">100</span>)

  for(t in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu[t] &lt;-<span class="st"> </span>x[t] +<span class="st"> </span>r *<span class="st"> </span>(theta -<span class="st"> </span>x[t]) 
    x[t<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu[t], <span class="dt">sd =</span> sigma) 
  }
})

ou_constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N)
ou_inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">r =</span> <span class="fl">1e-3</span>, <span class="dt">sigma =</span> <span class="dv">1</span>)</code></pre>
<p>Run the mcmc</p>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>ou, ou_constants, data, ou_inits)</code></pre>
<h4 id="summary-statistics">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [2 x 3]

    key      mean        std
1     r 0.2075146 0.02739447
2 sigma 0.6156283 0.01975407</code></pre>
<h4 id="traces">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-8-1.png" />
</figure>
<h4 id="posteriors">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-9-1.png" />
</figure>
<h2 id="lsn-version">LSN version</h2>
<p>A modified version of the LSN model to explicitly model the changing parameter as a hidden variable changing at constant rate</p>
<pre class="sourceCode r"><code class="sourceCode r">lsn &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
 sigma_x ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
       m ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)
    y[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>) 

  for(i in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu_x[i] &lt;-<span class="st"> </span>x[i] +<span class="st"> </span>y[i] *<span class="st"> </span>(theta -<span class="st"> </span>x[i]) 
    x[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_x[i], <span class="dt">sd =</span> sigma_x) 
    y[i<span class="dv">+1</span>] &lt;-<span class="st"> </span>y[i] +<span class="st"> </span>m *<span class="st"> </span>t[i] /<span class="st"> </span>t[N] 
    
  }
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>lsn, constants, data, inits)</code></pre>
<h4 id="summary-statistics-1">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [3 x 3]

      key         mean          std
1       m -0.003984249 0.0005859252
2 sigma_x  0.575993873 0.0185972953
3   theta -0.010341240 0.0410488393</code></pre>
<h4 id="traces-1">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-13-1.png" />
</figure>
<h4 id="posteriors-1">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-14-1.png" />
</figure>
<h2 id="lsn-stochastic-hidden-variable">LSN, stochastic hidden variable</h2>
<h4 id="define-and-model-and-run-mcmc">Define and model and run MCMC</h4>
<pre class="sourceCode r"><code class="sourceCode r">lsn &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
   theta ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
   sigma_x ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
   sigma_y ~<span class="st"> </span><span class="kw">dunif</span>(<span class="fl">1e-10</span>, <span class="fl">1e2</span>)
       m ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e2</span>, <span class="fl">1e2</span>)
    x[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)
    y[<span class="dv">1</span>] ~<span class="st"> </span><span class="kw">dunif</span>(-<span class="fl">1e3</span>, <span class="fl">1e3</span>)

  for(i in <span class="dv">1</span>:(N<span class="dv">-1</span>)){
    mu_x[i] &lt;-<span class="st"> </span>x[i] +<span class="st"> </span>y[i] *<span class="st"> </span>(theta -<span class="st"> </span>x[i])
    x[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_x[i], <span class="dt">sd =</span> sigma_x)
    mu_y[i] &lt;-<span class="st"> </span>y[i] +<span class="st"> </span>m *<span class="st"> </span>t[i] /<span class="st"> </span>t[N]
    y[i<span class="dv">+1</span>] ~<span class="st"> </span><span class="kw">dnorm</span>(mu_y[i], <span class="dt">sd =</span> sigma_y) 
  }
})

constants &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> N, <span class="dt">t =</span> raw$t)
inits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">theta =</span> <span class="dv">0</span>, <span class="dt">m =</span> <span class="dv">0</span>, <span class="dt">sigma_x =</span> <span class="dv">1</span>, <span class="dt">sigma_y =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="kw">rep</span>(<span class="dv">1</span>,N))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">my_mcmc</span>(<span class="dt">code=</span>lsn, constants, data, inits)</code></pre>
<h4 id="summary-statistics-2">Summary statistics</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(df, key), <span class="dt">mean=</span><span class="kw">mean</span>(value), <span class="dt">std=</span><span class="kw">sqrt</span>(<span class="kw">var</span>(value)))</code></pre>
<pre><code>Source: local data frame [4 x 3]

      key         mean         std
1       m -0.003001092 0.004531153
2 sigma_x  0.563929151 0.020224310
3 sigma_y  0.048817421 0.036018516
4   theta  0.010243795 0.045674221</code></pre>
<h4 id="traces-2">Traces</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="kw">seq_along</span>(value), value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-18-1.png" />
</figure>
<h4 id="posteriors-2">Posteriors</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-02-24-nimble-on-dai-model/unnamed-chunk-19-1.png" />
</figure>
<hr />
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre>
<pre><code>R version 3.1.3 (2015-03-09)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Debian GNU/Linux 8 (jessie)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] methods   stats     graphics  grDevices utils     datasets 
[7] base     

other attached packages:
[1] dplyr_0.4.1             ggplot2_1.0.1          
[3] tidyr_0.2.0             regimeshifts_0.0.0.9000
[5] nimble_0.3-1            yaml_2.1.13            
[7] knitr_1.9              

loaded via a namespace (and not attached):
 [1] assertthat_0.1   bitops_1.0-6     codetools_0.2-11
 [4] colorspace_1.2-6 DBI_0.3.1        devtools_1.7.0  
 [7] digest_0.6.8     evaluate_0.5.5   formatR_1.0     
[10] grid_3.1.3       gtable_0.1.2     httr_0.6.1      
[13] igraph_0.7.1     labeling_0.3     lazyeval_0.1.10 
[16] magrittr_1.5     MASS_7.3-40      munsell_0.4.2   
[19] parallel_3.1.3   plyr_1.8.1       proto_0.3-10    
[22] Rcpp_0.11.5      RCurl_1.95-4.5   reshape2_1.4.1  
[25] scales_0.2.4     stringr_0.6.2    tools_3.1.3     </code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/02/24/nimble-on-dai-model.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

  </div>
</div> <!--end row -->

<div class="row socialicons">
  <div class="col-md-11 col-md-offset-1">
		<p> <a href="/2015/index.html"><i class="icon-calendar"></i> All entries by date</a></p> 
      <p> <a href="/2015/categories.html"><i class="icon-list"></i> All entries by category</a> </p>
      <p> <a href="/2015/tags.html"><i class="icon-tags"></i> All entries by tag</a> </p>
  </div> <!--end col-md-9 -->
</div> <!--end row -->




      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="http://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="http://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Lab Notebook
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=http://www.carlboettiger.info/lab-notebook.html">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
